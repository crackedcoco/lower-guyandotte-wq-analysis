<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lower Guyandotte Watershed — A 55-Year Water Quality Story</title>
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
    <!-- Chart.js for interactive histograms -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    <!-- jsPDF and html2canvas for PDF export -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Newsreader:ital,opsz,wght@0,6..72,400;0,6..72,500;0,6..72,600;1,6..72,400&family=Inter:wght@300;400;500;600&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
    <style>
        :root {
            --deep: #0c1821;
            --dark: #1b2838;
            --mid: #2a4158;
            --surface: #3d5a73;
            --accent: #4ecdc4;
            --accent-dim: #3db5ad;
            --accent-glow: #6ee7df;
            --warm: #f7fff7;
            --warm-dim: #c9d6c9;
            --gold: #ffe66d;
            --amber: #f4a261;
            --coral: #e76f51;
            --slate: #8b9eb0;
            --text: #e8f1f5;
            --text-dim: #a3b8c7;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        html {
            /* Note: scroll-behavior: smooth can cause issues in some browsers
               Smooth scrolling is handled via JavaScript for anchor links instead */
        }

        body {
            font-family: 'Inter', -apple-system, sans-serif;
            background: var(--deep);
            color: var(--text);
            line-height: 1.7;
            overflow-x: hidden;
        }

        /* Typography */
        .serif {
            font-family: 'Newsreader', Georgia, serif;
        }

        .mono {
            font-family: 'JetBrains Mono', monospace;
        }

        /* Navigation */
        nav {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            z-index: 100;
            padding: 1rem 2rem;
            background: linear-gradient(180deg, rgba(12, 24, 33, 0.95) 0%, rgba(12, 24, 33, 0) 100%);
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: all 0.3s ease;
        }

        nav.scrolled {
            background: rgba(12, 24, 33, 0.98);
            backdrop-filter: blur(10px);
            box-shadow: 0 2px 20px rgba(0,0,0,0.3);
        }

        .nav-logo {
            font-family: 'Newsreader', serif;
            font-size: 1.1rem;
            color: var(--accent);
            text-decoration: none;
        }

        .nav-links {
            display: flex;
            gap: 2rem;
            list-style: none;
        }

        .nav-links a {
            font-size: 0.8rem;
            color: var(--text-dim);
            text-decoration: none;
            text-transform: uppercase;
            letter-spacing: 0.1em;
            transition: color 0.2s;
        }

        .nav-links a:hover {
            color: var(--accent);
        }

        @media (max-width: 768px) {
            .nav-links { display: none; }
        }

        /* Hero Section */
        .hero {
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            text-align: center;
            padding: 4rem 2rem;
            position: relative;
            overflow: hidden;
        }

        .hero::before {
            content: '';
            position: absolute;
            inset: 0;
            background:
                linear-gradient(180deg, rgba(12, 24, 33, 0.4) 0%, rgba(12, 24, 33, 0.7) 50%, var(--deep) 100%),
                url('images/river_bridge.jpg') center/cover no-repeat;
            z-index: -1;
        }

        /* Partnership Banner */
        .hero-partnership {
            display: flex;
            align-items: center;
            gap: 1rem;
            margin-bottom: 2rem;
            padding: 0.75rem 1.5rem;
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(78, 205, 196, 0.2);
            border-radius: 50px;
            opacity: 0;
            animation: fadeUp 0.8s ease 0.1s forwards;
        }

        .partner-link {
            display: flex;
            align-items: center;
        }

        .hero-partner-logo {
            height: 32px;
            width: auto;
            filter: brightness(1.1);
            transition: filter 0.2s ease;
        }

        .hero-partner-logo:hover {
            filter: brightness(1.3);
        }

        .partner-text-fallback {
            font-family: 'Newsreader', serif;
            font-size: 1rem;
            color: var(--warm);
        }

        .hero-partner-tagline {
            font-size: 0.75rem;
            color: var(--text-dim);
            font-style: italic;
        }

        @media (max-width: 600px) {
            .hero-partnership {
                flex-direction: column;
                gap: 0.5rem;
                text-align: center;
            }
        }

        .hero-eyebrow {
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 0.3em;
            color: var(--accent);
            margin-bottom: 1.5rem;
            opacity: 0;
            animation: fadeUp 0.8s ease 0.2s forwards;
        }

        .hero-title {
            font-family: 'Newsreader', serif;
            font-size: clamp(2.5rem, 8vw, 5.5rem);
            font-weight: 400;
            line-height: 1.1;
            max-width: 900px;
            margin-bottom: 1.5rem;
            opacity: 0;
            animation: fadeUp 0.8s ease 0.4s forwards;
        }

        .hero-title em {
            font-style: italic;
            color: var(--accent);
        }

        .hero-subtitle {
            font-size: 1.15rem;
            color: var(--text-dim);
            max-width: 600px;
            margin-bottom: 3rem;
            opacity: 0;
            animation: fadeUp 0.8s ease 0.6s forwards;
        }

        .hero-stats {
            display: flex;
            gap: 3rem;
            flex-wrap: wrap;
            justify-content: center;
            opacity: 0;
            animation: fadeUp 0.8s ease 0.8s forwards;
        }

        .hero-stat {
            text-align: center;
        }

        .hero-stat-value {
            font-family: 'JetBrains Mono', monospace;
            font-size: 2rem;
            color: var(--accent);
        }

        .hero-stat-label {
            font-size: 0.75rem;
            color: var(--slate);
            text-transform: uppercase;
            letter-spacing: 0.1em;
        }

        .scroll-indicator {
            position: absolute;
            bottom: 2rem;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 0.5rem;
            color: var(--slate);
            font-size: 0.7rem;
            text-transform: uppercase;
            letter-spacing: 0.2em;
            opacity: 0;
            animation: fadeUp 0.8s ease 1.2s forwards;
        }

        .scroll-line {
            width: 1px;
            height: 40px;
            background: linear-gradient(180deg, var(--accent), transparent);
            animation: scrollPulse 2s ease-in-out infinite;
        }

        @keyframes scrollPulse {
            0%, 100% { opacity: 0.3; transform: scaleY(0.5); }
            50% { opacity: 1; transform: scaleY(1); }
        }

        /* Chapter Sections */
        .chapter {
            padding: 8rem 2rem;
            max-width: 1200px;
            margin: 0 auto;
        }

        .chapter-wide {
            max-width: 100%;
            padding: 8rem 0;
        }

        .chapter-narrow {
            max-width: 720px;
        }

        .chapter-label {
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.7rem;
            text-transform: uppercase;
            letter-spacing: 0.2em;
            color: var(--accent);
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .chapter-label::before {
            content: '';
            width: 30px;
            height: 1px;
            background: var(--accent);
        }

        .chapter-title {
            font-family: 'Newsreader', serif;
            font-size: clamp(2rem, 5vw, 3.5rem);
            font-weight: 400;
            line-height: 1.2;
            margin-bottom: 2rem;
        }

        .chapter-lead {
            font-size: 1.25rem;
            color: var(--text-dim);
            line-height: 1.8;
            margin-bottom: 3rem;
        }

        .prose {
            font-size: 1.05rem;
            color: var(--text-dim);
            line-height: 1.9;
        }

        .prose p {
            margin-bottom: 1.5rem;
        }

        .prose strong {
            color: var(--text);
            font-weight: 500;
        }

        .prose a {
            color: var(--accent);
            text-decoration: underline;
            text-underline-offset: 3px;
        }

        /* Highlight Box */
        .highlight-box {
            background: linear-gradient(135deg, rgba(78, 205, 196, 0.1) 0%, rgba(78, 205, 196, 0.05) 100%);
            border-left: 3px solid var(--accent);
            padding: 1.5rem 2rem;
            margin: 2rem 0;
            border-radius: 0 8px 8px 0;
        }

        .highlight-box p {
            margin: 0;
            font-size: 1.1rem;
            color: var(--text);
        }

        /* Big Number */
        .big-number {
            font-family: 'JetBrains Mono', monospace;
            font-size: clamp(4rem, 12vw, 8rem);
            font-weight: 500;
            line-height: 1;
            background: linear-gradient(135deg, var(--accent) 0%, var(--accent-glow) 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .big-number-label {
            font-size: 1.1rem;
            color: var(--text-dim);
            margin-top: 0.5rem;
        }

        /* Stats Grid */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1.5rem;
            margin: 3rem 0;
        }

        .stat-card {
            background: rgba(42, 65, 88, 0.3);
            border: 1px solid rgba(78, 205, 196, 0.15);
            border-radius: 8px;
            padding: 1.5rem;
            text-align: center;
            transition: all 0.3s ease;
        }

        .stat-card:hover {
            border-color: var(--accent);
            transform: translateY(-2px);
        }

        .stat-card-value {
            font-family: 'JetBrains Mono', monospace;
            font-size: 2.5rem;
            color: var(--accent);
            line-height: 1;
        }

        .stat-card-label {
            font-size: 0.85rem;
            color: var(--text-dim);
            margin-top: 0.75rem;
        }

        /* Full-Width Section */
        .full-section {
            background: var(--dark);
            padding: 6rem 2rem;
            margin: 4rem 0;
        }

        /* Court Order Streams Grid */
        .court-streams-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 1rem;
            margin: 2rem 0;
        }

        .court-stream-item {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            background: rgba(231, 111, 81, 0.1);
            border: 1px solid rgba(231, 111, 81, 0.3);
            border-radius: 8px;
            padding: 1rem 1.25rem;
            transition: all 0.2s ease;
        }

        .court-stream-item:hover {
            background: rgba(231, 111, 81, 0.15);
            border-color: var(--coral);
            transform: translateX(4px);
        }

        .court-icon {
            font-size: 1.25rem;
        }

        .court-stream-name {
            flex: 1;
            font-weight: 500;
            color: var(--warm);
        }

        .court-code {
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.7rem;
            color: var(--slate);
            background: rgba(0, 0, 0, 0.2);
            padding: 0.25rem 0.5rem;
            border-radius: 3px;
        }

        /* Overlap Analysis */
        .overlap-analysis {
            margin-top: 2.5rem;
            padding: 2rem;
            background: rgba(0, 0, 0, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px;
        }

        .overlap-analysis h4 {
            font-family: 'Newsreader', serif;
            font-size: 1.25rem;
            color: var(--warm);
            margin-bottom: 1rem;
        }

        .overlap-analysis > p {
            font-size: 0.95rem;
            color: var(--text-dim);
            line-height: 1.7;
            margin-bottom: 1.5rem;
        }

        .overlap-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1.25rem;
            margin-bottom: 1.5rem;
        }

        .overlap-stat {
            padding: 1.25rem;
            border-radius: 8px;
            text-align: center;
        }

        .overlap-stat.match {
            background: rgba(78, 205, 196, 0.1);
            border: 1px solid rgba(78, 205, 196, 0.3);
        }

        .overlap-stat.related {
            background: rgba(244, 162, 97, 0.1);
            border: 1px solid rgba(244, 162, 97, 0.3);
        }

        .overlap-stat.unique {
            background: rgba(139, 158, 176, 0.1);
            border: 1px solid rgba(139, 158, 176, 0.3);
        }

        .overlap-number {
            display: block;
            font-family: 'JetBrains Mono', monospace;
            font-size: 2.5rem;
            font-weight: 500;
            line-height: 1;
            margin-bottom: 0.5rem;
        }

        .overlap-stat.match .overlap-number { color: var(--accent); }
        .overlap-stat.related .overlap-number { color: var(--amber); }
        .overlap-stat.unique .overlap-number { color: var(--slate); }

        .overlap-label {
            display: block;
            font-size: 0.85rem;
            font-weight: 500;
            color: var(--text);
            margin-bottom: 0.4rem;
        }

        .overlap-detail {
            display: block;
            font-size: 0.75rem;
            color: var(--text-dim);
            line-height: 1.5;
        }

        .overlap-insight {
            font-size: 0.9rem;
            color: var(--slate);
            font-style: italic;
            padding-top: 1.25rem;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            margin-bottom: 0;
        }

        .full-section-inner {
            max-width: 1200px;
            margin: 0 auto;
        }

        /* Pollutant Cards */
        .pollutant-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 1.5rem;
            margin-top: 3rem;
        }

        .pollutant-card {
            background: rgba(12, 24, 33, 0.6);
            border: 1px solid rgba(255,255,255,0.08);
            border-radius: 12px;
            padding: 2rem;
            position: relative;
            overflow: hidden;
        }

        .pollutant-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 4px;
        }

        .pollutant-card.critical::before { background: var(--coral); }
        .pollutant-card.warning::before { background: var(--amber); }
        .pollutant-card.improving::before { background: var(--accent); }

        .pollutant-name {
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 0.15em;
            color: var(--slate);
            margin-bottom: 0.5rem;
        }

        .pollutant-rate {
            font-family: 'JetBrains Mono', monospace;
            font-size: 2.5rem;
            margin-bottom: 0.25rem;
        }

        .pollutant-card.critical .pollutant-rate { color: var(--coral); }
        .pollutant-card.warning .pollutant-rate { color: var(--amber); }
        .pollutant-card.improving .pollutant-rate { color: var(--accent); }

        .pollutant-context {
            font-size: 0.9rem;
            color: var(--text-dim);
            margin-bottom: 1rem;
        }

        .pollutant-bar {
            height: 6px;
            background: rgba(255,255,255,0.1);
            border-radius: 3px;
            overflow: hidden;
            margin-bottom: 0.75rem;
        }

        .pollutant-fill {
            height: 100%;
            border-radius: 3px;
            transition: width 1.5s ease-out;
        }

        .pollutant-card.critical .pollutant-fill { background: linear-gradient(90deg, var(--coral), #f4a261); }
        .pollutant-card.warning .pollutant-fill { background: linear-gradient(90deg, var(--amber), var(--gold)); }
        .pollutant-card.improving .pollutant-fill { background: linear-gradient(90deg, var(--accent-dim), var(--accent)); }

        .pollutant-standard {
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.7rem;
            color: var(--slate);
        }

        .pollutant-note {
            font-size: 0.75rem;
            color: var(--amber);
            margin-top: 0.5rem;
            font-style: italic;
        }

        .ionic-badge {
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.55rem;
            background: rgba(231, 111, 81, 0.2);
            color: var(--coral);
            padding: 0.2rem 0.4rem;
            border-radius: 2px;
            margin-left: 0.5rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            vertical-align: middle;
        }

        .conductivity-highlight {
            border: 2px solid var(--coral) !important;
            box-shadow: 0 0 20px rgba(231, 111, 81, 0.2);
        }

        .conductivity-highlight::before {
            background: var(--coral) !important;
            width: 5px !important;
        }

        /* Timeline */
        .timeline {
            position: relative;
            margin: 4rem 0;
        }

        .timeline::before {
            content: '';
            position: absolute;
            left: 20px;
            top: 0;
            bottom: 0;
            width: 2px;
            background: linear-gradient(180deg, var(--accent), var(--mid), var(--accent));
        }

        .timeline-item {
            position: relative;
            padding-left: 60px;
            padding-bottom: 3rem;
        }

        .timeline-item:last-child {
            padding-bottom: 0;
        }

        .timeline-dot {
            position: absolute;
            left: 12px;
            top: 4px;
            width: 18px;
            height: 18px;
            border-radius: 50%;
            background: var(--deep);
            border: 2px solid var(--accent);
        }

        .timeline-item.highlight .timeline-dot {
            background: var(--accent);
            box-shadow: 0 0 20px var(--accent);
        }

        .timeline-year {
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.8rem;
            color: var(--accent);
            margin-bottom: 0.25rem;
        }

        .timeline-title {
            font-family: 'Newsreader', serif;
            font-size: 1.25rem;
            color: var(--text);
            margin-bottom: 0.5rem;
        }

        .timeline-desc {
            font-size: 0.95rem;
            color: var(--text-dim);
            line-height: 1.7;
        }

        /* Trends Section */
        .trends-split {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 3rem;
            margin: 3rem 0;
        }

        @media (max-width: 768px) {
            .trends-split {
                grid-template-columns: 1fr;
            }
        }

        .trend-column {
            background: rgba(42, 65, 88, 0.2);
            border-radius: 12px;
            padding: 2rem;
        }

        .trend-column.good {
            border: 1px solid rgba(78, 205, 196, 0.3);
        }

        .trend-column.concern {
            border: 1px solid rgba(231, 111, 81, 0.3);
        }

        .trend-header {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            margin-bottom: 1.5rem;
        }

        .trend-icon {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .trend-column.good .trend-icon {
            background: rgba(78, 205, 196, 0.2);
            color: var(--accent);
        }

        .trend-column.concern .trend-icon {
            background: rgba(231, 111, 81, 0.2);
            color: var(--coral);
        }

        .trend-label {
            font-size: 0.8rem;
            text-transform: uppercase;
            letter-spacing: 0.1em;
        }

        .trend-column.good .trend-label { color: var(--accent); }
        .trend-column.concern .trend-label { color: var(--coral); }

        .trend-list {
            list-style: none;
        }

        .trend-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.75rem 0;
            border-bottom: 1px solid rgba(255,255,255,0.05);
        }

        .trend-item:last-child {
            border-bottom: none;
        }

        .trend-param {
            color: var(--text);
        }

        .trend-value {
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.95rem;
        }

        .trend-column.good .trend-value { color: var(--accent); }
        .trend-column.concern .trend-value { color: var(--coral); }

        /* Interactive HUC12 Map */
        .huc12-interactive-map {
            margin: 3rem 0;
            border-radius: 12px;
            overflow: hidden;
            border: 1px solid var(--mid);
            background: var(--dark);
        }

        .huc12-map-header {
            padding: 1rem 1.5rem;
            background: rgba(42, 65, 88, 0.4);
            border-bottom: 1px solid var(--mid);
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 1rem;
        }

        .huc12-map-title {
            font-family: 'Newsreader', serif;
            font-size: 1.1rem;
            color: var(--warm);
            margin: 0;
        }

        .huc12-map-legend {
            display: flex;
            gap: 1rem;
            flex-wrap: wrap;
            font-size: 0.75rem;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 0.4rem;
            color: var(--text-dim);
        }

        .legend-swatch {
            width: 14px;
            height: 14px;
            border-radius: 3px;
            border: 1px solid rgba(255,255,255,0.2);
        }

        #huc12InteractiveMap {
            height: 450px;
            width: 100%;
            background: var(--deep);
        }

        .map-popup-title {
            font-family: 'Newsreader', serif;
            font-size: 1.1rem;
            color: var(--accent);
            margin-bottom: 0.5rem;
            padding-bottom: 0.5rem;
            border-bottom: 1px solid var(--mid);
        }

        .map-popup-stats {
            display: grid;
            grid-template-columns: auto 1fr;
            gap: 0.3rem 0.75rem;
        }

        .map-popup-label {
            color: var(--slate);
            font-size: 0.75rem;
        }

        .map-popup-value {
            font-family: 'JetBrains Mono', monospace;
            color: var(--warm);
            font-size: 0.8rem;
        }

        .map-popup-court {
            margin-top: 0.75rem;
            padding-top: 0.75rem;
            border-top: 1px solid var(--mid);
            font-size: 0.75rem;
            color: var(--coral);
            display: flex;
            align-items: center;
            gap: 0.4rem;
        }

        @media (max-width: 768px) {
            #huc12InteractiveMap {
                height: 350px;
            }
            .huc12-map-header {
                flex-direction: column;
                align-items: flex-start;
            }
        }

        /* Hotspots */
        .hotspot-list {
            margin: 3rem 0;
        }

        .hotspot-item {
            display: grid;
            grid-template-columns: 3rem 1fr auto;
            cursor: pointer;
            gap: 1.5rem;
            align-items: center;
            padding: 1.25rem;
            background: rgba(42, 65, 88, 0.2);
            border: 1px solid rgba(255,255,255,0.05);
            border-radius: 8px;
            margin-bottom: 0.75rem;
            transition: all 0.3s ease;
        }

        .hotspot-item:hover,
        .hotspot-item.highlighted {
            background: rgba(42, 65, 88, 0.4);
            border-color: rgba(78, 205, 196, 0.3);
        }

        .hotspot-item.highlighted {
            border-color: var(--accent);
            box-shadow: 0 0 15px rgba(78, 205, 196, 0.3);
            transform: translateX(4px);
        }

        .hotspot-item {
            cursor: pointer;
        }

        .hotspot-item.expanded {
            background: rgba(42, 65, 88, 0.5);
            border-color: var(--accent);
        }

        .hotspot-rank {
            font-family: 'Newsreader', serif;
            font-size: 1.75rem;
            color: var(--accent);
            text-align: center;
        }

        .hotspot-name {
            font-weight: 500;
            color: var(--text);
            cursor: pointer;
            transition: color 0.2s;
        }

        .hotspot-name:hover {
            color: var(--accent);
        }

        .hotspot-name::after {
            content: ' ▾';
            font-size: 0.7em;
            opacity: 0.5;
            transition: transform 0.3s;
            display: inline-block;
        }

        .hotspot-item.expanded .hotspot-name::after {
            transform: rotate(180deg);
        }

        /* Parameter Detail Panel */
        .hotspot-details {
            display: none;
            grid-column: 1 / -1;
            margin-top: 1rem;
            padding-top: 1rem;
            border-top: 1px solid var(--mid);
        }

        .hotspot-item.expanded .hotspot-details {
            display: block;
            animation: slideDown 0.3s ease;
        }

        @keyframes slideDown {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .hotspot-meta {
            display: flex;
            gap: 2rem;
            margin-bottom: 1rem;
            font-size: 0.8rem;
            color: var(--slate);
            flex-wrap: wrap;
        }

        .hotspot-meta-item {
            display: flex;
            align-items: center;
            gap: 0.4rem;
        }

        .hotspot-meta-value {
            font-family: 'JetBrains Mono', monospace;
            color: var(--text);
        }

        .param-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 0.75rem;
        }

        .param-card {
            background: rgba(0, 0, 0, 0.2);
            border-radius: 6px;
            padding: 0.75rem 1rem;
            border-left: 3px solid var(--mid);
        }

        .param-card.critical { border-left-color: var(--coral); }
        .param-card.warning { border-left-color: var(--amber); }
        .param-card.elevated { border-left-color: var(--gold); }
        .param-card.good { border-left-color: var(--accent); }

        .param-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.5rem;
        }

        .param-name {
            font-size: 0.7rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: var(--slate);
        }

        .param-value {
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.85rem;
            color: var(--warm);
        }

        .param-bar {
            height: 4px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 2px;
            overflow: hidden;
        }

        .param-bar-fill {
            height: 100%;
            border-radius: 2px;
            transition: width 0.5s ease;
        }

        .param-bar-fill.critical { background: var(--coral); }
        .param-bar-fill.warning { background: var(--amber); }
        .param-bar-fill.elevated { background: var(--gold); }
        .param-bar-fill.good { background: var(--accent); }

        .hotspot-score {
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.85rem;
            color: var(--slate);
            background: rgba(0,0,0,0.2);
            padding: 0.4rem 0.8rem;
            border-radius: 4px;
        }

        .hotspot-item:nth-child(1) .hotspot-score { color: var(--coral); background: rgba(231, 111, 81, 0.15); }
        .hotspot-item:nth-child(2) .hotspot-score { color: var(--amber); background: rgba(244, 162, 97, 0.15); }
        .hotspot-item:nth-child(3) .hotspot-score { color: var(--gold); background: rgba(255, 230, 109, 0.15); }

        /* HUC12 Interactive Map */
        .huc12-map-container {
            margin: 3rem 0;
            border-radius: 12px;
            overflow: hidden;
            border: 1px solid var(--mid);
            background: var(--dark);
        }

        .huc12-map-header {
            padding: 1rem 1.5rem;
            background: rgba(42, 65, 88, 0.4);
            border-bottom: 1px solid var(--mid);
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 1rem;
        }

        .huc12-map-title {
            font-family: 'Newsreader', serif;
            font-size: 1.1rem;
            color: var(--warm);
        }

        .huc12-map-legend {
            display: flex;
            gap: 1rem;
            flex-wrap: wrap;
            font-size: 0.75rem;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 0.4rem;
            color: var(--text-dim);
        }

        .legend-swatch {
            width: 14px;
            height: 14px;
            border-radius: 3px;
            border: 1px solid rgba(255,255,255,0.2);
        }

        #huc12Map {
            height: 450px;
            width: 100%;
            background: var(--deep);
        }

        .leaflet-popup-content-wrapper {
            background: var(--dark);
            color: var(--text);
            border-radius: 8px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.4);
        }

        .leaflet-popup-content {
            margin: 0.75rem 1rem;
            font-family: 'Inter', sans-serif;
            font-size: 0.85rem;
            line-height: 1.5;
        }

        .leaflet-popup-tip {
            background: var(--dark);
        }

        .popup-title {
            font-family: 'Newsreader', serif;
            font-size: 1.1rem;
            color: var(--accent);
            margin-bottom: 0.5rem;
            padding-bottom: 0.5rem;
            border-bottom: 1px solid var(--mid);
        }

        .popup-stats {
            display: grid;
            grid-template-columns: auto 1fr;
            gap: 0.3rem 0.75rem;
        }

        .popup-label {
            color: var(--slate);
            font-size: 0.75rem;
        }

        .popup-value {
            font-family: 'JetBrains Mono', monospace;
            color: var(--warm);
            font-size: 0.8rem;
        }

        .popup-rank {
            display: inline-block;
            background: var(--accent);
            color: var(--deep);
            padding: 0.15rem 0.5rem;
            border-radius: 3px;
            font-weight: 600;
            font-size: 0.75rem;
        }

        .popup-rank.critical { background: var(--coral); }
        .popup-rank.high { background: var(--amber); }
        .popup-rank.elevated { background: var(--gold); color: var(--deep); }

        .leaflet-control-attribution {
            background: rgba(27, 40, 56, 0.9) !important;
            color: var(--slate) !important;
            font-size: 0.65rem !important;
        }

        .leaflet-control-attribution a {
            color: var(--accent) !important;
        }

        @media (max-width: 768px) {
            #huc12Map {
                height: 350px;
            }
            .huc12-map-header {
                flex-direction: column;
                align-items: flex-start;
            }
        }

        /* Table Filters */
        .table-filters {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            margin-bottom: 1.5rem;
        }

        .table-filter-btn {
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.7rem;
            padding: 0.4rem 0.8rem;
            background: transparent;
            border: 1px solid var(--mid);
            border-radius: 16px;
            color: var(--text-dim);
            cursor: pointer;
            transition: all 0.2s ease;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .table-filter-btn:hover {
            border-color: var(--accent);
            color: var(--accent);
        }

        .table-filter-btn.active {
            background: var(--accent);
            border-color: var(--accent);
            color: var(--deep);
        }

        /* Comparison Table */
        .comparison-table {
            width: 100%;
            border-collapse: collapse;
            margin: 2rem 0;
            font-size: 0.95rem;
        }

        .comparison-table tr.hidden {
            display: none;
        }

        .comparison-table th {
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.7rem;
            text-transform: uppercase;
            letter-spacing: 0.1em;
            color: var(--slate);
            text-align: left;
            padding: 1rem;
            border-bottom: 2px solid rgba(78, 205, 196, 0.3);
            background: rgba(42, 65, 88, 0.3);
        }

        .comparison-table td {
            padding: 1.25rem 1rem;
            border-bottom: 1px solid rgba(255,255,255,0.05);
            vertical-align: top;
        }

        .comparison-table tr:hover td {
            background: rgba(42, 65, 88, 0.2);
        }

        .status-pill {
            display: inline-flex;
            align-items: center;
            gap: 0.4rem;
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.7rem;
            padding: 0.3rem 0.7rem;
            border-radius: 20px;
        }

        .status-pill.match {
            background: rgba(78, 205, 196, 0.15);
            color: var(--accent);
        }

        .status-pill.diff {
            background: rgba(244, 162, 97, 0.15);
            color: var(--amber);
        }

        /* Methodology Accordion */
        .method-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 1rem;
            margin: 2rem 0;
        }

        .method-card {
            background: rgba(42, 65, 88, 0.2);
            border: 1px solid rgba(255,255,255,0.05);
            border-radius: 8px;
            padding: 1.5rem;
        }

        .method-card h4 {
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 0.1em;
            color: var(--accent);
            margin-bottom: 0.75rem;
        }

        .method-card p {
            font-size: 0.9rem;
            color: var(--text-dim);
            line-height: 1.7;
        }

        .method-card code {
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.8rem;
            background: rgba(0,0,0,0.3);
            padding: 0.15rem 0.4rem;
            border-radius: 3px;
            color: var(--accent);
        }

        /* Roadmap Section */
        .roadmap-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
            gap: 1.25rem;
            margin: 2rem 0;
        }

        .roadmap-item {
            background: rgba(42, 65, 88, 0.3);
            border: 1px solid rgba(255, 255, 255, 0.08);
            border-radius: 12px;
            padding: 1.5rem;
            transition: all 0.2s ease;
        }

        .roadmap-item:hover {
            border-color: rgba(78, 205, 196, 0.3);
            transform: translateY(-2px);
        }

        .roadmap-icon {
            font-size: 1.5rem;
            margin-bottom: 0.75rem;
        }

        .roadmap-item h4 {
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.85rem;
            color: var(--accent);
            margin-bottom: 0.5rem;
        }

        .roadmap-item p {
            font-size: 0.85rem;
            color: var(--text-dim);
            line-height: 1.6;
        }

        /* CTA Section */
        .cta-title {
            font-family: 'Newsreader', serif;
            font-size: clamp(1.75rem, 4vw, 2.5rem);
            margin-bottom: 1.5rem;
        }

        .cta-buttons {
            display: flex;
            gap: 1rem;
            justify-content: center;
            flex-wrap: wrap;
            margin-top: 2rem;
        }

        .btn {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.875rem 1.75rem;
            font-size: 0.85rem;
            font-weight: 500;
            text-decoration: none;
            border-radius: 6px;
            transition: all 0.2s ease;
        }

        .btn-primary {
            background: var(--accent);
            color: var(--deep);
        }

        .btn-primary:hover {
            background: var(--accent-glow);
            transform: translateY(-2px);
        }

        .btn-secondary {
            background: transparent;
            color: var(--text);
            border: 1px solid rgba(255,255,255,0.2);
        }

        .btn-secondary:hover {
            border-color: var(--accent);
            color: var(--accent);
        }

        /* Footer */
        footer {
            padding: 4rem 2rem;
            text-align: center;
            border-top: 1px solid rgba(255,255,255,0.05);
        }

        .footer-logo {
            font-family: 'Newsreader', serif;
            font-size: 1.25rem;
            color: var(--text-dim);
            margin-bottom: 1rem;
        }

        .footer-text {
            font-size: 0.85rem;
            color: var(--slate);
            line-height: 1.8;
        }

        .footer-text a {
            color: var(--accent-dim);
            text-decoration: none;
        }

        .footer-text a:hover {
            color: var(--accent);
        }

        /* Animations */
        @keyframes fadeUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .reveal {
            opacity: 0;
            transform: translateY(40px);
            transition: all 0.8s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .reveal.visible {
            opacity: 1;
            transform: translateY(0);
        }

        /* Scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
        }

        ::-webkit-scrollbar-track {
            background: var(--deep);
        }

        ::-webkit-scrollbar-thumb {
            background: var(--mid);
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: var(--accent-dim);
        }

        /* Quote Block */
        .quote-block {
            border-left: 3px solid var(--accent);
            padding-left: 2rem;
            margin: 3rem 0;
        }

        .quote-block p {
            font-family: 'Newsreader', serif;
            font-size: 1.5rem;
            font-style: italic;
            color: var(--text);
            line-height: 1.6;
        }

        .quote-attribution {
            margin-top: 1rem;
            font-size: 0.9rem;
            color: var(--slate);
            font-style: normal;
        }

        /* Image placeholders */
        .map-placeholder {
            background: linear-gradient(135deg, var(--dark) 0%, var(--mid) 100%);
            border: 1px dashed rgba(78, 205, 196, 0.3);
            border-radius: 12px;
            padding: 4rem 2rem;
            text-align: center;
            margin: 2rem 0;
        }

        .map-placeholder-text {
            color: var(--slate);
            font-size: 0.9rem;
        }

        /* Plot gallery */
        .plot-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 1.5rem;
            margin: 2rem 0;
        }

        /* Plot Filters */
        .plot-filters {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            margin-bottom: 2rem;
            justify-content: center;
        }

        .plot-filter-btn {
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.75rem;
            padding: 0.5rem 1rem;
            background: transparent;
            border: 1px solid var(--mid);
            border-radius: 20px;
            color: var(--text-dim);
            cursor: pointer;
            transition: all 0.2s ease;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .plot-filter-btn:hover {
            border-color: var(--accent);
            color: var(--accent);
        }

        .plot-filter-btn.active {
            background: var(--accent);
            border-color: var(--accent);
            color: var(--deep);
        }

        .plot-card {
            background: rgba(42, 65, 88, 0.2);
            border: 1px solid rgba(255,255,255,0.05);
            border-radius: 8px;
            overflow: hidden;
            transition: all 0.3s ease;
        }

        .plot-card.hidden {
            display: none;
        }

        .plot-card:hover {
            border-color: rgba(78, 205, 196, 0.3);
        }

        .plot-card img {
            width: 100%;
            height: auto;
            display: block;
        }

        .plot-caption {
            padding: 1rem;
            font-size: 0.85rem;
            color: var(--text-dim);
        }

        /* Divider */
        .divider {
            width: 60px;
            height: 3px;
            background: linear-gradient(90deg, var(--accent), transparent);
            margin: 4rem auto;
        }

        /* Photo Feature */
        .photo-feature {
            position: relative;
            margin: 3rem 0;
            border-radius: 12px;
            overflow: hidden;
        }

        .photo-feature img {
            width: 100%;
            height: auto;
            display: block;
        }

        .photo-feature-caption {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            padding: 2rem;
            background: linear-gradient(0deg, rgba(12, 24, 33, 0.95) 0%, rgba(12, 24, 33, 0.7) 70%, transparent 100%);
        }

        .photo-feature-caption p {
            font-size: 0.9rem;
            color: var(--text-dim);
            margin: 0;
            font-style: italic;
        }

        .photo-wide {
            margin: 4rem -2rem;
            border-radius: 0;
        }

        @media (min-width: 1200px) {
            .photo-wide {
                margin: 4rem calc(-50vw + 600px);
            }
        }

        /* CTA with background */
        .cta-section {
            text-align: center;
            padding: 8rem 2rem;
            position: relative;
            overflow: hidden;
        }

        .cta-section::before {
            content: '';
            position: absolute;
            inset: 0;
            background:
                linear-gradient(180deg, var(--deep) 0%, rgba(12, 24, 33, 0.7) 30%, rgba(12, 24, 33, 0.7) 70%, var(--deep) 100%),
                url('images/img_0093.jpg') center/cover no-repeat;
            z-index: -1;
        }

        /* Modal/Lightbox System */
        .modal-overlay {
            position: fixed;
            inset: 0;
            background: rgba(12, 24, 33, 0.95);
            backdrop-filter: blur(10px);
            z-index: 1000;
            display: none;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .modal-overlay.active {
            display: flex;
            opacity: 1;
        }

        .modal-container {
            position: relative;
            width: 95%;
            max-width: 1200px;
            max-height: 90vh;
            margin: auto;
            background: var(--dark);
            border: 1px solid rgba(78, 205, 196, 0.2);
            border-radius: 12px;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            transform: scale(0.95);
            transition: transform 0.3s ease;
        }

        .modal-overlay.active .modal-container {
            transform: scale(1);
        }

        .modal-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 1.25rem 1.5rem;
            border-bottom: 1px solid rgba(255,255,255,0.1);
            background: rgba(0,0,0,0.2);
        }

        .modal-title {
            font-family: 'Newsreader', serif;
            font-size: 1.25rem;
            color: var(--text);
            margin: 0;
        }

        .modal-close {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            border: 1px solid rgba(255,255,255,0.1);
            background: transparent;
            color: var(--text-dim);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
        }

        .modal-close:hover {
            border-color: var(--accent);
            color: var(--accent);
            background: rgba(78, 205, 196, 0.1);
        }

        .modal-tabs {
            display: flex;
            gap: 0;
            border-bottom: 1px solid rgba(255,255,255,0.1);
            background: rgba(0,0,0,0.1);
        }

        .modal-tab {
            padding: 0.875rem 1.5rem;
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 0.1em;
            color: var(--text-dim);
            background: transparent;
            border: none;
            cursor: pointer;
            position: relative;
            transition: color 0.2s ease;
        }

        .modal-tab:hover {
            color: var(--text);
        }

        .modal-tab.active {
            color: var(--accent);
        }

        .modal-tab.active::after {
            content: '';
            position: absolute;
            bottom: -1px;
            left: 0;
            right: 0;
            height: 2px;
            background: var(--accent);
        }

        .modal-content {
            flex: 1;
            overflow-y: auto;
            padding: 1.5rem;
        }

        .modal-panel {
            display: none;
        }

        .modal-panel.active {
            display: block;
        }

        /* Image panel */
        .modal-image-container {
            text-align: center;
            background: rgba(0,0,0,0.3);
            border-radius: 8px;
            padding: 1rem;
        }

        .modal-image-container img {
            max-width: 100%;
            max-height: 70vh;
            border-radius: 4px;
        }

        /* Data table panel */
        .modal-data-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.85rem;
        }

        .modal-data-table th {
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.7rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: var(--accent);
            text-align: left;
            padding: 0.75rem 1rem;
            border-bottom: 2px solid rgba(78, 205, 196, 0.3);
            background: rgba(0,0,0,0.2);
            white-space: nowrap;
        }

        .modal-data-table td {
            padding: 0.625rem 1rem;
            border-bottom: 1px solid rgba(255,255,255,0.05);
            color: var(--text-dim);
        }

        .modal-data-table tr:hover td {
            background: rgba(78, 205, 196, 0.05);
        }

        .modal-data-table .value-good {
            color: var(--accent);
        }

        .modal-data-table .value-bad {
            color: var(--coral);
        }

        .modal-data-table .value-warn {
            color: var(--amber);
        }

        /* Code panel */
        .modal-code-block {
            background: rgba(0,0,0,0.4);
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 8px;
            overflow: hidden;
        }

        .modal-code-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0.75rem 1rem;
            background: rgba(0,0,0,0.3);
            border-bottom: 1px solid rgba(255,255,255,0.05);
        }

        .modal-code-lang {
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.7rem;
            color: var(--accent);
            text-transform: uppercase;
            letter-spacing: 0.1em;
        }

        .modal-code-copy {
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.7rem;
            color: var(--text-dim);
            background: transparent;
            border: 1px solid rgba(255,255,255,0.1);
            padding: 0.35rem 0.75rem;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .modal-code-copy:hover {
            border-color: var(--accent);
            color: var(--accent);
        }

        .modal-code-copy.copied {
            border-color: var(--accent);
            color: var(--accent);
        }

        .modal-code-content {
            padding: 1rem;
            overflow-x: auto;
        }

        .modal-code-content pre {
            margin: 0;
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.8rem;
            line-height: 1.6;
            color: var(--text);
        }

        .modal-code-content .keyword { color: #c792ea; }
        .modal-code-content .string { color: #c3e88d; }
        .modal-code-content .number { color: #f78c6c; }
        .modal-code-content .function { color: #82aaff; }
        .modal-code-content .comment { color: #676e95; }

        /* Clickable plot cards */
        .plot-card.clickable {
            cursor: pointer;
            position: relative;
        }

        .plot-card.clickable:hover img {
            filter: brightness(0.6);
        }

        .plot-card.clickable img {
            transition: filter 0.3s ease;
        }

        /* Hover tooltip overlay */
        .plot-tooltip {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(180deg, rgba(12, 24, 33, 0.75) 0%, rgba(12, 24, 33, 0.95) 100%);
            display: flex;
            flex-direction: column;
            justify-content: center;
            padding: 1.25rem;
            opacity: 0;
            transition: opacity 0.3s ease;
            pointer-events: none;
        }

        .plot-card.clickable:hover .plot-tooltip {
            opacity: 1;
        }

        .plot-tooltip-label {
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.65rem;
            text-transform: uppercase;
            letter-spacing: 0.1em;
            color: var(--accent);
            margin-bottom: 0.5rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .plot-tooltip-label::before {
            content: '';
            width: 12px;
            height: 2px;
            background: var(--accent);
        }

        .plot-tooltip-text {
            font-size: 0.85rem;
            color: var(--text);
            line-height: 1.6;
            margin-bottom: 1rem;
        }

        .plot-tooltip-cta {
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.7rem;
            color: var(--accent);
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-top: auto;
        }

        .plot-tooltip-cta svg {
            width: 14px;
            height: 14px;
        }

        @media (max-width: 768px) {
            .plot-tooltip {
                padding: 1rem;
            }
            .plot-tooltip-text {
                font-size: 0.75rem;
            }
        }

        /* ============================================
           READING PROGRESS BAR
           ============================================ */
        .progress-bar {
            position: fixed;
            top: 0;
            left: 0;
            width: 0%;
            height: 3px;
            background: linear-gradient(90deg, var(--accent), var(--accent-glow));
            z-index: 1001;
            transition: width 0.1s ease-out;
            box-shadow: 0 0 10px var(--accent);
        }

        /* ============================================
           CHAPTER NAVIGATION DOTS
           ============================================ */
        .chapter-nav {
            position: fixed !important;
            right: 2rem !important;
            left: auto !important;
            top: 50% !important;
            transform: translateY(-50%);
            z-index: 99;
            display: flex;
            flex-direction: column;
            gap: 1rem;
            opacity: 0;
            transition: opacity 0.5s ease;
            width: auto !important;
            padding: 0 !important;
            background: transparent !important;
        }

        .chapter-nav.visible {
            opacity: 1;
        }

        .chapter-dot {
            position: relative;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: rgba(78, 205, 196, 0.2);
            border: 2px solid rgba(78, 205, 196, 0.4);
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .chapter-dot:hover {
            background: rgba(78, 205, 196, 0.4);
            border-color: var(--accent);
            transform: scale(1.2);
        }

        .chapter-dot.active {
            background: var(--accent);
            border-color: var(--accent);
            box-shadow: 0 0 12px var(--accent);
        }

        .chapter-dot-label {
            position: absolute;
            right: 24px;
            top: 50%;
            transform: translateY(-50%);
            background: var(--dark);
            border: 1px solid rgba(78, 205, 196, 0.3);
            padding: 0.4rem 0.75rem;
            border-radius: 4px;
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.65rem;
            color: var(--text);
            white-space: nowrap;
            opacity: 0;
            pointer-events: none;
            transition: all 0.2s ease;
        }

        .chapter-dot:hover .chapter-dot-label {
            opacity: 1;
            right: 28px;
        }

        @media (max-width: 1024px) {
            .chapter-nav {
                right: 1rem;
            }
            .chapter-dot-label {
                display: none;
            }
        }

        @media (max-width: 768px) {
            .chapter-nav {
                display: none;
            }
        }

        /* ============================================
           GLOSSARY TOOLTIPS
           ============================================ */
        .glossary-term {
            position: relative;
            color: var(--accent);
            border-bottom: 1px dotted var(--accent);
            cursor: help;
            transition: all 0.2s ease;
        }

        .glossary-term:hover {
            color: var(--accent-glow);
            border-bottom-style: solid;
        }

        .glossary-term::before {
            content: attr(data-definition);
            position: absolute;
            bottom: calc(100% + 8px);
            left: 50%;
            transform: translateX(-50%);
            background: var(--dark);
            border: 1px solid var(--accent);
            border-radius: 8px;
            padding: 0.75rem 1rem;
            font-family: 'Inter', sans-serif;
            font-size: 0.8rem;
            font-weight: 400;
            color: var(--text);
            line-height: 1.5;
            width: max-content;
            max-width: 280px;
            white-space: normal;
            text-align: left;
            z-index: 100;
            opacity: 0;
            visibility: hidden;
            transition: all 0.2s ease;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.4);
            pointer-events: none;
        }

        .glossary-term::after {
            content: '';
            position: absolute;
            bottom: calc(100% + 2px);
            left: 50%;
            transform: translateX(-50%);
            border: 6px solid transparent;
            border-top-color: var(--accent);
            z-index: 101;
            opacity: 0;
            visibility: hidden;
            transition: all 0.2s ease;
        }

        .glossary-term:hover::before,
        .glossary-term:hover::after {
            opacity: 1;
            visibility: visible;
        }

        /* Tooltip position adjustments for edge cases */
        .glossary-term.tooltip-left::before {
            left: 0;
            transform: translateX(0);
        }
        .glossary-term.tooltip-left::after {
            left: 20px;
            transform: translateX(0);
        }

        .glossary-term.tooltip-right::before {
            left: auto;
            right: 0;
            transform: translateX(0);
        }
        .glossary-term.tooltip-right::after {
            left: auto;
            right: 20px;
            transform: translateX(0);
        }

        /* Glossary icon indicator */
        .glossary-term sup {
            font-size: 0.6em;
            color: var(--accent);
            margin-left: 2px;
        }

        @media (max-width: 768px) {
            .glossary-term::before {
                position: fixed;
                bottom: auto;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                max-width: 85vw;
                font-size: 0.85rem;
                padding: 1rem 1.25rem;
            }
            .glossary-term::after {
                display: none;
            }
        }

        /* Responsive modal */
        @media (max-width: 768px) {
            .modal-container {
                width: 100%;
                height: 100%;
                max-height: 100vh;
                border-radius: 0;
            }

            .modal-tabs {
                overflow-x: auto;
            }

            .modal-tab {
                padding: 0.75rem 1rem;
                font-size: 0.65rem;
            }

            .modal-data-table {
                font-size: 0.75rem;
            }

            .modal-data-table th,
            .modal-data-table td {
                padding: 0.5rem;
            }
        }

        /* Glossary Index Section */
        .glossary-index {
            background: var(--dark);
            padding: 6rem 2rem;
            border-top: 1px solid var(--mid);
        }

        .glossary-index-container {
            max-width: 1200px;
            margin: 0 auto;
        }

        .glossary-index h2 {
            font-family: 'Newsreader', serif;
            font-size: 2.5rem;
            color: var(--warm);
            text-align: center;
            margin-bottom: 1rem;
        }

        .glossary-index-subtitle {
            text-align: center;
            color: var(--text-dim);
            margin-bottom: 3rem;
            font-size: 1rem;
        }

        .glossary-tabs {
            display: flex;
            justify-content: center;
            gap: 0.5rem;
            margin-bottom: 2rem;
            flex-wrap: wrap;
        }

        .glossary-tab {
            background: transparent;
            border: 1px solid var(--mid);
            color: var(--text-dim);
            padding: 0.5rem 1rem;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.8rem;
            transition: all 0.2s ease;
        }

        .glossary-tab:hover {
            border-color: var(--accent);
            color: var(--accent);
        }

        .glossary-tab.active {
            background: var(--accent);
            border-color: var(--accent);
            color: var(--deep);
        }

        .glossary-category {
            display: none;
        }

        .glossary-category.active {
            display: block;
        }

        .glossary-category-title {
            font-family: 'Newsreader', serif;
            font-size: 1.4rem;
            color: var(--accent);
            margin-bottom: 1.5rem;
            padding-bottom: 0.5rem;
            border-bottom: 1px solid var(--mid);
        }

        .glossary-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
            gap: 1.5rem;
        }

        .glossary-entry {
            background: rgba(42, 65, 88, 0.3);
            border-radius: 8px;
            padding: 1.25rem;
            border-left: 3px solid var(--accent);
            transition: all 0.2s ease;
        }

        .glossary-entry:hover {
            background: rgba(42, 65, 88, 0.5);
            transform: translateX(4px);
        }

        .glossary-entry-term {
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.95rem;
            color: var(--accent);
            margin-bottom: 0.5rem;
            font-weight: 500;
        }

        .glossary-entry-def {
            font-size: 0.85rem;
            color: var(--text-dim);
            line-height: 1.6;
        }

        .glossary-entry-ref {
            margin-top: 0.75rem;
            font-size: 0.75rem;
            color: var(--slate);
            font-style: italic;
        }

        .glossary-entry-ref a {
            color: var(--accent-dim);
            text-decoration: none;
        }

        .glossary-entry-ref a:hover {
            text-decoration: underline;
        }

        /* Index Section */
        .index-section {
            margin-top: 4rem;
            padding-top: 3rem;
            border-top: 1px solid var(--mid);
        }

        .index-section h3 {
            font-family: 'Newsreader', serif;
            font-size: 1.8rem;
            color: var(--warm);
            text-align: center;
            margin-bottom: 2rem;
        }

        .index-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 0.5rem 2rem;
        }

        .index-item {
            display: flex;
            justify-content: space-between;
            align-items: baseline;
            padding: 0.4rem 0;
            border-bottom: 1px dotted var(--mid);
            font-size: 0.85rem;
        }

        .index-item-term {
            color: var(--text);
        }

        .index-item-chapter {
            color: var(--accent);
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.75rem;
            white-space: nowrap;
        }

        @media (max-width: 768px) {
            .glossary-index {
                padding: 4rem 1rem;
            }

            .glossary-index h2 {
                font-size: 1.8rem;
            }

            .glossary-list {
                grid-template-columns: 1fr;
            }

            .index-grid {
                grid-template-columns: 1fr;
            }
        }

        /* ============================================
           DATE RANGE FILTER
           ============================================ */
        .date-range-filter {
            background: rgba(12, 24, 33, 0.8);
            border: 1px solid rgba(78, 205, 196, 0.3);
            border-radius: 12px;
            padding: 1.5rem 2rem;
            margin: 2rem 0;
        }

        .date-range-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }

        .date-range-label {
            font-size: 0.9rem;
            color: var(--muted);
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .date-range-value {
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--accent);
        }

        .date-range-slider-container {
            position: relative;
            height: 40px;
            margin: 1rem 0 1.5rem;
        }

        .date-slider {
            position: absolute;
            width: 100%;
            height: 6px;
            top: 50%;
            transform: translateY(-50%);
            -webkit-appearance: none;
            appearance: none;
            background: transparent;
            pointer-events: none;
            z-index: 2;
        }

        .date-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 20px;
            height: 20px;
            background: var(--accent);
            border-radius: 50%;
            cursor: pointer;
            pointer-events: auto;
            border: 3px solid var(--dark);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
            transition: transform 0.15s ease, box-shadow 0.15s ease;
        }

        .date-slider::-webkit-slider-thumb:hover {
            transform: scale(1.2);
            box-shadow: 0 3px 12px rgba(78, 205, 196, 0.4);
        }

        .date-slider::-moz-range-thumb {
            width: 20px;
            height: 20px;
            background: var(--accent);
            border-radius: 50%;
            cursor: pointer;
            pointer-events: auto;
            border: 3px solid var(--dark);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
        }

        .slider-track {
            position: absolute;
            width: 100%;
            height: 6px;
            top: 50%;
            transform: translateY(-50%);
            background: rgba(78, 205, 196, 0.2);
            border-radius: 3px;
        }

        .slider-range {
            position: absolute;
            height: 6px;
            top: 50%;
            transform: translateY(-50%);
            background: linear-gradient(90deg, var(--accent), var(--success));
            border-radius: 3px;
        }

        .date-range-presets {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            margin-bottom: 1rem;
        }

        .preset-btn {
            background: rgba(78, 205, 196, 0.1);
            border: 1px solid rgba(78, 205, 196, 0.3);
            color: var(--muted);
            padding: 0.4rem 0.8rem;
            border-radius: 20px;
            font-size: 0.8rem;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .preset-btn:hover,
        .preset-btn.active {
            background: rgba(78, 205, 196, 0.2);
            border-color: var(--accent);
            color: var(--accent);
        }

        .date-range-note {
            font-size: 0.75rem;
            color: var(--muted);
            opacity: 0.7;
            margin: 0;
        }

        @media (max-width: 600px) {
            .date-range-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 0.5rem;
            }

            .date-range-presets {
                justify-content: center;
            }
        }

        /* ============================================
           CROSSTAB ANALYSIS
           ============================================ */
        .crosstab-section {
            padding: 4rem 2rem;
            background: linear-gradient(180deg, var(--dark) 0%, rgba(12, 24, 33, 0.95) 100%);
        }

        .crosstab-controls {
            display: flex;
            flex-wrap: wrap;
            gap: 2rem;
            align-items: flex-end;
            margin-bottom: 2rem;
            padding: 1.5rem;
            background: rgba(12, 24, 33, 0.8);
            border: 1px solid rgba(78, 205, 196, 0.3);
            border-radius: 12px;
        }

        .crosstab-select-group {
            flex: 1;
            min-width: 280px;
        }

        .crosstab-select-group label {
            display: block;
            font-size: 0.85rem;
            color: var(--cyan);
            margin-bottom: 0.5rem;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .crosstab-select {
            width: 100%;
            padding: 0.75rem 1rem;
            font-size: 1rem;
            font-family: var(--font-body);
            color: var(--light);
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(78, 205, 196, 0.4);
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .crosstab-select:hover,
        .crosstab-select:focus {
            border-color: var(--cyan);
            outline: none;
            box-shadow: 0 0 10px rgba(78, 205, 196, 0.3);
        }

        .crosstab-select option {
            background: var(--dark);
            color: var(--light);
            padding: 0.5rem;
        }

        .crosstab-stats {
            display: flex;
            gap: 2rem;
        }

        .crosstab-stats .stat-item {
            text-align: center;
            padding: 0.75rem 1.5rem;
            background: rgba(78, 205, 196, 0.1);
            border-radius: 8px;
            border: 1px solid rgba(78, 205, 196, 0.2);
        }

        .crosstab-stats .stat-label {
            display: block;
            font-size: 0.75rem;
            color: var(--gray);
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 0.25rem;
        }

        .crosstab-stats .stat-value {
            display: block;
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--cyan);
            font-family: var(--font-mono);
        }

        .crosstab-chart-container {
            background: rgba(12, 24, 33, 0.9);
            border: 1px solid rgba(78, 205, 196, 0.2);
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 2rem;
            min-height: 450px;
            position: relative;
        }

        .crosstab-chart-container canvas {
            max-height: 450px;
        }

        .crosstab-interpretation {
            background: rgba(78, 205, 196, 0.05);
            border-left: 4px solid var(--cyan);
            padding: 1.25rem 1.5rem;
            border-radius: 0 8px 8px 0;
        }

        .crosstab-interpretation h4 {
            color: var(--cyan);
            margin: 0 0 0.5rem 0;
            font-size: 1rem;
        }

        .crosstab-interpretation p {
            color: var(--gray);
            margin: 0;
            font-size: 0.95rem;
            line-height: 1.6;
        }

        .crosstab-loading {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: var(--cyan);
            font-size: 1rem;
        }

        @media (max-width: 768px) {
            .crosstab-controls {
                flex-direction: column;
                align-items: stretch;
            }

            .crosstab-stats {
                justify-content: center;
            }

            .crosstab-select-group {
                min-width: 100%;
            }
        }

        /* ============================================
           PARAMETER MAP
           ============================================ */
        .parameter-map-section {
            padding: 4rem 2rem;
            background: linear-gradient(180deg, rgba(12, 24, 33, 0.95) 0%, var(--dark) 100%);
        }

        .param-map-controls {
            display: flex;
            flex-wrap: wrap;
            gap: 2rem;
            align-items: flex-end;
            margin-bottom: 1.5rem;
            padding: 1.5rem;
            background: rgba(12, 24, 33, 0.8);
            border: 1px solid rgba(78, 205, 196, 0.3);
            border-radius: 12px;
        }

        .param-map-select-group {
            flex: 1;
            min-width: 280px;
        }

        .param-map-select-group label {
            display: block;
            font-size: 0.85rem;
            color: var(--cyan);
            margin-bottom: 0.5rem;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .param-map-select {
            width: 100%;
            padding: 0.75rem 1rem;
            font-size: 1rem;
            font-family: var(--font-body);
            color: var(--light);
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(78, 205, 196, 0.4);
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .param-map-select:hover,
        .param-map-select:focus {
            border-color: var(--cyan);
            outline: none;
            box-shadow: 0 0 10px rgba(78, 205, 196, 0.3);
        }

        .param-map-select option {
            background: var(--dark);
            color: var(--light);
        }

        .param-map-stats {
            display: flex;
            gap: 2rem;
        }

        .param-map-stats .stat-item {
            text-align: center;
            padding: 0.75rem 1.5rem;
            background: rgba(78, 205, 196, 0.1);
            border-radius: 8px;
            border: 1px solid rgba(78, 205, 196, 0.2);
        }

        .param-map-stats .stat-label {
            display: block;
            font-size: 0.75rem;
            color: var(--gray);
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 0.25rem;
        }

        .param-map-stats .stat-value {
            display: block;
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--cyan);
            font-family: var(--font-mono);
        }

        .param-map-container {
            position: relative;
            height: 500px;
            background: rgba(12, 24, 33, 0.9);
            border: 1px solid rgba(78, 205, 196, 0.2);
            border-radius: 12px;
            overflow: hidden;
            margin-bottom: 1.5rem;
        }

        #paramMapLeaflet {
            height: 100%;
            width: 100%;
            background: #0c1821;
        }

        .param-map-legend {
            position: absolute;
            top: 10px;
            right: 10px;
            z-index: 1000;
            background: rgba(12, 24, 33, 0.95);
            padding: 12px 16px;
            border-radius: 8px;
            border: 1px solid rgba(78, 205, 196, 0.3);
        }

        .param-map-legend .legend-item {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.8rem;
            color: var(--gray);
            margin-bottom: 6px;
        }

        .param-map-legend .legend-item:last-child {
            margin-bottom: 0;
        }

        .param-map-legend .legend-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            flex-shrink: 0;
        }

        .param-map-legend .legend-dot.critical {
            background: #ff4444;
        }

        .param-map-legend .legend-dot.high {
            background: #ff8c00;
        }

        .param-map-legend .legend-dot.moderate {
            background: #ffd700;
        }

        .param-map-legend .legend-dot.low {
            background: #90ee90;
        }

        .param-map-legend .legend-dot.clean {
            background: #4ecdc4;
        }

        .param-map-note {
            background: rgba(78, 205, 196, 0.05);
            border-left: 4px solid var(--cyan);
            padding: 1rem 1.25rem;
            border-radius: 0 8px 8px 0;
            font-size: 0.9rem;
            color: var(--gray);
        }

        .param-map-note strong {
            color: var(--cyan);
        }

        @media (max-width: 768px) {
            .param-map-controls {
                flex-direction: column;
                align-items: stretch;
            }

            .param-map-stats {
                justify-content: center;
            }

            .param-map-select-group {
                min-width: 100%;
            }

            .param-map-container {
                height: 400px;
            }

            .param-map-legend {
                top: auto;
                bottom: 10px;
                right: 10px;
                left: 10px;
                display: flex;
                flex-wrap: wrap;
                gap: 12px;
                justify-content: center;
            }

            .param-map-legend .legend-item {
                margin-bottom: 0;
            }
        }

        /* ============================================
           DISTRIBUTION HISTOGRAMS
           ============================================ */
        .histogram-section {
            padding: 4rem 2rem;
            background: var(--dark);
        }

        .histogram-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 2rem;
            max-width: 1400px;
            margin: 0 auto;
        }

        .histogram-card {
            background: rgba(12, 24, 33, 0.8);
            border: 1px solid rgba(78, 205, 196, 0.2);
            border-radius: 12px;
            padding: 1.5rem;
            transition: all 0.3s ease;
        }

        .histogram-card:hover {
            border-color: var(--accent);
            box-shadow: 0 8px 32px rgba(78, 205, 196, 0.15);
        }

        .histogram-card h4 {
            font-family: 'Newsreader', serif;
            font-size: 1.1rem;
            color: var(--warm);
            margin-bottom: 0.5rem;
        }

        .histogram-card .param-stats {
            display: flex;
            gap: 1rem;
            flex-wrap: wrap;
            margin-bottom: 1rem;
            font-size: 0.8rem;
            color: var(--text-dim);
        }

        .histogram-card .param-stats span {
            background: rgba(78, 205, 196, 0.1);
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
        }

        .histogram-canvas {
            height: 200px !important;
            width: 100% !important;
        }

        .histogram-controls {
            display: flex;
            gap: 0.5rem;
            margin-top: 1rem;
            flex-wrap: wrap;
        }

        .histogram-btn {
            padding: 0.4rem 0.8rem;
            background: transparent;
            border: 1px solid var(--mid);
            color: var(--text-dim);
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.75rem;
            transition: all 0.2s;
        }

        .histogram-btn:hover, .histogram-btn.active {
            background: var(--accent);
            color: var(--deep);
            border-color: var(--accent);
        }

        @media (max-width: 600px) {
            .histogram-grid {
                grid-template-columns: 1fr;
            }
        }

        /* ============================================
           PARAMETER INTERPRETATION GUIDE
           ============================================ */
        .param-guide-section {
            padding: 4rem 2rem;
            max-width: 1200px;
            margin: 0 auto;
        }

        .param-guide-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 1.5rem;
            margin-top: 2rem;
        }

        .param-guide-card {
            background: linear-gradient(135deg, rgba(42, 65, 88, 0.4) 0%, rgba(27, 40, 56, 0.6) 100%);
            border: 1px solid rgba(78, 205, 196, 0.15);
            border-radius: 12px;
            padding: 1.5rem;
            transition: all 0.3s ease;
        }

        .param-guide-card:hover {
            border-color: var(--accent);
            transform: translateY(-3px);
        }

        .param-guide-header {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            margin-bottom: 1rem;
        }

        .param-guide-icon {
            width: 40px;
            height: 40px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
        }

        .param-guide-icon.metals { background: rgba(255, 107, 107, 0.2); }
        .param-guide-icon.bacteria { background: rgba(255, 193, 7, 0.2); }
        .param-guide-icon.ions { background: rgba(78, 205, 196, 0.2); }
        .param-guide-icon.physical { background: rgba(156, 136, 255, 0.2); }

        .param-guide-card h4 {
            font-family: 'Newsreader', serif;
            font-size: 1.15rem;
            color: var(--warm);
            margin: 0;
        }

        .param-guide-card .standard {
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.75rem;
            color: var(--accent);
            margin-top: 0.25rem;
        }

        .param-guide-card p {
            font-size: 0.9rem;
            color: var(--text-dim);
            line-height: 1.7;
            margin-bottom: 1rem;
        }

        .param-guide-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
        }

        .param-tag {
            font-size: 0.7rem;
            padding: 0.2rem 0.5rem;
            border-radius: 3px;
            background: rgba(0, 0, 0, 0.3);
            color: var(--slate);
        }

        .param-tag.source { border-left: 2px solid var(--coral); }
        .param-tag.impact { border-left: 2px solid var(--gold); }
        .param-tag.solution { border-left: 2px solid var(--accent); }

        /* ============================================
           EXPORT FUNCTIONALITY
           ============================================ */
        .export-panel {
            position: fixed;
            bottom: 2rem;
            right: 2rem;
            z-index: 90;
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
            opacity: 0;
            transform: translateY(20px);
            transition: all 0.3s ease;
        }

        .export-panel.visible {
            opacity: 1;
            transform: translateY(0);
        }

        .export-btn {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.75rem 1.25rem;
            background: var(--dark);
            border: 1px solid var(--mid);
            color: var(--text);
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.85rem;
            transition: all 0.2s ease;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        }

        .export-btn:hover {
            background: var(--accent);
            color: var(--deep);
            border-color: var(--accent);
            transform: scale(1.05);
        }

        .export-btn svg {
            width: 16px;
            height: 16px;
        }

        .export-toast {
            position: fixed;
            bottom: 2rem;
            left: 50%;
            transform: translateX(-50%) translateY(100px);
            background: var(--accent);
            color: var(--deep);
            padding: 1rem 2rem;
            border-radius: 8px;
            font-weight: 500;
            opacity: 0;
            transition: all 0.3s ease;
            z-index: 100;
        }

        .export-toast.show {
            transform: translateX(-50%) translateY(0);
            opacity: 1;
        }

        @media (max-width: 768px) {
            .export-panel {
                bottom: 1rem;
                right: 1rem;
            }
            .export-btn {
                padding: 0.6rem 1rem;
                font-size: 0.8rem;
            }
        }

        /* ============================================
           MOBILE TOUCH OPTIMIZATIONS
           ============================================ */
        @media (hover: none) and (pointer: coarse) {
            /* Larger touch targets */
            .plot-filter-btn,
            .table-filter-btn,
            .glossary-tab {
                min-height: 44px;
                min-width: 44px;
                padding: 0.75rem 1rem;
            }

            /* Swipe indicator for plot gallery */
            .plot-grid::after {
                content: '← Swipe to explore →';
                display: block;
                text-align: center;
                color: var(--slate);
                font-size: 0.75rem;
                margin-top: 1rem;
                opacity: 0.7;
            }

            /* Disable hover effects that cause sticky states on touch */
            .plot-card:hover {
                transform: none;
            }

            .stat-card:hover {
                transform: none;
            }

            /* Make interactive elements more visible */
            .hotspot-item {
                padding: 1rem;
            }

            .court-stream-item {
                padding: 1.25rem;
            }

            /* Touch-friendly map controls */
            .leaflet-control-zoom a {
                width: 36px !important;
                height: 36px !important;
                line-height: 36px !important;
                font-size: 18px !important;
            }
        }

        /* Touch feedback for interactive elements */
        .touch-active {
            transform: scale(0.97);
            opacity: 0.9;
        }

        /* Swipeable container */
        .swipe-container {
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
            scroll-snap-type: x mandatory;
            scrollbar-width: none;
        }

        .swipe-container::-webkit-scrollbar {
            display: none;
        }

        .swipe-container > * {
            scroll-snap-align: start;
        }

        /* ============================================
           WATERSHED BOUNDARY OVERLAY STYLES
           ============================================ */
        .map-layer-toggle {
            position: absolute;
            top: 10px;
            right: 10px;
            z-index: 1000;
            background: var(--dark);
            border: 1px solid var(--mid);
            border-radius: 8px;
            padding: 0.5rem;
        }

        .layer-toggle-btn {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem 0.75rem;
            background: transparent;
            border: none;
            color: var(--text-dim);
            cursor: pointer;
            font-size: 0.8rem;
            border-radius: 4px;
            transition: all 0.2s;
            white-space: nowrap;
        }

        .layer-toggle-btn:hover {
            background: rgba(78, 205, 196, 0.1);
            color: var(--text);
        }

        .layer-toggle-btn.active {
            background: var(--accent);
            color: var(--deep);
        }

        .layer-toggle-btn input[type="checkbox"] {
            accent-color: var(--accent);
        }

        .layer-toggle-btn.loading {
            opacity: 0.6;
            pointer-events: none;
        }

        .layer-toggle-btn.loading::after {
            content: '';
            width: 12px;
            height: 12px;
            border: 2px solid transparent;
            border-top-color: var(--accent);
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
            margin-left: auto;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Stream flowlines */
        .flowline-layer {
            stroke: #4da6ff;
            stroke-width: 2;
            fill: none;
            opacity: 0.7;
        }
    </style>
</head>
<body>
    <!-- Reading Progress Bar -->
    <div class="progress-bar" id="progressBar"></div>

    <!-- Chapter Navigation Dots -->
    <nav class="chapter-nav" id="chapterNav">
        <div class="chapter-dot" data-target="hero">
            <span class="chapter-dot-label">Home</span>
        </div>
        <div class="chapter-dot" data-target="watershed">
            <span class="chapter-dot-label">1. The Watershed</span>
        </div>
        <div class="chapter-dot" data-target="challenge">
            <span class="chapter-dot-label">2. The Challenge</span>
        </div>
        <div class="chapter-dot" data-target="data">
            <span class="chapter-dot-label">3. The Data</span>
        </div>
        <div class="chapter-dot" data-target="findings">
            <span class="chapter-dot-label">4. Findings</span>
        </div>
        <div class="chapter-dot" data-target="since-2022">
            <span class="chapter-dot-label">5. Since 2022</span>
        </div>
        <div class="chapter-dot" data-target="hotspots">
            <span class="chapter-dot-label">6. Hotspots</span>
        </div>
        <div class="chapter-dot" data-target="court-order">
            <span class="chapter-dot-label">Court Order</span>
        </div>
        <div class="chapter-dot" data-target="evidence">
            <span class="chapter-dot-label">7. Evidence</span>
        </div>
        <div class="chapter-dot" data-target="methodology">
            <span class="chapter-dot-label">8. Methodology</span>
        </div>
        <div class="chapter-dot" data-target="action">
            <span class="chapter-dot-label">Action</span>
        </div>
        <div class="chapter-dot" data-target="glossary">
            <span class="chapter-dot-label">Glossary</span>
        </div>
    </nav>

    <!-- Navigation -->
    <nav id="nav">
        <a href="#" class="nav-logo">Lower Guyandotte</a>
        <ul class="nav-links">
            <li><a href="#watershed">The Watershed</a></li>
            <li><a href="#challenge">The Challenge</a></li>
            <li><a href="#data">The Data</a></li>
            <li><a href="#findings">Findings</a></li>
            <li><a href="#since-2022">Since 2022</a></li>
            <li><a href="#action">Action</a></li>
        </ul>
    </nav>

    <!-- Hero -->
    <section class="hero" id="hero">
        <div class="hero-partnership">
            <a href="https://wvrivers.org" target="_blank" rel="noopener" class="partner-link">
                <img src="https://wvrivers.org/wp-content/uploads/2017/02/logo-1.png" alt="WV Rivers Coalition" class="hero-partner-logo" onerror="this.parentElement.innerHTML='<span class=\'partner-text-fallback\'>WV Rivers Coalition</span>'">
            </a>
            <span class="hero-partner-tagline">Produced in partnership with WV Rivers Coalition</span>
        </div>
        <p class="hero-eyebrow">West Virginia Water Quality Assessment</p>
        <h1 class="hero-title">The Story of the <em>Lower Guyandotte</em></h1>
        <p class="hero-subtitle">55 years of water quality monitoring reveal a watershed shaped by coal country's past—and hints at its possible future.</p>
        <div class="hero-stats">
            <div class="hero-stat">
                <p class="hero-stat-value">103,534</p>
                <p class="hero-stat-label">Samples Analyzed</p>
            </div>
            <div class="hero-stat">
                <p class="hero-stat-value">55</p>
                <p class="hero-stat-label">Years of Data</p>
            </div>
            <div class="hero-stat">
                <p class="hero-stat-value">80%</p>
                <p class="hero-stat-label">Waters Impaired</p>
            </div>
        </div>
        <div class="scroll-indicator">
            <span>Scroll to explore</span>
            <div class="scroll-line"></div>
        </div>
    </section>

    <!-- Chapter 1: The Watershed -->
    <section class="chapter chapter-narrow reveal" id="watershed">
        <p class="chapter-label">Chapter 1</p>
        <h2 class="chapter-title">A River Runs Through Coal Country</h2>
        <p class="chapter-lead">The Lower Guyandotte watershed drains the heart of southern West Virginia's coal country—a landscape defined by steep hollows, winding creeks, and over a century of mining.</p>

        <div class="prose">
            <p>The Guyandotte River begins in the mountains near the Virginia border and flows northwest through Logan, Lincoln, and Cabell counties before joining the Ohio River at Huntington. Its lower reaches—designated as <span class="glossary-term" data-definition="Hydrologic Unit Code — a unique identifier for watersheds in the US. The 8-digit code 05070102 identifies the Lower Guyandotte subbasin within the Ohio River basin.">HUC 05070102</span>—encompass some of the most heavily mined terrain in Appalachia.</p>

            <p>For generations, coal powered the economy here. But extraction left its mark: acid mine drainage seeping from abandoned portals, selenium leaching from valley fills, and sediment washing from disturbed slopes. The watershed tells two stories—one of industrial heritage, another of ecological recovery.</p>
        </div>

        <div class="photo-feature">
            <img src="images/railroad_bridge.jpg" alt="CSX coal train crossing railroad bridge over the Guyandotte River">
            <div class="photo-feature-caption">
                <p>A CSX freight train crosses the Guyandotte River—coal has shaped this watershed for over a century.</p>
            </div>
        </div>

        <div class="stats-grid">
            <div class="stat-card">
                <p class="stat-card-value">335</p>
                <p class="stat-card-label">Assessment units</p>
            </div>
            <div class="stat-card">
                <p class="stat-card-value">884</p>
                <p class="stat-card-label">Monitoring stations</p>
            </div>
            <div class="stat-card">
                <p class="stat-card-value">192</p>
                <p class="stat-card-label">Parameters measured</p>
            </div>
        </div>
    </section>

    <!-- Chapter 2: The Challenge -->
    <section class="chapter chapter-narrow reveal" id="challenge">
        <p class="chapter-label">Chapter 2</p>
        <h2 class="chapter-title">When Water Fails Its Standards</h2>

        <div class="prose">
            <p>Under the <strong>Clean Water Act of 1972</strong>, every waterway in America has a designated use—swimming, fishing, drinking water supply, or aquatic life habitat. When monitoring shows a stream can't support its designated use, it's listed as <span class="glossary-term" data-definition="A water body is 'impaired' when monitoring data shows it fails to meet water quality standards for its designated use (swimming, fishing, aquatic life, etc.)">impaired</span>.</p>

            <p>For impaired waters, states must develop a <span class="glossary-term" data-definition="Total Maximum Daily Load — a regulatory term for the maximum amount of a pollutant a water body can receive while still meeting water quality standards. It's essentially a pollution budget.">TMDL (Total Maximum Daily Load)</span>—essentially a pollution budget that calculates how much of a given contaminant the water can receive while still meeting standards.</p>
        </div>

        <div class="highlight-box">
            <p><strong>A TMDL answers a simple question:</strong> How much pollution is too much? It sets the ceiling, then allocates responsibility among sources—point discharges, nonpoint runoff, and natural background.</p>
        </div>

        <div class="prose">
            <p>West Virginia applies its own criteria under <span class="glossary-term" data-definition="West Virginia Code of State Rules, Title 47, Series 2 — the state's comprehensive water quality standards that define numeric limits for pollutants and designated uses for each water body.">47CSR2</span>, the state's water quality standards. These specify numeric limits for pollutants and narrative criteria for conditions like "no objectionable deposits" or "waters suitable for aquatic life."</p>

            <p>In the Lower Guyandotte, six parameters drive most impairments:</p>
        </div>

        <div class="pollutant-grid">
            <div class="pollutant-card critical">
                <p class="pollutant-name"><span class="glossary-term tooltip-left" data-definition="Hot Acidity measures the total acid-generating potential of water, including dissolved metals that release acid when oxidized. It's a key indicator of acid mine drainage (AMD) severity.">Hot Acidity</span></p>
                <p class="pollutant-rate">100%</p>
                <p class="pollutant-context">All samples exceed — legacy of <span class="glossary-term" data-definition="Acid Mine Drainage (AMD) — acidic water that drains from mines when sulfur-bearing minerals (like pyrite) are exposed to air and water, producing sulfuric acid that dissolves heavy metals.">acid mine drainage</span></p>
                <div class="pollutant-bar"><div class="pollutant-fill" style="width: 100%"></div></div>
                <p class="pollutant-standard">Standard: 0 <span class="glossary-term" data-definition="Milligrams per liter — a concentration unit equivalent to parts per million (ppm). Used for most water quality measurements.">mg/L</span> <span class="glossary-term" data-definition="Calcium carbonate equivalent — a standard unit for expressing acidity or alkalinity. Used to normalize different acid sources for comparison.">CaCO₃</span></p>
            </div>
            <div class="pollutant-card warning">
                <p class="pollutant-name"><span class="glossary-term tooltip-left" data-definition="Fecal Coliform bacteria indicate the presence of human or animal waste in water. High levels make water unsafe for swimming, fishing, and other recreational contact.">Fecal Coliform</span></p>
                <p class="pollutant-rate">38.4%</p>
                <p class="pollutant-context">Bacteria from failing septics and agriculture</p>
                <div class="pollutant-bar"><div class="pollutant-fill" style="width: 38.4%"></div></div>
                <p class="pollutant-standard">Standard: 200/400 <span class="glossary-term" data-definition="Colony Forming Units — a measure of viable bacteria. CFU/100mL counts how many bacteria colonies grow from a 100 milliliter water sample.">CFU</span> per 100mL</p>
            </div>
            <div class="pollutant-card critical conductivity-highlight">
                <p class="pollutant-name"><span class="glossary-term tooltip-left" data-definition="Specific Conductance measures water's ability to conduct electricity, which increases with dissolved ions. In mining areas, high conductivity indicates contamination from dissolved minerals and salts.">Specific Conductance</span> <span class="ionic-badge">Ionic Toxicity</span></p>
                <p class="pollutant-rate">46.0%</p>
                <p class="pollutant-context">Primary driver of aquatic life impairment</p>
                <div class="pollutant-bar"><div class="pollutant-fill" style="width: 46%"></div></div>
                <p class="pollutant-standard">Threshold: 300 <span class="glossary-term" data-definition="Microsiemens per centimeter — the standard unit for measuring electrical conductivity in water. Higher values indicate more dissolved ions.">µS/cm</span> — <a href="https://assessments.epa.gov/risk/document/&deid=233809" target="_blank" style="color: var(--accent);">EPA/600/R-10/023F</a></p>
                <p class="pollutant-note">⚠️ No WV state standard exists</p>
            </div>
            <div class="pollutant-card warning">
                <p class="pollutant-name">Selenium</p>
                <p class="pollutant-rate">15.1%</p>
                <p class="pollutant-context">Mobilized by surface mining — rising trend</p>
                <div class="pollutant-bar"><div class="pollutant-fill" style="width: 15.1%"></div></div>
                <p class="pollutant-standard">Standard: 0.005 mg/L</p>
            </div>
            <div class="pollutant-card improving">
                <p class="pollutant-name">Iron, Total</p>
                <p class="pollutant-rate">8.7%</p>
                <p class="pollutant-context">Improving with AMD treatment systems</p>
                <div class="pollutant-bar"><div class="pollutant-fill" style="width: 8.7%"></div></div>
                <p class="pollutant-standard">Standard: 1.5 mg/L</p>
            </div>
            <div class="pollutant-card improving">
                <p class="pollutant-name">Aluminum, Dissolved</p>
                <p class="pollutant-rate">0.5%</p>
                <p class="pollutant-context">Generally meeting criteria</p>
                <div class="pollutant-bar"><div class="pollutant-fill" style="width: 0.5%"></div></div>
                <p class="pollutant-standard">Standard: 0.75 mg/L</p>
            </div>
        </div>
    </section>

    <!-- Chapter 3: The Data -->
    <section class="chapter reveal" id="data">
        <p class="chapter-label">Chapter 3</p>
        <h2 class="chapter-title">55 Years of Watching the Water</h2>
        <p class="chapter-lead">This analysis draws on one of the longest continuous water quality records in Appalachia—spanning from pre-Clean Water Act baseline through modern intensive monitoring.</p>

        <div class="photo-feature" style="margin-bottom: 3rem;">
            <img src="images/img_0028.jpg" alt="Kayak view of the Guyandotte River approaching a bridge">
            <div class="photo-feature-caption">
                <p>The Guyandotte River near Huntington, where it joins the Ohio—the endpoint of a 55-year monitoring journey.</p>
            </div>
        </div>

        <div style="display: grid; grid-template-columns: 1fr 2fr; gap: 4rem; align-items: start; margin-top: 3rem;">
            <div>
                <div class="big-number">1970</div>
                <p class="big-number-label">First samples collected—two years before the Clean Water Act reshaped American environmental law</p>

                <div style="margin-top: 3rem;">
                    <div class="big-number">2025</div>
                    <p class="big-number-label">Most recent data—monitoring continues through September</p>
                </div>
            </div>

            <div class="timeline">
                <div class="timeline-item highlight">
                    <div class="timeline-dot"></div>
                    <p class="timeline-year">1970</p>
                    <p class="timeline-title">Monitoring Begins</p>
                    <p class="timeline-desc">First water quality samples establish pre-regulatory baseline. These early measurements capture conditions before modern pollution controls—essential context for measuring progress.</p>
                </div>
                <div class="timeline-item highlight">
                    <div class="timeline-dot"></div>
                    <p class="timeline-year">1972</p>
                    <p class="timeline-title">Clean Water Act Enacted</p>
                    <p class="timeline-desc">Federal framework for water pollution control. Sets goal of "fishable, swimmable" waters nationwide and creates the <span class="glossary-term" data-definition="National Pollutant Discharge Elimination System — the permit program that regulates point source discharges (pipes, outfalls) to US waters. Every discharge requires an NPDES permit with specific limits.">NPDES</span> permit system for point source discharges.</p>
                </div>
                <div class="timeline-item">
                    <div class="timeline-dot"></div>
                    <p class="timeline-year">1977</p>
                    <p class="timeline-title"><span class="glossary-term" data-definition="Surface Mining Control and Reclamation Act (1977) — federal law requiring coal operators to restore mined land to its original contour and establish a fund (from mining fees) to reclaim abandoned mines.">SMCRA</span> Passed</p>
                    <p class="timeline-desc">Surface Mining Control and Reclamation Act requires coal operators to restore mined land and control sediment—critical for Appalachian watersheds like the Guyandotte.</p>
                </div>
                <div class="timeline-item">
                    <div class="timeline-dot"></div>
                    <p class="timeline-year">1987</p>
                    <p class="timeline-title">Water Quality Act</p>
                    <p class="timeline-desc">Strengthens nonpoint source controls and establishes the Section 319 grant program for watershed restoration projects.</p>
                </div>
                <div class="timeline-item highlight">
                    <div class="timeline-dot"></div>
                    <p class="timeline-year">2000s</p>
                    <p class="timeline-title">TMDL Program Expansion</p>
                    <p class="timeline-desc">EPA consent decree drives intensive monitoring to support impaired waters listings. Sampling frequency increases dramatically.</p>
                </div>
                <div class="timeline-item">
                    <div class="timeline-dot"></div>
                    <p class="timeline-year">2010s</p>
                    <p class="timeline-title">Monitoring Intensification</p>
                    <p class="timeline-desc">59% of all historical samples collected in this decade. Selenium monitoring expanded as surface mining impacts become apparent.</p>
                </div>
                <div class="timeline-item highlight">
                    <div class="timeline-dot"></div>
                    <p class="timeline-year">2022</p>
                    <p class="timeline-title">TMDL Report Approved</p>
                    <p class="timeline-desc">EPA approves comprehensive Lower Guyandotte TMDL addressing fecal coliform, iron, aluminum, selenium, and biological impairments.</p>
                </div>
            </div>
        </div>

        <div class="divider"></div>

        <h3 style="font-family: 'Newsreader', serif; font-size: 1.5rem; margin-bottom: 1.5rem;">Sampling Intensity by Decade</h3>
        <p class="prose" style="margin-bottom: 2rem;">The monitoring record isn't uniform—sampling intensified dramatically after 2000 as the TMDL program expanded. Over three-quarters of all data comes from 2010 onward, providing high-resolution insight into recent conditions while earlier decades establish longer-term context.</p>

        <div style="max-width: 600px;">
            <div style="display: grid; gap: 0.75rem;">
                <div style="display: grid; grid-template-columns: 70px 1fr 90px; align-items: center; gap: 1rem;">
                    <span class="mono" style="font-size: 0.85rem; color: var(--text-dim);">1970s</span>
                    <div style="height: 8px; background: var(--dark); border-radius: 4px; overflow: hidden;">
                        <div style="width: 11%; height: 100%; background: linear-gradient(90deg, var(--accent-dim), var(--accent)); border-radius: 4px;"></div>
                    </div>
                    <span class="mono" style="font-size: 0.8rem; color: var(--slate); text-align: right;">6,673</span>
                </div>
                <div style="display: grid; grid-template-columns: 70px 1fr 90px; align-items: center; gap: 1rem;">
                    <span class="mono" style="font-size: 0.85rem; color: var(--text-dim);">1980s</span>
                    <div style="height: 8px; background: var(--dark); border-radius: 4px; overflow: hidden;">
                        <div style="width: 7%; height: 100%; background: linear-gradient(90deg, var(--accent-dim), var(--accent)); border-radius: 4px;"></div>
                    </div>
                    <span class="mono" style="font-size: 0.8rem; color: var(--slate); text-align: right;">4,268</span>
                </div>
                <div style="display: grid; grid-template-columns: 70px 1fr 90px; align-items: center; gap: 1rem;">
                    <span class="mono" style="font-size: 0.85rem; color: var(--text-dim);">1990s</span>
                    <div style="height: 8px; background: var(--dark); border-radius: 4px; overflow: hidden;">
                        <div style="width: 6%; height: 100%; background: linear-gradient(90deg, var(--accent-dim), var(--accent)); border-radius: 4px;"></div>
                    </div>
                    <span class="mono" style="font-size: 0.8rem; color: var(--slate); text-align: right;">3,482</span>
                </div>
                <div style="display: grid; grid-template-columns: 70px 1fr 90px; align-items: center; gap: 1rem;">
                    <span class="mono" style="font-size: 0.85rem; color: var(--text-dim);">2000s</span>
                    <div style="height: 8px; background: var(--dark); border-radius: 4px; overflow: hidden;">
                        <div style="width: 15%; height: 100%; background: linear-gradient(90deg, var(--accent-dim), var(--accent)); border-radius: 4px;"></div>
                    </div>
                    <span class="mono" style="font-size: 0.8rem; color: var(--slate); text-align: right;">8,936</span>
                </div>
                <div style="display: grid; grid-template-columns: 70px 1fr 90px; align-items: center; gap: 1rem;">
                    <span class="mono" style="font-size: 0.85rem; color: var(--text-dim);">2010s</span>
                    <div style="height: 8px; background: var(--dark); border-radius: 4px; overflow: hidden;">
                        <div style="width: 100%; height: 100%; background: linear-gradient(90deg, var(--accent-dim), var(--accent)); border-radius: 4px;"></div>
                    </div>
                    <span class="mono" style="font-size: 0.8rem; color: var(--slate); text-align: right;">60,599</span>
                </div>
                <div style="display: grid; grid-template-columns: 70px 1fr 90px; align-items: center; gap: 1rem;">
                    <span class="mono" style="font-size: 0.85rem; color: var(--text-dim);">2020s</span>
                    <div style="height: 8px; background: var(--dark); border-radius: 4px; overflow: hidden;">
                        <div style="width: 32%; height: 100%; background: linear-gradient(90deg, var(--accent-dim), var(--accent)); border-radius: 4px;"></div>
                    </div>
                    <span class="mono" style="font-size: 0.8rem; color: var(--slate); text-align: right;">19,576</span>
                </div>
            </div>
        </div>
    </section>

    <!-- Chapter 4: Findings -->
    <section class="full-section reveal" id="findings">
        <div class="full-section-inner">
            <p class="chapter-label">Chapter 4</p>
            <h2 class="chapter-title">What the Data Reveals</h2>
            <p class="chapter-lead" style="max-width: 700px;">After analyzing 103,534 samples against West Virginia <span class="glossary-term" data-definition="WV Legislative Rule 47-2: Water Quality Standards. Establishes numeric criteria for pollutants in state waters based on designated uses (aquatic life, recreation, drinking water).">47CSR2 standards</span>, clear patterns emerge: some pollutants are declining thanks to treatment efforts, while others demand renewed attention.</p>

            <div class="trends-split">
                <div class="trend-column good">
                    <div class="trend-header">
                        <div class="trend-icon">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
                                <polyline points="23 6 13.5 15.5 8.5 10.5 1 18"></polyline>
                            </svg>
                        </div>
                        <span class="trend-label">Improving Trends</span>
                    </div>
                    <ul class="trend-list">
                        <li class="trend-item">
                            <span class="trend-param">Aluminum, Total</span>
                            <span class="trend-value">-89.7%</span>
                        </li>
                        <li class="trend-item">
                            <span class="trend-param">Manganese</span>
                            <span class="trend-value">-67.7%</span>
                        </li>
                        <li class="trend-item">
                            <span class="trend-param">Iron, Total</span>
                            <span class="trend-value">-25.0%</span>
                        </li>
                        <li class="trend-item">
                            <span class="trend-param">Fecal Coliform</span>
                            <span class="trend-value">-3.2%</span>
                        </li>
                    </ul>
                    <p style="font-size: 0.85rem; color: var(--text-dim); margin-top: 1rem; line-height: 1.7;"><span class="glossary-term" data-definition="Acid Mine Drainage treatment systems use passive (constructed wetlands, limestone channels) or active (chemical dosing) methods to neutralize acid and precipitate dissolved metals before discharge.">AMD treatment systems</span> and <span class="glossary-term" data-definition="Financial guarantees required by SMCRA before mining permits are issued. Bonds ensure funds exist for land reclamation if operators abandon sites. Amounts based on estimated cleanup costs.">reclamation bonding</span> are paying off. Metal concentrations have dropped significantly since the 1970s.</p>
                </div>

                <div class="trend-column concern">
                    <div class="trend-header">
                        <div class="trend-icon">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
                                <polyline points="23 18 13.5 8.5 8.5 13.5 1 6"></polyline>
                            </svg>
                        </div>
                        <span class="trend-label">Concerning Trends</span>
                    </div>
                    <ul class="trend-list">
                        <li class="trend-item">
                            <span class="trend-param">Selenium, Total</span>
                            <span class="trend-value">+30.0%</span>
                        </li>
                    </ul>
                    <p style="font-size: 0.85rem; color: var(--text-dim); margin-top: 1rem; line-height: 1.7;"><span class="glossary-term" data-definition="A trace element naturally present in coal-bearing rock. Toxic to aquatic life at very low concentrations (5 µg/L). Unlike metals, selenium bioaccumulates through food chains, causing reproductive failure in fish.">Selenium</span> is <span class="glossary-term" data-definition="Released from rock into water through chemical weathering. Mining accelerates mobilization by exposing fresh rock surfaces to oxygen and precipitation.">mobilized</span> when <span class="glossary-term" data-definition="Rock and soil layers that must be removed to access coal seams. In Appalachia, overburden often contains selenium-bearing shales that release contaminants when exposed to weathering.">overburden</span> is exposed to air and water during <span class="glossary-term" data-definition="Mining method that removes vegetation, soil, and rock layers to expose coal seams. Creates large disturbed areas where weathering releases selenium and other contaminants into groundwater and streams.">surface mining</span>. Unlike acid drainage, it's not easily treated and <span class="glossary-term" data-definition="Accumulates in organisms faster than it can be eliminated. Selenium concentrations increase at each level of the food chain—algae to invertebrates to fish—reaching toxic levels in top predators.">bioaccumulates</span> in aquatic food chains.</p>
                </div>
            </div>

            <div class="divider"></div>

            <h3 style="font-family: 'Newsreader', serif; font-size: 1.75rem; margin-bottom: 1rem;">Validating the TMDL Report</h3>
            <p style="color: var(--text-dim); max-width: 700px; margin-bottom: 2rem;">How do our independent findings compare with the official 2022 TMDL assessment? The table below shows general alignment—with one notable exception.</p>

            <!-- Table Filters -->
            <div class="table-filters">
                <button class="table-filter-btn active" data-filter="all">All</button>
                <button class="table-filter-btn" data-filter="match">Consistent</button>
                <button class="table-filter-btn" data-filter="diff">Differences</button>
                <button class="table-filter-btn" data-filter="metals">Metals</button>
                <button class="table-filter-btn" data-filter="bacteria">Bacteria</button>
                <button class="table-filter-btn" data-filter="ions">Ions</button>
            </div>

            <div style="overflow-x: auto;">
                <table class="comparison-table" id="comparisonTable">
                    <thead>
                        <tr>
                            <th>Parameter</th>
                            <th>Our Analysis</th>
                            <th>TMDL Report</th>
                            <th>Assessment</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr data-category="bacteria diff">
                            <td><strong>Fecal Coliform</strong></td>
                            <td>38.4% violations<br><span style="color: var(--slate);"><span class="glossary-term" data-definition="Geometric mean: the nth root of the product of n values. Used for bacteria data because it's less affected by extreme spikes than arithmetic mean. Standard method for fecal coliform assessment.">Geomean</span>: 232 CFU/100mL</span></td>
                            <td>~30% violations<br><span style="color: var(--slate);">Primary impairment</span></td>
                            <td><span class="status-pill diff">Higher rate — method differences likely</span></td>
                        </tr>
                        <tr data-category="metals match">
                            <td><strong>Iron, Total</strong></td>
                            <td>8.7% violations<br><span style="color: var(--slate);">Trend: -25%</span></td>
                            <td>Improving trend<br><span style="color: var(--slate);">AMD treatment success</span></td>
                            <td><span class="status-pill match">Consistent</span></td>
                        </tr>
                        <tr data-category="metals match">
                            <td><strong>Aluminum</strong></td>
                            <td>0.5% violations<br><span style="color: var(--slate);">Trend: -89.7%</span></td>
                            <td>Generally compliant<br><span style="color: var(--slate);">Below criteria</span></td>
                            <td><span class="status-pill match">Consistent</span></td>
                        </tr>
                        <tr data-category="metals match">
                            <td><strong>Selenium</strong></td>
                            <td>15.1% violations<br><span style="color: var(--slate);">Trend: +30%</span></td>
                            <td>Increasing concern<br><span style="color: var(--slate);">Mining correlation</span></td>
                            <td><span class="status-pill match">Consistent</span></td>
                        </tr>
                        <tr data-category="ions match">
                            <td><strong>Specific Conductance</strong></td>
                            <td>46.0% violations<br><span style="color: var(--slate);">Mining indicator</span></td>
                            <td>Elevated throughout<br><span style="color: var(--slate);"><span class="glossary-term" data-definition="Total Dissolved Solids proxy: Specific conductance strongly correlates with TDS (r>0.95), making it a quick, inexpensive field measurement for estimating dissolved mineral content.">TDS proxy</span></span></td>
                            <td><span class="status-pill match">Consistent</span></td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </section>

    <!-- Chapter 5: Since 2022 -->
    <section class="chapter chapter-narrow reveal" id="since-2022">
        <p class="chapter-label">Chapter 5</p>
        <h2 class="chapter-title">Three Years Later</h2>
        <p class="chapter-lead">The 2022 TMDL report established the baseline. Our analysis includes three additional years of monitoring data through 2025. What's changed?</p>

        <div class="highlight-box" style="border-left-color: var(--coral); background: linear-gradient(135deg, rgba(231, 111, 81, 0.1) 0%, rgba(231, 111, 81, 0.05) 100%);">
            <p><strong>The headline:</strong> AMD remediation success continues, but selenium keeps rising and fecal coliform remains stubbornly high.</p>
        </div>

        <div class="prose">
            <h3 style="font-family: 'Newsreader', serif; font-size: 1.4rem; margin: 2.5rem 0 1rem; color: var(--coral);">What's Getting Worse</h3>

            <p><strong>Selenium (+30%)</strong> — The 2022 TMDL flagged selenium as an "increasing concern." Three more years of data confirm this trajectory. Selenium is mobilized when surface mining exposes <span class="glossary-term" data-definition="Geological layers containing coal deposits and associated rocks. In Appalachia, these strata often include selenium-rich black shales that release contaminants when disturbed by mining.">coal-bearing strata</span> to <span class="glossary-term" data-definition="Chemical and physical breakdown of rock by exposure to air, water, and temperature changes. Accelerated by mining, which exposes fresh rock surfaces to oxidation and precipitation.">weathering</span>, and unlike acid drainage, there's no simple treatment. It <span class="glossary-term" data-definition="Accumulates in organisms faster than it can be eliminated. Selenium concentrations increase at each level of the food chain—algae to invertebrates to fish—reaching toxic levels in top predators.">bioaccumulates</span> through <span class="glossary-term" data-definition="The sequence of organisms through which energy and nutrients flow: producers (algae) → primary consumers (insects) → secondary consumers (fish) → top predators. Contaminants concentrate at higher levels.">aquatic food chains</span>, causing <span class="glossary-term" data-definition="Selenium toxicity impairs egg development and larval survival in fish. Effects occur at tissue concentrations below water quality standards, making standard monitoring inadequate for detecting impacts.">reproductive failure in fish</span> at concentrations invisible to standard monitoring. The 15.1% violation rate of the 0.005 mg/L standard may understate ecological impact.</p>

            <!-- Selenium Trend Chart -->
            <div class="selenium-trend-container" style="margin: 2rem 0; padding: 1.5rem; background: rgba(42, 65, 88, 0.3); border-radius: 12px; border-left: 4px solid var(--coral);">
                <h4 style="font-family: 'JetBrains Mono', monospace; font-size: 0.75rem; text-transform: uppercase; letter-spacing: 0.1em; color: var(--coral); margin-bottom: 1rem;">Selenium Annual Time Series (1977-2025)</h4>
                <div style="display: grid; grid-template-columns: 1.2fr 0.8fr; gap: 2rem; align-items: center;">
                    <div style="height: 220px;">
                        <canvas id="seleniumTrendChart"></canvas>
                    </div>
                    <div class="selenium-stats" style="font-size: 0.85rem; color: var(--text-muted);">
                        <div style="display: grid; gap: 0.6rem;">
                            <div style="display: flex; justify-content: space-between; padding: 0.5rem; background: rgba(231, 111, 81, 0.1); border-radius: 6px;">
                                <span>First 3 Years (1977-83)</span>
                                <strong style="color: var(--text);">0.0005 mg/L</strong>
                            </div>
                            <div style="display: flex; justify-content: space-between; padding: 0.5rem; background: rgba(231, 111, 81, 0.2); border-radius: 6px;">
                                <span>Last 3 Years (2023-25)</span>
                                <strong style="color: var(--coral);">0.0005 mg/L</strong>
                            </div>
                            <div style="display: flex; justify-content: space-between; padding: 0.5rem; background: rgba(255, 255, 255, 0.05); border-radius: 6px;">
                                <span>WV Standard</span>
                                <strong style="color: var(--accent);">0.005 mg/L</strong>
                            </div>
                            <div style="display: flex; justify-content: space-between; padding: 0.5rem; background: rgba(244, 162, 97, 0.2); border-radius: 6px;">
                                <span>Non-Detect Rate</span>
                                <strong style="color: var(--amber);">100%</strong>
                            </div>
                            <div style="display: flex; justify-content: space-between; padding: 0.5rem; background: rgba(231, 111, 81, 0.15); border-radius: 6px;">
                                <span>Total Samples</span>
                                <strong style="color: var(--text);">2,279</strong>
                            </div>
                            <div style="margin-top: 0.25rem; padding: 0.6rem; background: rgba(244, 162, 97, 0.15); border-radius: 6px; border-left: 3px solid var(--amber);">
                                <span style="font-size: 0.75rem; color: var(--amber); line-height: 1.4;">⚠️ All values are <strong>below detection limits</strong>. Chart shows DL/2 substitutions—actual concentrations are lower. Trend reflects changing detection methods, not true concentration changes.</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <p><strong>Fecal Coliform (38.4% vs ~30%)</strong> — Our analysis shows a higher violation rate than the TMDL reported. This could reflect methodological differences, but may also indicate that <span class="glossary-term" data-definition="On-site wastewater treatment systems common in rural areas. Failing systems discharge untreated sewage containing bacteria and nutrients directly into groundwater and nearby streams.">septic system failures</span> and <span class="glossary-term" data-definition="Pollution from diffuse sources across the landscape: livestock waste, fertilizers, and sediment washing off farmland during rain events. Harder to control than point sources.">agricultural runoff</span> haven't improved as hoped. The <span class="glossary-term" data-definition="Geometric mean: the nth root of the product of n values. Used for bacteria because log-normal distributions make arithmetic means misleading. WV standard: 200 CFU/100mL geometric mean.">geometric mean</span> of 232 CFU/100mL still exceeds the 200 CFU/100mL standard.</p>
        </div>

        <div class="prose">
            <h3 style="font-family: 'Newsreader', serif; font-size: 1.4rem; margin: 2.5rem 0 1rem; color: var(--accent);">What's Getting Better</h3>

            <p><strong>Iron (-25%)</strong> — <span class="glossary-term" data-definition="Systems that neutralize acid and remove dissolved metals from mine drainage. Passive systems (wetlands, limestone beds) require minimal maintenance; active systems use chemical dosing for higher flows.">AMD treatment systems</span> installed over the past two decades continue to work. <span class="glossary-term" data-definition="The middle value when all measurements are sorted. More robust than mean for skewed environmental data—not influenced by extreme outliers.">Median</span> iron concentrations dropped from 0.97 mg/L in early decades to 0.25 mg/L recently—well below the 1.5 mg/L standard. The 8.7% violation rate reflects <span class="glossary-term" data-definition="Persistent pollution sources from historical mining before modern regulations. Abandoned mines and waste piles continue releasing contaminants decades after operations ceased.">legacy hotspots</span>, not watershed-wide failure.</p>

            <p><strong>Aluminum (-89.7%)</strong> — The most dramatic improvement. Total aluminum plummeted from 0.94 mg/L to 0.11 mg/L, with only 0.5% of dissolved aluminum samples exceeding standards. <span class="glossary-term" data-definition="Low-maintenance treatment systems that use natural processes: constructed wetlands, anoxic limestone drains, and settling ponds. Effective for moderate AMD flows with lower operational costs.">Passive treatment</span> and <span class="glossary-term" data-definition="Gradual improvement in water quality as disturbed sites stabilize over time. Vegetation regrowth, soil development, and reduced oxidation rates allow streams to recover without active intervention.">natural recovery</span> are succeeding.</p>

            <p><strong>Manganese (-67.7%)</strong> — Another AMD success story. Concentrations dropped from 0.15 mg/L to under 0.05 mg/L, with only 1.3% violations. <span class="glossary-term" data-definition="Natural processes that reduce contaminant concentrations: dilution, adsorption to sediments, precipitation, and microbial transformation. Often sufficient for metals at moderate concentrations.">Natural attenuation</span> and treatment are working.</p>
        </div>

        <div class="prose">
            <h3 style="font-family: 'Newsreader', serif; font-size: 1.4rem; margin: 2.5rem 0 1rem; color: var(--amber);">What Hasn't Changed</h3>

            <p><strong>Specific Conductance (46.0% violations)</strong> — The <span class="glossary-term" data-definition="Characteristic pattern of elevated conductivity, sulfate, and selenium that indicates mining-impacted water. Distinguished from natural mineral springs by the sulfate-conductivity correlation and presence of selenium.">mining signature</span> persists. High conductivity—driven by <span class="glossary-term" data-definition="Sulfate ions (SO₄²⁻) released when pyrite and other sulfide minerals oxidize. Primary driver of elevated conductivity in mining-impacted streams. No practical treatment exists at watershed scale.">dissolved sulfates</span> from exposed <span class="glossary-term" data-definition="Underground layers of coal formed from compressed ancient plant material. When exposed to air and water by mining, associated minerals oxidize, releasing sulfates, selenium, and metals.">coal seams</span>—remains elevated throughout mined areas. The strong <span class="glossary-term" data-definition="Pearson correlation coefficient (r) measures linear relationship strength. r=0.88 indicates very strong positive correlation—as conductance increases, sulfate increases proportionally.">correlation</span> between conductance and sulfate (r=0.88) confirms this is a mining impact, not natural geology. Unlike metals, there's no cost-effective treatment for <span class="glossary-term" data-definition="Dissolved charged particles (sulfate, chloride, calcium, magnesium) that increase conductivity. Cannot be removed by settling or conventional treatment—requires expensive reverse osmosis or ion exchange.">ionic pollution</span>.</p>

            <p><strong>Hot Acidity (100% violations)</strong> — Every sample with measurable <span class="glossary-term" data-definition="Total acid-generating potential measured after heating to oxidize dissolved metals (Fe²⁺, Mn²⁺, Al³⁺). Reveals latent acidity that will manifest as pH drops when metals oxidize and precipitate.">hot acidity</span> exceeds standards. This <span class="glossary-term" data-definition="Pollution from historical mining before environmental regulations. Abandoned mines, waste piles, and impoundments continue releasing contaminants for decades to centuries.">legacy indicator</span> of AMD remains, even as dissolved metals decline—a reminder that the underlying chemistry hasn't fully normalized.</p>
        </div>

        <div style="background: rgba(42, 65, 88, 0.3); border-radius: 12px; padding: 2rem; margin-top: 3rem;">
            <h4 style="font-family: 'JetBrains Mono', monospace; font-size: 0.75rem; text-transform: uppercase; letter-spacing: 0.1em; color: var(--accent); margin-bottom: 1rem;">The Bottom Line</h4>
            <p style="font-size: 1.05rem; color: var(--text); line-height: 1.8; margin: 0;">
                The 2022 TMDL's optimism about metals was warranted—Fe, Al, and Mn continue improving. But its concern about selenium was also justified and has proven prescient. The next TMDL cycle will likely need to prioritize selenium and conductivity over the legacy AMD parameters that are now largely controlled.
            </p>
        </div>
    </section>

    <!-- Chapter 6: Priority Areas -->
    <section class="chapter reveal" id="hotspots">
        <p class="chapter-label">Chapter 6</p>
        <h2 class="chapter-title">Where It Hurts Most</h2>
        <p class="chapter-lead">Not all subwatersheds are equal. Our analysis ranks each <span class="glossary-term" data-definition="HUC12 is a 12-digit Hydrologic Unit Code identifying small subwatersheds (typically 10,000-40,000 acres). The Lower Guyandotte contains 21 HUC12 subwatersheds.">HUC12</span> by a composite impairment score—flagging priority areas for restoration investment.</p>

        <div class="prose">
            <p>The impairment score weights violations by parameter severity and frequency. High scores indicate subwatersheds with <strong>multiple pollutants exceeding standards across many samples</strong>—the streams most in need of attention.</p>
        </div>

        <!-- Interactive HUC12 Map -->
        <div class="huc12-map-container">
            <div class="huc12-map-header">
                <span class="huc12-map-title">Interactive Subwatershed Map</span>
                <div class="huc12-map-legend">
                    <div class="legend-item">
                        <div class="legend-swatch" style="background: #e76f51;"></div>
                        <span>Critical (800+)</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-swatch" style="background: #f4a261;"></div>
                        <span>High (400-799)</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-swatch" style="background: #ffe66d;"></div>
                        <span>Elevated (200-399)</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-swatch" style="background: #4ecdc4;"></div>
                        <span>Moderate (&lt;200)</span>
                    </div>
                </div>
            </div>
            <div id="huc12Map"></div>
        </div>

        <div class="hotspot-list">
            <div class="hotspot-item" data-huc12="050701020403">
                <span class="hotspot-rank">1</span>
                <span class="hotspot-name">Davis Creek–Guyandotte River</span>
                <span class="hotspot-score">Score: 1,020</span>
            </div>
            <div class="hotspot-item" data-huc12="050701020302">
                <span class="hotspot-rank">2</span>
                <span class="hotspot-name">Ballard Fork–Mud River</span>
                <span class="hotspot-score">Score: 912</span>
            </div>
            <div class="hotspot-item" data-huc12="050701020102">
                <span class="hotspot-rank">3</span>
                <span class="hotspot-name">Crawley Creek–Guyandotte River</span>
                <span class="hotspot-score">Score: 759</span>
            </div>
            <div class="hotspot-item" data-huc12="050701020103">
                <span class="hotspot-rank">4</span>
                <span class="hotspot-name">Big Harts Creek</span>
                <span class="hotspot-score">Score: 365</span>
            </div>
            <div class="hotspot-item" data-huc12="050701020304">
                <span class="hotspot-rank">5</span>
                <span class="hotspot-name">Big Creek–Mud River</span>
                <span class="hotspot-score">Score: 346</span>
            </div>
            <div class="hotspot-item" data-huc12="050701020309">
                <span class="hotspot-rank">6</span>
                <span class="hotspot-name">Merrick Creek–Mud River</span>
                <span class="hotspot-score">Score: 283</span>
            </div>
            <div class="hotspot-item" data-huc12="050701020105">
                <span class="hotspot-rank">7</span>
                <span class="hotspot-name">Fourteenmile Creek–Guyandotte River</span>
                <span class="hotspot-score">Score: 260</span>
            </div>
            <div class="hotspot-item" data-huc12="050701020101">
                <span class="hotspot-rank">8</span>
                <span class="hotspot-name">Big Creek</span>
                <span class="hotspot-score">Score: 240</span>
            </div>
            <div class="hotspot-item" data-huc12="050701020402">
                <span class="hotspot-rank">9</span>
                <span class="hotspot-name">Smith Creek–Guyandotte River</span>
                <span class="hotspot-score">Score: 213</span>
            </div>
            <div class="hotspot-item" data-huc12="050701020303">
                <span class="hotspot-rank">10</span>
                <span class="hotspot-name">Middle Fork Mud River</span>
                <span class="hotspot-score">Score: 203</span>
            </div>
        </div>

        <div class="highlight-box" style="margin-top: 3rem;">
            <p>The top three subwatersheds account for <strong>45% of total watershed impairment</strong>. Targeted restoration here would yield disproportionate water quality gains.</p>
        </div>

        <!-- Interactive HUC12 Map -->
        <div class="huc12-interactive-map">
            <div class="huc12-map-header">
                <h4 class="huc12-map-title">Interactive Impairment Map</h4>
                <div class="huc12-map-legend">
                    <div class="legend-item">
                        <div class="legend-swatch" style="background: #ef4444;"></div>
                        <span>Critical (>500)</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-swatch" style="background: #f59e0b;"></div>
                        <span>High (300-500)</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-swatch" style="background: #eab308;"></div>
                        <span>Moderate (200-300)</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-swatch" style="background: #4ecdc4;"></div>
                        <span>Lower (<200)</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-swatch" style="background: transparent; border: 2px solid #ef4444;"></div>
                        <span>Court Order</span>
                    </div>
                </div>
            </div>
            <div id="huc12InteractiveMap"></div>
        </div>
    </section>

    <!-- Court Order Streams Section -->
    <section class="full-section reveal" id="court-order">
        <div class="full-section-inner">
            <p class="chapter-label">Legal Action</p>
            <h2 class="chapter-title" style="color: var(--coral);">Federal Consent Decree — Ionic Toxicity TMDLs Required</h2>
            <p class="chapter-lead">These 11 streams are subject to <strong>Case 3:24-cv-00130</strong> (U.S. District Court, S.D. West Virginia), a consent decree filed November 6, 2024. WVDEP must release draft <span class="glossary-term" data-definition="Total Maximum Daily Load — a calculation of the maximum pollution a waterway can receive while still meeting standards. Includes waste load allocations for permitted sources.">Ionic Toxicity TMDLs</span> by <strong>May 1, 2026</strong> and submit final TMDLs to EPA by <strong>September 1, 2026</strong>.</p>

            <div class="court-streams-grid">
                <div class="court-stream-item">
                    <span class="court-icon">⚖️</span>
                    <span class="court-stream-name">Upper Mud River</span>
                    <span class="court-code">WV-OGL-10</span>
                </div>
                <div class="court-stream-item">
                    <span class="court-icon">⚖️</span>
                    <span class="court-stream-name">Sugartree Branch</span>
                    <span class="court-code">WV-OGL-10-DW</span>
                </div>
                <div class="court-stream-item">
                    <span class="court-icon">⚖️</span>
                    <span class="court-stream-name">Stanley Fork</span>
                    <span class="court-code">WV-OGL-10-DX</span>
                </div>
                <div class="court-stream-item">
                    <span class="court-icon">⚖️</span>
                    <span class="court-stream-name">Ballard Fork</span>
                    <span class="court-code">WV-OGL-10-EA</span>
                </div>
                <div class="court-stream-item">
                    <span class="court-icon">⚖️</span>
                    <span class="court-stream-name">Big Ugly Creek</span>
                    <span class="court-code">WV-OGL-89</span>
                </div>
                <div class="court-stream-item">
                    <span class="court-icon">⚖️</span>
                    <span class="court-stream-name">Limestone Branch</span>
                    <span class="court-code">WV-OGL-111</span>
                </div>
                <div class="court-stream-item">
                    <span class="court-icon">⚖️</span>
                    <span class="court-stream-name">Ed Stone Branch</span>
                    <span class="court-code">WV-OGL-112-D</span>
                </div>
                <div class="court-stream-item">
                    <span class="court-icon">⚖️</span>
                    <span class="court-stream-name">Crawley Creek</span>
                    <span class="court-code">WV-OGL-117</span>
                </div>
                <div class="court-stream-item">
                    <span class="court-icon">⚖️</span>
                    <span class="court-stream-name">South Fork Crawley Creek</span>
                    <span class="court-code">WV-OGL-117-M</span>
                </div>
                <div class="court-stream-item">
                    <span class="court-icon">⚖️</span>
                    <span class="court-stream-name">Rocky Branch</span>
                    <span class="court-code">WV-OGL-130</span>
                </div>
                <div class="court-stream-item">
                    <span class="court-icon">⚖️</span>
                    <span class="court-stream-name">Merrick Creek</span>
                    <span class="court-code">WV-OGL-10-A</span>
                </div>
            </div>

            <!-- Overlap Analysis -->
            <div class="overlap-analysis">
                <h4>Overlap with Data-Driven Priorities</h4>
                <p>Comparing the 11 consent decree streams with our <a href="#hotspots" style="color: var(--accent);">Top 10 Impaired HUC12 analysis</a> reveals partial alignment:</p>
                <div class="overlap-grid">
                    <div class="overlap-stat match">
                        <span class="overlap-number">3</span>
                        <span class="overlap-label">Direct matches with Top 10</span>
                        <span class="overlap-detail">Ballard Fork (#2), Crawley Creek (#3), Merrick Creek (#6)</span>
                    </div>
                    <div class="overlap-stat related">
                        <span class="overlap-number">~6</span>
                        <span class="overlap-label">Within or tributary to Top 10</span>
                        <span class="overlap-detail">Including Upper Mud River tributaries and South Fork Crawley Creek</span>
                    </div>
                    <div class="overlap-stat unique">
                        <span class="overlap-number">5</span>
                        <span class="overlap-label">Not in Top 10 hotspots</span>
                        <span class="overlap-detail">Big Ugly Creek, Limestone Branch, Ed Stone Branch, Rocky Branch, others</span>
                    </div>
                </div>
                <p class="overlap-insight">This suggests the lawsuit captured streams beyond what violation-count scoring alone would prioritize—potentially reflecting on-the-ground conditions, community impacts, or specific polluter accountability not fully reflected in aggregate statistics.</p>
            </div>
        </div>
    </section>

    <!-- Chapter 7: Visualizations -->
    <section class="chapter reveal" id="evidence">
        <p class="chapter-label">Chapter 7</p>
        <h2 class="chapter-title">The Visual Evidence</h2>
        <p class="chapter-lead">Data visualizations generated from our Python analysis pipeline, applying WV 47CSR2 standards to 55 years of ambient monitoring data.</p>

        <!-- Plot Filters -->
        <div class="plot-filters">
            <button class="plot-filter-btn active" data-filter="all">All</button>
            <button class="plot-filter-btn" data-filter="violations">Violations</button>
            <button class="plot-filter-btn" data-filter="trends">Trends</button>
            <button class="plot-filter-btn" data-filter="mining">Mining</button>
            <button class="plot-filter-btn" data-filter="temporal">Temporal</button>
        </div>

        <div class="plot-grid">
            <div class="plot-card clickable" data-plot="exceedance" data-category="violations" onclick="openModal('exceedance')">
                <img src="wq_analysis_output_v2/plots/exceedance_summary.png" alt="% Violations" onerror="this.closest('.plot-card').style.display='none'">
                <div class="plot-tooltip">
                    <p class="plot-tooltip-label">Why it matters</p>
                    <p class="plot-tooltip-text">Parameters exceeding 10% are considered impaired under the Clean Water Act. Hot acidity (100%) and fecal coliform (38%) are the most urgent concerns requiring immediate regulatory attention.</p>
                    <p class="plot-tooltip-cta">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="11" cy="11" r="8"/><path d="m21 21-4.35-4.35"/></svg>
                        Click for data &amp; code
                    </p>
                </div>
                <p class="plot-caption">Parameter violation rates against WV water quality standards</p>
            </div>
            <div class="plot-card clickable" data-plot="trend" data-category="trends" onclick="openModal('trend')">
                <img src="wq_analysis_output_v2/plots/trend_summary.png" alt="Trend Summary" onerror="this.closest('.plot-card').style.display='none'">
                <div class="plot-tooltip">
                    <p class="plot-tooltip-label">Why it matters</p>
                    <p class="plot-tooltip-text">Dark bars show statistically significant trends. Green means pollution controls are working; red means conditions are worsening. The -89.7% aluminum drop proves AMD treatment is effective.</p>
                    <p class="plot-tooltip-cta">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="11" cy="11" r="8"/><path d="m21 21-4.35-4.35"/></svg>
                        Click for data &amp; code
                    </p>
                </div>
                <p class="plot-caption">Long-term concentration trends for key parameters</p>
            </div>
            <div class="plot-card clickable" data-plot="fecal" data-category="violations" onclick="openModal('fecal')">
                <img src="wq_analysis_output_v2/plots/fecal_coliform_detail.png" alt="Fecal Coliform" onerror="this.closest('.plot-card').style.display='none'">
                <div class="plot-tooltip">
                    <p class="plot-tooltip-label">Why it matters</p>
                    <p class="plot-tooltip-text">High bacteria levels indicate failing septic systems and agricultural runoff. The 232 CFU/100mL geometric mean exceeds the 200 standard—meaning swimming and fishing are unsafe at many sites.</p>
                    <p class="plot-tooltip-cta">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="11" cy="11" r="8"/><path d="m21 21-4.35-4.35"/></svg>
                        Click for data &amp; code
                    </p>
                </div>
                <p class="plot-caption">Fecal coliform distribution with regulatory thresholds</p>
            </div>
            <div class="plot-card clickable" data-plot="mining" data-category="mining" onclick="openModal('mining')">
                <img src="wq_analysis_output_v2/plots/mining_signature.png" alt="Mining Signature" onerror="this.closest('.plot-card').style.display='none'">
                <div class="plot-tooltip">
                    <p class="plot-tooltip-label">Why it matters</p>
                    <p class="plot-tooltip-text">The strong correlation (r=0.88) proves elevated conductivity comes from mining, not natural geology. This fingerprint identifies mining as the pollution source and assigns legal remediation responsibility.</p>
                    <p class="plot-tooltip-cta">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="11" cy="11" r="8"/><path d="m21 21-4.35-4.35"/></svg>
                        Click for data &amp; code
                    </p>
                </div>
                <p class="plot-caption">Specific conductance vs. sulfate — mining impact indicator</p>
            </div>
            <div class="plot-card clickable" data-plot="hotspots" data-category="violations" onclick="openModal('hotspots')">
                <img src="wq_analysis_output_v2/plots/huc12_hotspots.png" alt="HUC12 Hotspots" onerror="this.closest('.plot-card').style.display='none'">
                <div class="plot-tooltip">
                    <p class="plot-tooltip-label">Why it matters</p>
                    <p class="plot-tooltip-text">Restoration funding has the greatest impact in the most impaired areas. The top 3 subwatersheds account for 45% of total watershed impairment—targeting them yields disproportionate water quality gains.</p>
                    <p class="plot-tooltip-cta">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="11" cy="11" r="8"/><path d="m21 21-4.35-4.35"/></svg>
                        Click for data &amp; code
                    </p>
                </div>
                <p class="plot-caption">Subwatershed impairment severity ranking</p>
            </div>
            <div class="plot-card clickable" data-plot="temporal" data-category="temporal" onclick="openModal('temporal')">
                <img src="wq_analysis_output_v2/plots/temporal_coverage.png" alt="Temporal Coverage" onerror="this.closest('.plot-card').style.display='none'">
                <div class="plot-tooltip">
                    <p class="plot-tooltip-label">Why it matters</p>
                    <p class="plot-tooltip-text">59% of samples come from 2010-2019, when TMDL requirements drove intensive monitoring. Earlier decades provide baseline context but have fewer data points—trends are most reliable in the recent record.</p>
                    <p class="plot-tooltip-cta">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="11" cy="11" r="8"/><path d="m21 21-4.35-4.35"/></svg>
                        Click for data &amp; code
                    </p>
                </div>
                <p class="plot-caption">Sampling intensity and temporal coverage across decades</p>
            </div>
            <div class="plot-card clickable" data-plot="sc_trend" data-category="mining trends" onclick="openModal('sc_trend')">
                <img src="wq_analysis_output_v2/plots/sc_trend.png" alt="Specific Conductance Trend" onerror="this.closest('.plot-card').style.display='none'">
                <div class="plot-tooltip">
                    <p class="plot-tooltip-label">Why it matters</p>
                    <p class="plot-tooltip-text">Specific conductance is the single best indicator of mining impact. Unlike metals that can be treated, ionic pollution persists. The 46.0% violation rate shows mining's legacy remains even as AMD treatment succeeds.</p>
                    <p class="plot-tooltip-cta">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="11" cy="11" r="8"/><path d="m21 21-4.35-4.35"/></svg>
                        Click for data &amp; code
                    </p>
                </div>
                <p class="plot-caption">Specific conductance trend over time — mining impact indicator</p>
            </div>
        </div>
    </section>

    <!-- Chapter 8: Methodology -->
    <section class="chapter chapter-narrow reveal" id="methodology">
        <p class="chapter-label">Chapter 8</p>
        <h2 class="chapter-title">How We Did It</h2>
        <p class="chapter-lead">Transparent methodology matters. Here's how we processed the data and what standards we applied.</p>

        <div class="method-grid">
            <div class="method-card">
                <h4><span class="glossary-term tooltip-left" data-definition="West Virginia Legislative Rule 47-2: Water Quality Standards. Establishes designated uses, numeric criteria, and antidegradation policies for state waters. Updated periodically through EPA-approved triennial review.">WV 47CSR2 Standards</span></h4>
                <p>Applied West Virginia-specific criteria: <code><span class="glossary-term" data-definition="Iron standard of 1.5 mg/L (total recoverable) applies to aquatic life use. Higher than EPA's 1.0 mg/L recommendation, reflecting regional geology. Exceedances indicate AMD impacts.">Fe: 1.5 mg/L</span></code>, <code><span class="glossary-term" data-definition="pH range 6.0–9.0 protects aquatic life. Values below 6.0 indicate acid stress; above 9.0 indicates alkaline conditions. Both extremes harm fish reproduction and macroinvertebrates.">pH: 6.0–9.0</span></code>, <code><span class="glossary-term" data-definition="Dissolved aluminum standard of 0.75 mg/L protects aquatic life from gill damage. More stringent than total aluminum because dissolved forms are more bioavailable and toxic.">Al dissolved: 0.75 mg/L</span></code>—not generic EPA values.</p>
            </div>
            <div class="method-card">
                <h4><span class="glossary-term tooltip-left" data-definition="Ambient monitoring measures background water quality in streams, separate from point source discharge monitoring at permitted outfalls. Required for 305(b) assessments and 303(d) impaired waters listings.">Ambient Data Only</span></h4>
                <p>Filtered to exclude <span class="glossary-term" data-definition="Point sources are discrete, identifiable pollution sources like pipes and outfalls regulated under NPDES permits. Distinct from nonpoint sources like agricultural runoff or abandoned mine drainage.">point source</span> discharge monitoring. Only ambient stream samples used for assessment—identified by <span class="glossary-term" data-definition="Assessment Unit ID: unique identifier for water body segments evaluated under Clean Water Act Section 305(b). Format encodes watershed, stream name, and segment boundaries.">AU_ID</span> patterns.</p>
            </div>
            <div class="method-card">
                <h4><span class="glossary-term tooltip-left" data-definition="Non-detect handling addresses measurements reported as below detection limit (e.g., '<0.01'). Simple substitution methods (0, DL/2) can bias statistics; survival analysis methods are preferred.">Non-Detect Handling</span></h4>
                <p><span class="glossary-term" data-definition="Left-censored data occurs when measurements are below the detection limit (e.g., '<0.01 mg/L'). The true value is unknown but less than the limit. Common in environmental monitoring where concentrations approach instrument sensitivity.">Left-censored data</span> processed with <code><span class="glossary-term" data-definition="Kaplan-Meier estimator: non-parametric statistic borrowed from medical survival analysis. Properly handles censored data by estimating the survival function. For water quality, estimates distribution of concentrations when some values are below detection limits. Reference: Helsel (2012) Statistics for Censored Environmental Data.">Kaplan-Meier</span></code> survival analysis. <span class="glossary-term" data-definition="DL/2 substitution replaces non-detects with half the detection limit. Simple but can bias results when non-detect rate exceeds 15%. Used here only for trend analysis where Kaplan-Meier isn't applicable.">Half-detection-limit substitution</span> for trend analysis.</p>
            </div>
            <div class="method-card">
                <h4><span class="glossary-term tooltip-left" data-definition="Fecal coliform bacteria indicate fecal contamination from humans or warm-blooded animals. WV uses a two-part standard: geometric mean for chronic exposure and single-sample max for acute risk.">Fecal Coliform Protocol</span></h4>
                <p>Two-part standard: <code><span class="glossary-term" data-definition="200 CFU/100mL geometric mean standard: applies to the average of at least 5 samples over 30 days at a single station. Protects against chronic exposure during water contact recreation.">200 CFU/100mL</span></code> <span class="glossary-term" data-definition="Geometric mean: the nth root of the product of n values. Formula: (x₁ × x₂ × ... × xₙ)^(1/n). Used for bacteria because log-normal distributions span orders of magnitude. Less sensitive to outliers than arithmetic mean.">geometric mean</span> per station plus <code><span class="glossary-term" data-definition="400 CFU/100mL single-sample maximum: no individual sample should exceed this value. Protects against acute illness from short-term high exposure. More protective than EPA's 410 CFU/100mL recommendation.">400 CFU/100mL</span></code> single-sample max.</p>
            </div>
            <div class="method-card">
                <h4><span class="glossary-term tooltip-left" data-definition="Trend analysis detects whether water quality is improving, degrading, or stable over time. Uses non-parametric methods that don't require normally distributed data—essential for environmental monitoring with outliers and seasonality.">Trend Analysis</span></h4>
                <p><span class="glossary-term" data-definition="Mann-Kendall test: non-parametric hypothesis test for monotonic trend. Compares all pairs of observations to count concordant vs discordant pairs. Robust to outliers, missing data, and non-normal distributions. Reference: Mann (1945), Kendall (1975).">Mann-Kendall</span> test for <span class="glossary-term" data-definition="Monotonic trend: consistently increasing or decreasing over time (not necessarily linear). Distinguished from step changes or cyclical patterns. Mann-Kendall tests the null hypothesis of no monotonic trend.">monotonic trends</span>. <span class="glossary-term" data-definition="Sen's slope estimator: calculates the median of slopes between all pairs of points. Formula: median of (yⱼ - yᵢ)/(xⱼ - xᵢ) for all i < j. Robust to outliers—up to 29% of data can be outliers without affecting the estimate. Reference: Sen (1968).">Sen's slope</span> for magnitude. Significance at <code><span class="glossary-term" data-definition="p < 0.05 means less than 5% probability the observed trend occurred by chance. Standard threshold for statistical significance. Trends with p ≥ 0.05 are not statistically distinguishable from random variation.">p &lt; 0.05</span></code>.</p>
            </div>
            <div class="method-card">
                <h4>Trend Assumptions & Limitations</h4>
                <p>Assumes monotonic trends (no reversals). Sensitive to serial correlation. DL/2 substitution for non-detects introduces uncertainty when censoring >15%. Uneven sampling intensity may bias early-period estimates. Seasonal adjustment not applied—interpret with caution.</p>
            </div>
            <div class="method-card">
                <h4><span class="glossary-term tooltip-left" data-definition="Impairment scoring ranks subwatersheds by pollution severity to prioritize restoration funding. Combines multiple parameters into a single composite score reflecting overall water quality degradation.">Impairment Scoring</span></h4>
                <p>Composite score per <span class="glossary-term" data-definition="HUC12: 12-digit Hydrologic Unit Code identifying small subwatersheds (avg. 24,000 acres). The finest scale in the USGS hierarchical watershed classification system. 21 HUC12s in the Lower Guyandotte.">HUC12</span> weighting <span class="glossary-term" data-definition="Parameter-specific violations: count of samples exceeding the applicable water quality standard for each pollutant. Normalized by sample count to calculate violation rate (%).">parameter-specific violations</span> by <span class="glossary-term" data-definition="Ecological severity weighting: multipliers reflecting relative harm to aquatic life. Fecal coliform weighted lower (human health risk) than metals (direct aquatic toxicity). Hot acidity weighted highest (watershed-scale impact).">ecological severity</span> and <span class="glossary-term" data-definition="Sample frequency weighting: accounts for monitoring intensity differences between subwatersheds. Prevents well-monitored areas from appearing more impaired simply due to more data points.">sample frequency</span>.</p>
            </div>
        </div>
    </section>

    <!-- CTA Section -->
    <section class="cta-section reveal" id="action">
        <h2 class="cta-title" style="position: relative; z-index: 1;">The Path Forward</h2>
        <p style="color: var(--text-dim); max-width: 600px; margin: 0 auto; position: relative; z-index: 1;">
            80% of assessment units in the Lower Guyandotte are impaired. But the data also shows progress—metals declining, treatment working. The challenge now is sustaining momentum while addressing emerging concerns like selenium.
        </p>
        <div class="cta-buttons" style="position: relative; z-index: 1;">
            <a href="https://dep.wv.gov/WWE/watershed/TMDL/Pages/default.aspx" class="btn btn-primary" target="_blank">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                    <polyline points="14 2 14 8 20 8"></polyline>
                </svg>
                Official TMDL Documents
            </a>
            <a href="https://github.com/crackedcoco/lower-guyandotte-wq-analysis" class="btn btn-secondary" target="_blank">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37 0 0 0-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44 0 0 0 20 4.77 5.07 5.07 0 0 0 19.91 1S18.73.65 16 2.48a13.38 13.38 0 0 0-7 0C6.27.65 5.09 1 5.09 1A5.07 5.07 0 0 0 5 4.77a5.44 5.44 0 0 0-1.5 3.78c0 5.42 3.3 6.61 6.44 7A3.37 3.37 0 0 0 9 18.13V22"></path>
                </svg>
                View Analysis Code
            </a>
            <a href="mailto:depwqsas@wv.gov" class="btn btn-secondary">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"></path>
                    <polyline points="22,6 12,13 2,6"></polyline>
                </svg>
                Contact WV DEP
            </a>
        </div>
    </section>

    <!-- Distribution Histograms Section -->
    <section class="histogram-section reveal" id="histograms">
        <div style="max-width: 1200px; margin: 0 auto; padding: 0 2rem;">
            <p class="chapter-label">Interactive Analysis</p>
            <h2 class="chapter-title">Parameter Distributions</h2>
            <p class="chapter-lead">Explore concentration distributions for key water quality parameters. Toggle between linear and log scales to see patterns in the data.</p>

            <!-- Date Range Filter -->
            <div class="date-range-filter">
                <div class="date-range-header">
                    <span class="date-range-label">Filter by Year Range</span>
                    <span class="date-range-value" id="dateRangeValue">1970 – 2025</span>
                </div>
                <div class="date-range-slider-container">
                    <input type="range" id="dateRangeMin" class="date-slider" min="1970" max="2025" value="1970">
                    <input type="range" id="dateRangeMax" class="date-slider" min="1970" max="2025" value="2025">
                    <div class="slider-track"></div>
                    <div class="slider-range" id="sliderRange"></div>
                </div>
                <div class="date-range-presets">
                    <button class="preset-btn" data-start="1970" data-end="2025">All Data</button>
                    <button class="preset-btn" data-start="1970" data-end="1989">1970s–80s</button>
                    <button class="preset-btn" data-start="1990" data-end="2009">1990s–00s</button>
                    <button class="preset-btn" data-start="2010" data-end="2025">2010–Present</button>
                    <button class="preset-btn" data-start="2022" data-end="2025">Since TMDL</button>
                </div>
                <p class="date-range-note">Histogram data updates dynamically based on selected range. Sample counts shown reflect filtered data.</p>
            </div>
        </div>
        <div class="histogram-grid">
            <!-- Fecal Coliform -->
            <div class="histogram-card">
                <h4>Fecal Coliform</h4>
                <div class="param-stats">
                    <span>n = 4,834</span>
                    <span>Median: 254 CFU/100mL</span>
                    <span>38.4% violations</span>
                </div>
                <canvas id="histFecal" class="histogram-canvas"></canvas>
                <div class="histogram-controls">
                    <button class="histogram-btn active" onclick="updateHistogram('histFecal', 'linear')">Linear</button>
                    <button class="histogram-btn" onclick="updateHistogram('histFecal', 'log')">Log Scale</button>
                </div>
            </div>
            <!-- Specific Conductance -->
            <div class="histogram-card">
                <h4>Specific Conductance</h4>
                <div class="param-stats">
                    <span>n = 7,164</span>
                    <span>Median: 326 µS/cm</span>
                    <span>46.0% violations</span>
                </div>
                <canvas id="histSC" class="histogram-canvas"></canvas>
                <div class="histogram-controls">
                    <button class="histogram-btn active" onclick="updateHistogram('histSC', 'linear')">Linear</button>
                    <button class="histogram-btn" onclick="updateHistogram('histSC', 'log')">Log Scale</button>
                </div>
            </div>
            <!-- Iron -->
            <div class="histogram-card">
                <h4>Iron (Total)</h4>
                <div class="param-stats">
                    <span>n = 4,690</span>
                    <span>Median: 0.25 mg/L</span>
                    <span>8.7% violations</span>
                </div>
                <canvas id="histFe" class="histogram-canvas"></canvas>
                <div class="histogram-controls">
                    <button class="histogram-btn active" onclick="updateHistogram('histFe', 'linear')">Linear</button>
                    <button class="histogram-btn" onclick="updateHistogram('histFe', 'log')">Log Scale</button>
                </div>
            </div>
            <!-- pH -->
            <div class="histogram-card">
                <h4>pH</h4>
                <div class="param-stats">
                    <span>n = 6,391</span>
                    <span>Median: 7.7 SU</span>
                    <span>1.0% violations</span>
                </div>
                <canvas id="histPH" class="histogram-canvas"></canvas>
                <div class="histogram-controls">
                    <button class="histogram-btn active" onclick="updateHistogram('histPH', 'linear')">Linear</button>
                    <button class="histogram-btn" onclick="updateHistogram('histPH', 'log')">Log Scale</button>
                </div>
            </div>
            <!-- Sulfate -->
            <div class="histogram-card">
                <h4>Sulfate (SO4)</h4>
                <div class="param-stats">
                    <span>n = 2,553</span>
                    <span>Median: 85 mg/L</span>
                    <span>18.4% violations</span>
                </div>
                <canvas id="histSO4" class="histogram-canvas"></canvas>
                <div class="histogram-controls">
                    <button class="histogram-btn active" onclick="updateHistogram('histSO4', 'linear')">Linear</button>
                    <button class="histogram-btn" onclick="updateHistogram('histSO4', 'log')">Log Scale</button>
                </div>
            </div>
            <!-- Selenium -->
            <div class="histogram-card">
                <h4>Selenium (Total)</h4>
                <div class="param-stats">
                    <span>n = 2,210</span>
                    <span>Median: 0.001 mg/L</span>
                    <span>15.1% violations</span>
                </div>
                <canvas id="histSe" class="histogram-canvas"></canvas>
                <div class="histogram-controls">
                    <button class="histogram-btn active" onclick="updateHistogram('histSe', 'linear')">Linear</button>
                    <button class="histogram-btn" onclick="updateHistogram('histSe', 'log')">Log Scale</button>
                </div>
            </div>
        </div>
    </section>

    <!-- Crosstab Analysis Section -->
    <section class="crosstab-section reveal" id="crosstab">
        <div style="max-width: 1200px; margin: 0 auto; padding: 0 2rem;">
            <p class="chapter-label">Interactive Analysis</p>
            <h2 class="chapter-title">Parameter Correlations</h2>
            <p class="chapter-lead">Explore relationships between water quality parameters. The SC vs Sulfate correlation (r=0.88) is the classic "mining signature" showing pollution source.</p>

            <div class="crosstab-controls">
                <div class="crosstab-select-group">
                    <label for="crosstabPair">Select Parameter Pair</label>
                    <select id="crosstabPair" class="crosstab-select">
                        <option value="sc_vs_sulfate">Specific Conductance vs Sulfate (Mining Signature)</option>
                        <option value="sc_vs_iron">Specific Conductance vs Iron</option>
                        <option value="ph_vs_iron">pH vs Iron (AMD Indicator)</option>
                        <option value="ph_vs_aluminum">pH vs Aluminum</option>
                        <option value="sulfate_vs_selenium">Sulfate vs Selenium</option>
                        <option value="fecal_vs_do">Fecal Coliform vs DO</option>
                    </select>
                </div>
                <div class="crosstab-stats" id="crosstabStats">
                    <div class="stat-item">
                        <span class="stat-label">Correlation (r)</span>
                        <span class="stat-value" id="crosstabCorr">—</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-label">Samples</span>
                        <span class="stat-value" id="crosstabN">—</span>
                    </div>
                </div>
            </div>

            <div class="crosstab-chart-container">
                <canvas id="crosstabChart"></canvas>
            </div>

            <div class="crosstab-interpretation" id="crosstabInterpretation">
                <p><strong>Mining Signature:</strong> The strong positive correlation between specific conductance and sulfate demonstrates that elevated ionic pollution originates from mining activities. When pyrite in coal seams oxidizes, it produces sulfuric acid and dissolved minerals—this fingerprint assigns source responsibility.</p>
            </div>
        </div>
    </section>

    <!-- Parameter Interpretation Guide -->
    <section class="param-guide-section reveal" id="param-guide">
        <p class="chapter-label">Reference</p>
        <h2 class="chapter-title">Parameter Interpretation Guide</h2>
        <p class="chapter-lead">Understanding what each parameter means, where it comes from, and what can be done about it.</p>

        <div class="param-guide-grid">
            <!-- Fecal Coliform -->
            <div class="param-guide-card">
                <div class="param-guide-header">
                    <div class="param-guide-icon bacteria">🦠</div>
                    <div>
                        <h4>Fecal Coliform</h4>
                        <div class="standard">Standard: 200 CFU/100mL (geomean) | 400 CFU/100mL (max)</div>
                    </div>
                </div>
                <p>Bacteria indicating presence of human or animal waste. High levels make water unsafe for swimming and can cause gastrointestinal illness. Not always pathogenic themselves, but signal presence of more dangerous organisms.</p>
                <div class="param-guide-tags">
                    <span class="param-tag source">Septic systems</span>
                    <span class="param-tag source">Agricultural runoff</span>
                    <span class="param-tag impact">Human health risk</span>
                    <span class="param-tag solution">Septic upgrades</span>
                </div>
            </div>

            <!-- Specific Conductance -->
            <div class="param-guide-card">
                <div class="param-guide-header">
                    <div class="param-guide-icon ions">⚡</div>
                    <div>
                        <h4>Specific Conductance</h4>
                        <div class="standard">Benchmark: 300 µS/cm (EPA aquatic life)</div>
                    </div>
                </div>
                <p>Measures dissolved ions in water—the electrical conductivity. Elevated SC in Appalachia strongly correlates with surface mining. Unlike metals that can be treated, ionic pollution from mining persists for decades.</p>
                <div class="param-guide-tags">
                    <span class="param-tag source">Surface mining</span>
                    <span class="param-tag source">Valley fills</span>
                    <span class="param-tag impact">Aquatic life stress</span>
                    <span class="param-tag solution">Source control</span>
                </div>
            </div>

            <!-- Iron -->
            <div class="param-guide-card">
                <div class="param-guide-header">
                    <div class="param-guide-icon metals">🔴</div>
                    <div>
                        <h4>Iron (Total)</h4>
                        <div class="standard">Standard: 1.5 mg/L (WV 47CSR2)</div>
                    </div>
                </div>
                <p>Dissolves from exposed pyrite in abandoned mines. Orange-red precipitate ("yellowboy") coats stream beds, smothering aquatic habitat. Key indicator of acid mine drainage when combined with low pH.</p>
                <div class="param-guide-tags">
                    <span class="param-tag source">Acid mine drainage</span>
                    <span class="param-tag source">Abandoned mines</span>
                    <span class="param-tag impact">Habitat smothering</span>
                    <span class="param-tag solution">AMD treatment</span>
                </div>
            </div>

            <!-- pH -->
            <div class="param-guide-card">
                <div class="param-guide-header">
                    <div class="param-guide-icon physical">📊</div>
                    <div>
                        <h4>pH</h4>
                        <div class="standard">Standard: 6.0–9.0 SU</div>
                    </div>
                </div>
                <p>Measures acidity/alkalinity on a logarithmic scale. Values below 6.0 indicate acid stress that harms fish reproduction and dissolves toxic metals. Above 9.0 can indicate algae blooms or industrial discharge.</p>
                <div class="param-guide-tags">
                    <span class="param-tag source">AMD (low pH)</span>
                    <span class="param-tag source">Photosynthesis (high pH)</span>
                    <span class="param-tag impact">Fish mortality</span>
                    <span class="param-tag solution">Limestone dosing</span>
                </div>
            </div>

            <!-- Sulfate -->
            <div class="param-guide-card">
                <div class="param-guide-header">
                    <div class="param-guide-icon ions">🧪</div>
                    <div>
                        <h4>Sulfate (SO4)</h4>
                        <div class="standard">Standard: 250 mg/L (secondary MCL)</div>
                    </div>
                </div>
                <p>Product of pyrite oxidation—the "smoking gun" of mining impact. Strong correlation with specific conductance creates the characteristic mining signature. High levels cause a bitter taste in drinking water.</p>
                <div class="param-guide-tags">
                    <span class="param-tag source">Pyrite oxidation</span>
                    <span class="param-tag source">Coal processing</span>
                    <span class="param-tag impact">Taste/odor</span>
                    <span class="param-tag solution">Reverse osmosis</span>
                </div>
            </div>

            <!-- Selenium -->
            <div class="param-guide-card">
                <div class="param-guide-header">
                    <div class="param-guide-icon metals">⚠️</div>
                    <div>
                        <h4>Selenium (Total)</h4>
                        <div class="standard">Standard: 0.005 mg/L (5 µg/L)</div>
                    </div>
                </div>
                <p>Trace element released by surface mining, especially in Southern WV coal seams. Bioaccumulates in fish tissue, causing reproductive failure. Emerging concern with the most stringent standard in the dataset.</p>
                <div class="param-guide-tags">
                    <span class="param-tag source">Mountaintop mining</span>
                    <span class="param-tag source">Coal seam geology</span>
                    <span class="param-tag impact">Fish deformities</span>
                    <span class="param-tag solution">Bioreactors</span>
                </div>
            </div>

            <!-- Aluminum -->
            <div class="param-guide-card">
                <div class="param-guide-header">
                    <div class="param-guide-icon metals">🔵</div>
                    <div>
                        <h4>Aluminum (Dissolved)</h4>
                        <div class="standard">Standard: 0.75 mg/L (WV 47CSR2)</div>
                    </div>
                </div>
                <p>Becomes toxic to fish at low pH when it dissolves from clay minerals. Damages gill tissue, causing suffocation. The 89.7% decline shows AMD treatment is working effectively across the watershed.</p>
                <div class="param-guide-tags">
                    <span class="param-tag source">Acidic conditions</span>
                    <span class="param-tag source">Clay dissolution</span>
                    <span class="param-tag impact">Gill damage</span>
                    <span class="param-tag solution">pH neutralization</span>
                </div>
            </div>

            <!-- Dissolved Oxygen -->
            <div class="param-guide-card">
                <div class="param-guide-header">
                    <div class="param-guide-icon physical">💨</div>
                    <div>
                        <h4>Dissolved Oxygen</h4>
                        <div class="standard">Standard: ≥5.0 mg/L</div>
                    </div>
                </div>
                <p>Essential for aquatic life survival. Low DO indicates organic pollution consuming oxygen through decomposition. Cold, fast-moving streams naturally have higher DO than warm, stagnant waters.</p>
                <div class="param-guide-tags">
                    <span class="param-tag source">Organic waste</span>
                    <span class="param-tag source">Algae die-off</span>
                    <span class="param-tag impact">Fish kills</span>
                    <span class="param-tag solution">Aeration</span>
                </div>
            </div>
        </div>
    </section>

    <!-- Parameter Map Section -->
    <section class="parameter-map-section reveal" id="parameterMap">
        <div style="max-width: 1200px; margin: 0 auto; padding: 0 2rem;">
            <p class="chapter-label">Interactive Analysis</p>
            <h2 class="chapter-title">Real-Time Parameter Mapping</h2>
            <p class="chapter-lead">Visualize where water quality standards are exceeded across the watershed. Select a parameter to see violation patterns at 884 monitoring stations.</p>

            <div class="param-map-controls">
                <div class="param-map-select-group">
                    <label for="paramMapSelect">Select Parameter</label>
                    <select id="paramMapSelect" class="param-map-select">
                        <option value="fecal">Fecal Coliform (400 CFU/100mL)</option>
                        <option value="sc">Specific Conductance (300 µS/cm)</option>
                        <option value="iron">Iron, Total (1.5 mg/L)</option>
                        <option value="ph">pH (6.0-9.0 SU)</option>
                        <option value="sulfate">Sulfate (250 mg/L)</option>
                        <option value="selenium">Selenium (0.005 mg/L)</option>
                        <option value="aluminum">Aluminum (0.75 mg/L)</option>
                        <option value="do">Dissolved Oxygen (≥5.0 mg/L)</option>
                    </select>
                </div>
                <div class="param-map-stats" id="paramMapStats">
                    <div class="stat-item">
                        <span class="stat-label">Stations</span>
                        <span class="stat-value" id="paramMapStations">—</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-label">With Violations</span>
                        <span class="stat-value" id="paramMapViolating">—</span>
                    </div>
                </div>
            </div>

            <div class="param-map-container" id="paramMapContainer">
                <div class="param-map-legend">
                    <div class="legend-item"><span class="legend-dot critical"></span> >50% violations</div>
                    <div class="legend-item"><span class="legend-dot high"></span> 25-50% violations</div>
                    <div class="legend-item"><span class="legend-dot moderate"></span> 10-25% violations</div>
                    <div class="legend-item"><span class="legend-dot low"></span> 1-10% violations</div>
                    <div class="legend-item"><span class="legend-dot clean"></span> 0% violations</div>
                </div>
            </div>

            <div class="param-map-note">
                <strong>How to read this map:</strong> Each dot represents a monitoring station. Color indicates the percentage of samples that exceeded the standard at that location. Click any station for details including sample count, mean value, and violation rate.
            </div>
        </div>
    </section>

    <!-- Roadmap Section -->
    <section class="chapter chapter-narrow reveal" id="roadmap">
        <p class="chapter-label">Platform Updates</p>
        <h2 class="chapter-title">What's New & What's Next</h2>
        <p class="chapter-lead">This platform is actively evolving. Here's what we've recently added and what's coming next:</p>

        <div class="roadmap-grid">
            <div class="roadmap-item" style="border-color: rgba(78, 205, 196, 0.5);">
                <div class="roadmap-icon">📅</div>
                <h4>Date Range Filters <span style="color: #4ecdc4; font-size: 0.7em;">NEW</span></h4>
                <p>Filter histograms by year range with preset buttons for key periods (1970s-80s, Since TMDL, etc.).</p>
            </div>
            <div class="roadmap-item" style="border-color: rgba(78, 205, 196, 0.5);">
                <div class="roadmap-icon">📊</div>
                <h4>Crosstab Analysis <span style="color: #4ecdc4; font-size: 0.7em;">NEW</span></h4>
                <p>Explore parameter correlations with interactive scatter plots showing mining signatures and AMD patterns.</p>
            </div>
            <div class="roadmap-item" style="border-color: rgba(78, 205, 196, 0.5);">
                <div class="roadmap-icon">🗺️</div>
                <h4>Parameter Mapping <span style="color: #4ecdc4; font-size: 0.7em;">NEW</span></h4>
                <p>Visualize violations spatially across 884 monitoring stations with color-coded markers by severity.</p>
            </div>
            <div class="roadmap-item">
                <div class="roadmap-icon">📈</div>
                <h4>Trend Forecasting</h4>
                <p>Project future water quality based on historical trends with confidence intervals.</p>
            </div>
        </div>

        <div class="highlight-box" style="margin-top: 2rem;">
            <p><strong>Also Added:</strong> Interactive histograms with Chart.js, parameter interpretation guide, data export (CSV/PDF), mobile touch optimizations, watershed boundary overlays, and NHD stream flowlines.</p>
        </div>
    </section>

    <!-- Glossary & Index Section -->
    <section class="glossary-index" id="glossary">
        <div class="glossary-index-container">
            <h2>Glossary & Reference</h2>
            <p class="glossary-index-subtitle">Technical terms used throughout this analysis, organized by category</p>

            <div class="glossary-tabs">
                <button class="glossary-tab active" onclick="switchGlossaryTab('all')">All Terms</button>
                <button class="glossary-tab" onclick="switchGlossaryTab('regulatory')">Regulatory</button>
                <button class="glossary-tab" onclick="switchGlossaryTab('pollutants')">Pollutants</button>
                <button class="glossary-tab" onclick="switchGlossaryTab('methods')">Methods</button>
                <button class="glossary-tab" onclick="switchGlossaryTab('units')">Units</button>
            </div>

            <!-- All Terms -->
            <div class="glossary-category active" id="glossary-all">
                <h4 class="glossary-category-title">All Technical Terms (A-Z)</h4>
                <div class="glossary-list">
                    <div class="glossary-entry">
                        <div class="glossary-entry-term">47CSR2 (WV)</div>
                        <div class="glossary-entry-def">West Virginia Legislative Rule 47-2: Water Quality Standards. Establishes designated uses, numeric criteria, and antidegradation policies for state waters.</div>
                        <div class="glossary-entry-ref">See: <a href="#methodology">Chapter 8</a></div>
                    </div>
                    <div class="glossary-entry">
                        <div class="glossary-entry-term">Acid Mine Drainage (AMD)</div>
                        <div class="glossary-entry-def">Acidic water draining from mines when sulfur-bearing minerals (pyrite) are exposed to air and water, producing sulfuric acid that dissolves heavy metals.</div>
                        <div class="glossary-entry-ref">See: <a href="#evidence">Chapter 2</a></div>
                    </div>
                    <div class="glossary-entry">
                        <div class="glossary-entry-term">Ambient Monitoring</div>
                        <div class="glossary-entry-def">Background water quality sampling in streams, separate from point source discharge monitoring. Used for 305(b) assessments and 303(d) impaired waters listings.</div>
                        <div class="glossary-entry-ref">See: <a href="#methodology">Chapter 8</a></div>
                    </div>
                    <div class="glossary-entry">
                        <div class="glossary-entry-term">Assessment Unit (AU)</div>
                        <div class="glossary-entry-def">A defined segment of a water body evaluated for water quality standards compliance. Each AU has a unique ID for tracking impairment status.</div>
                        <div class="glossary-entry-ref">See: <a href="#evidence">Chapter 2</a></div>
                    </div>
                    <div class="glossary-entry">
                        <div class="glossary-entry-term">CaCO₃ (Calcium Carbonate)</div>
                        <div class="glossary-entry-def">Standard unit for expressing acidity or alkalinity. Used to normalize different acid sources for comparison in water quality analysis.</div>
                        <div class="glossary-entry-ref">See: <a href="#evidence">Chapter 2</a></div>
                    </div>
                    <div class="glossary-entry">
                        <div class="glossary-entry-term">CFU (Colony Forming Units)</div>
                        <div class="glossary-entry-def">A measure of viable bacteria. CFU/100mL counts how many bacteria colonies grow from a 100 milliliter water sample.</div>
                        <div class="glossary-entry-ref">See: <a href="#evidence">Chapter 2</a></div>
                    </div>
                    <div class="glossary-entry">
                        <div class="glossary-entry-term">Clean Water Act (1972)</div>
                        <div class="glossary-entry-def">Federal framework for water pollution control. Sets goal of "fishable, swimmable" waters and creates the NPDES permit system for point source discharges.</div>
                        <div class="glossary-entry-ref">See: <a href="#legacy">Chapter 3</a></div>
                    </div>
                    <div class="glossary-entry">
                        <div class="glossary-entry-term">Detection Limit (DL)</div>
                        <div class="glossary-entry-def">The lowest concentration of a substance that can be reliably measured by an analytical method. Results below DL are reported as "non-detects."</div>
                        <div class="glossary-entry-ref">See: <a href="#methodology">Chapter 8</a></div>
                    </div>
                    <div class="glossary-entry">
                        <div class="glossary-entry-term">DL/2 Substitution</div>
                        <div class="glossary-entry-def">Simple method replacing non-detect values with half the detection limit. Introduces bias; Kaplan-Meier is preferred for rigorous analysis.</div>
                        <div class="glossary-entry-ref">See: <a href="#methodology">Chapter 8</a></div>
                    </div>
                    <div class="glossary-entry">
                        <div class="glossary-entry-term">Fecal Coliform</div>
                        <div class="glossary-entry-def">Bacteria indicating presence of human or animal waste in water. High levels make water unsafe for swimming and recreational contact.</div>
                        <div class="glossary-entry-ref">See: <a href="#evidence">Chapter 2</a>, <a href="#methodology">Chapter 8</a></div>
                    </div>
                    <div class="glossary-entry">
                        <div class="glossary-entry-term">Geometric Mean</div>
                        <div class="glossary-entry-def">The nth root of the product of n values. Used for bacteria because it reduces influence of extreme values in log-normally distributed data.</div>
                        <div class="glossary-entry-ref">See: <a href="#methodology">Chapter 8</a></div>
                    </div>
                    <div class="glossary-entry">
                        <div class="glossary-entry-term">Hot Acidity</div>
                        <div class="glossary-entry-def">Total acid-generating potential of water, including dissolved metals that release acid when oxidized. Key indicator of AMD severity.</div>
                        <div class="glossary-entry-ref">See: <a href="#evidence">Chapter 2</a></div>
                    </div>
                    <div class="glossary-entry">
                        <div class="glossary-entry-term">HUC (Hydrologic Unit Code)</div>
                        <div class="glossary-entry-def">Hierarchical watershed classification system developed by USGS. HUC8 = subbasin, HUC10 = watershed, HUC12 = subwatershed (10,000-40,000 acres).</div>
                        <div class="glossary-entry-ref">See: <a href="#hotspots">Chapter 6</a></div>
                    </div>
                    <div class="glossary-entry">
                        <div class="glossary-entry-term">Impaired Water</div>
                        <div class="glossary-entry-def">A water body that fails to meet water quality standards for its designated use (swimming, fishing, aquatic life, etc.).</div>
                        <div class="glossary-entry-ref">See: <a href="#watershed">Chapter 1</a></div>
                    </div>
                    <div class="glossary-entry">
                        <div class="glossary-entry-term">Kaplan-Meier</div>
                        <div class="glossary-entry-def">Survival analysis method for estimating statistics with censored data. Properly handles non-detects without arbitrary substitution values.</div>
                        <div class="glossary-entry-ref">Reference: Kaplan & Meier (1958). See: <a href="#methodology">Chapter 8</a></div>
                    </div>
                    <div class="glossary-entry">
                        <div class="glossary-entry-term">Left-Censored Data</div>
                        <div class="glossary-entry-def">Data where values below a threshold (detection limit) are known to be "less than X" but exact values are unknown.</div>
                        <div class="glossary-entry-ref">See: <a href="#methodology">Chapter 8</a></div>
                    </div>
                    <div class="glossary-entry">
                        <div class="glossary-entry-term">Mann-Kendall Test</div>
                        <div class="glossary-entry-def">Non-parametric hypothesis test for monotonic trend. Robust to outliers, missing data, and non-normal distributions.</div>
                        <div class="glossary-entry-ref">Reference: Mann (1945), Kendall (1975). See: <a href="#methodology">Chapter 8</a></div>
                    </div>
                    <div class="glossary-entry">
                        <div class="glossary-entry-term">mg/L (Milligrams per Liter)</div>
                        <div class="glossary-entry-def">Concentration unit equivalent to parts per million (ppm). Used for most water quality measurements including metals and nutrients.</div>
                        <div class="glossary-entry-ref">See: <a href="#evidence">Chapter 2</a></div>
                    </div>
                    <div class="glossary-entry">
                        <div class="glossary-entry-term">Monotonic Trend</div>
                        <div class="glossary-entry-def">Consistently increasing or decreasing pattern over time (not necessarily linear). Distinguished from step changes or cyclical patterns.</div>
                        <div class="glossary-entry-ref">See: <a href="#methodology">Chapter 8</a></div>
                    </div>
                    <div class="glossary-entry">
                        <div class="glossary-entry-term">NPDES</div>
                        <div class="glossary-entry-def">National Pollutant Discharge Elimination System. Permit program regulating point source discharges (pipes, outfalls) to US waters.</div>
                        <div class="glossary-entry-ref">See: <a href="#legacy">Chapter 3</a></div>
                    </div>
                    <div class="glossary-entry">
                        <div class="glossary-entry-term">p-value</div>
                        <div class="glossary-entry-def">Probability the observed result occurred by chance. p < 0.05 means less than 5% chance; standard threshold for statistical significance.</div>
                        <div class="glossary-entry-ref">See: <a href="#methodology">Chapter 8</a></div>
                    </div>
                    <div class="glossary-entry">
                        <div class="glossary-entry-term">Point Source</div>
                        <div class="glossary-entry-def">Pollution discharged from a discrete, identifiable location (pipe, outfall, ditch). Requires NPDES permit. Contrast with nonpoint source (diffuse runoff).</div>
                        <div class="glossary-entry-ref">See: <a href="#methodology">Chapter 8</a></div>
                    </div>
                    <div class="glossary-entry">
                        <div class="glossary-entry-term">Sen's Slope</div>
                        <div class="glossary-entry-def">Median of slopes between all pairs of points. Robust to outliers—up to 29% of data can be outliers without affecting the estimate.</div>
                        <div class="glossary-entry-ref">Reference: Sen (1968). See: <a href="#methodology">Chapter 8</a></div>
                    </div>
                    <div class="glossary-entry">
                        <div class="glossary-entry-term">SMCRA</div>
                        <div class="glossary-entry-def">Surface Mining Control and Reclamation Act (1977). Federal law requiring coal operators to restore mined land and establishing reclamation fund.</div>
                        <div class="glossary-entry-ref">See: <a href="#legacy">Chapter 3</a></div>
                    </div>
                    <div class="glossary-entry">
                        <div class="glossary-entry-term">Specific Conductance</div>
                        <div class="glossary-entry-def">Water's ability to conduct electricity, increasing with dissolved ions. In mining areas, high conductivity indicates mineral contamination.</div>
                        <div class="glossary-entry-ref">See: <a href="#evidence">Chapter 2</a></div>
                    </div>
                    <div class="glossary-entry">
                        <div class="glossary-entry-term">TMDL</div>
                        <div class="glossary-entry-def">Total Maximum Daily Load. Maximum amount of a pollutant a water body can receive while meeting standards—essentially a pollution budget.</div>
                        <div class="glossary-entry-ref">See: <a href="#watershed">Chapter 1</a></div>
                    </div>
                    <div class="glossary-entry">
                        <div class="glossary-entry-term">µS/cm (Microsiemens per cm)</div>
                        <div class="glossary-entry-def">Standard unit for measuring electrical conductivity in water. Higher values indicate more dissolved ions.</div>
                        <div class="glossary-entry-ref">See: <a href="#evidence">Chapter 2</a></div>
                    </div>
                </div>
            </div>

            <!-- Regulatory Terms -->
            <div class="glossary-category" id="glossary-regulatory">
                <h4 class="glossary-category-title">Regulatory & Legal Terms</h4>
                <div class="glossary-list">
                    <div class="glossary-entry">
                        <div class="glossary-entry-term">47CSR2 (WV)</div>
                        <div class="glossary-entry-def">West Virginia Legislative Rule 47-2: Water Quality Standards. Establishes designated uses, numeric criteria, and antidegradation policies for state waters.</div>
                    </div>
                    <div class="glossary-entry">
                        <div class="glossary-entry-term">303(d) List</div>
                        <div class="glossary-entry-def">Section of Clean Water Act requiring states to identify impaired waters not meeting standards. Listed waters require TMDL development.</div>
                    </div>
                    <div class="glossary-entry">
                        <div class="glossary-entry-term">305(b) Report</div>
                        <div class="glossary-entry-def">Biennial report to Congress on state water quality conditions. Provides basis for 303(d) listing decisions.</div>
                    </div>
                    <div class="glossary-entry">
                        <div class="glossary-entry-term">Assessment Unit (AU)</div>
                        <div class="glossary-entry-def">A defined segment of a water body evaluated for water quality standards compliance. Each AU has a unique ID for tracking.</div>
                    </div>
                    <div class="glossary-entry">
                        <div class="glossary-entry-term">Clean Water Act (1972)</div>
                        <div class="glossary-entry-def">Federal framework for water pollution control. Sets goal of "fishable, swimmable" waters and creates the NPDES permit system.</div>
                    </div>
                    <div class="glossary-entry">
                        <div class="glossary-entry-term">Designated Use</div>
                        <div class="glossary-entry-def">Classification of water body's intended purpose: aquatic life, recreation (swimming), drinking water supply, or agricultural use.</div>
                    </div>
                    <div class="glossary-entry">
                        <div class="glossary-entry-term">Impaired Water</div>
                        <div class="glossary-entry-def">Water body failing to meet standards for its designated use. Requires listing under 303(d) and TMDL development.</div>
                    </div>
                    <div class="glossary-entry">
                        <div class="glossary-entry-term">NPDES</div>
                        <div class="glossary-entry-def">National Pollutant Discharge Elimination System. EPA permit program regulating point source discharges to US waters.</div>
                    </div>
                    <div class="glossary-entry">
                        <div class="glossary-entry-term">SMCRA</div>
                        <div class="glossary-entry-def">Surface Mining Control and Reclamation Act (1977). Requires land restoration and funds abandoned mine reclamation.</div>
                    </div>
                    <div class="glossary-entry">
                        <div class="glossary-entry-term">TMDL</div>
                        <div class="glossary-entry-def">Total Maximum Daily Load. A calculation of maximum pollutant amount a water body can receive while meeting standards.</div>
                    </div>
                </div>
            </div>

            <!-- Pollutants -->
            <div class="glossary-category" id="glossary-pollutants">
                <h4 class="glossary-category-title">Pollutants & Parameters</h4>
                <div class="glossary-list">
                    <div class="glossary-entry">
                        <div class="glossary-entry-term">Acid Mine Drainage (AMD)</div>
                        <div class="glossary-entry-def">Acidic water from mines containing sulfuric acid and dissolved metals. Major source of pollution in coal mining regions.</div>
                    </div>
                    <div class="glossary-entry">
                        <div class="glossary-entry-term">Aluminum (Al)</div>
                        <div class="glossary-entry-def">Metal that becomes toxic to aquatic life at low pH. WV standard: 0.75 mg/L. Shows 89.7% decline in Lower Guyandotte.</div>
                    </div>
                    <div class="glossary-entry">
                        <div class="glossary-entry-term">Fecal Coliform</div>
                        <div class="glossary-entry-def">Bacteria indicating fecal contamination. WV standards: 200 CFU/100mL (geometric mean), 400 CFU/100mL (single sample max).</div>
                    </div>
                    <div class="glossary-entry">
                        <div class="glossary-entry-term">Hot Acidity</div>
                        <div class="glossary-entry-def">Total acid-generating potential including latent acidity from dissolved metals. WV standard: 0 mg/L CaCO₃.</div>
                    </div>
                    <div class="glossary-entry">
                        <div class="glossary-entry-term">Iron (Fe)</div>
                        <div class="glossary-entry-def">Metal from AMD that forms rust-colored precipitates. WV standard: 1.5 mg/L. Shows 25% decline in watershed.</div>
                    </div>
                    <div class="glossary-entry">
                        <div class="glossary-entry-term">Manganese (Mn)</div>
                        <div class="glossary-entry-def">Metal common in AMD. Can cause taste/odor issues. WV standard: 1.0 mg/L. Shows 67.7% decline.</div>
                    </div>
                    <div class="glossary-entry">
                        <div class="glossary-entry-term">pH</div>
                        <div class="glossary-entry-def">Measure of acidity/alkalinity on 0-14 scale. WV standard: 6.0-9.0. Below 6.0 indicates acid stress.</div>
                    </div>
                    <div class="glossary-entry">
                        <div class="glossary-entry-term">Selenium (Se)</div>
                        <div class="glossary-entry-def">Trace element that bioaccumulates in fish tissue. WV standard: 0.005 mg/L. Shows concerning 30% increase.</div>
                    </div>
                    <div class="glossary-entry">
                        <div class="glossary-entry-term">Specific Conductance</div>
                        <div class="glossary-entry-def">Electrical conductivity indicating dissolved ion concentration. Benchmark: 300 µS/cm (EPA) for aquatic life impacts.</div>
                    </div>
                    <div class="glossary-entry">
                        <div class="glossary-entry-term">Sulfate (SO₄)</div>
                        <div class="glossary-entry-def">Byproduct of pyrite oxidation in mining areas. Strongly correlated with conductivity (r=0.88).</div>
                    </div>
                </div>
            </div>

            <!-- Methods -->
            <div class="glossary-category" id="glossary-methods">
                <h4 class="glossary-category-title">Statistical Methods</h4>
                <div class="glossary-list">
                    <div class="glossary-entry">
                        <div class="glossary-entry-term">Detection Limit (DL)</div>
                        <div class="glossary-entry-def">Lowest concentration reliably measured by analytical method. Results below DL are "non-detects" requiring special handling.</div>
                    </div>
                    <div class="glossary-entry">
                        <div class="glossary-entry-term">DL/2 Substitution</div>
                        <div class="glossary-entry-def">Simple method: replace non-detects with half the detection limit. Quick but introduces bias; Kaplan-Meier preferred.</div>
                    </div>
                    <div class="glossary-entry">
                        <div class="glossary-entry-term">% Violations</div>
                        <div class="glossary-entry-def">Percentage of samples exceeding the applicable water quality standard. Primary metric for impairment assessment.</div>
                    </div>
                    <div class="glossary-entry">
                        <div class="glossary-entry-term">Geometric Mean</div>
                        <div class="glossary-entry-def">Nth root of product of n values. Used for bacteria (log-normal data) to reduce influence of extreme spikes.</div>
                    </div>
                    <div class="glossary-entry">
                        <div class="glossary-entry-term">Kaplan-Meier Estimator</div>
                        <div class="glossary-entry-def">Survival analysis method for censored data. Estimates statistics without arbitrary substitution. Reference: Kaplan & Meier (1958).</div>
                    </div>
                    <div class="glossary-entry">
                        <div class="glossary-entry-term">Left-Censored Data</div>
                        <div class="glossary-entry-def">Values known only to be below a threshold. Non-detects are left-censored at the detection limit.</div>
                    </div>
                    <div class="glossary-entry">
                        <div class="glossary-entry-term">Mann-Kendall Test</div>
                        <div class="glossary-entry-def">Non-parametric test for monotonic trends. Counts concordant vs discordant pairs. Robust to outliers. Reference: Mann (1945).</div>
                    </div>
                    <div class="glossary-entry">
                        <div class="glossary-entry-term">Monotonic Trend</div>
                        <div class="glossary-entry-def">Pattern consistently increasing or decreasing over time. May not be linear but maintains direction.</div>
                    </div>
                    <div class="glossary-entry">
                        <div class="glossary-entry-term">p-value</div>
                        <div class="glossary-entry-def">Probability result occurred by chance. p < 0.05 = statistically significant (< 5% chance of random occurrence).</div>
                    </div>
                    <div class="glossary-entry">
                        <div class="glossary-entry-term">Sen's Slope</div>
                        <div class="glossary-entry-def">Robust trend magnitude estimator. Median of slopes between all point pairs. Resistant to 29% outliers. Reference: Sen (1968).</div>
                    </div>
                </div>
            </div>

            <!-- Units -->
            <div class="glossary-category" id="glossary-units">
                <h4 class="glossary-category-title">Units of Measurement</h4>
                <div class="glossary-list">
                    <div class="glossary-entry">
                        <div class="glossary-entry-term">CaCO₃</div>
                        <div class="glossary-entry-def">Calcium carbonate equivalent. Standard unit for expressing acidity/alkalinity, allowing comparison of different acid sources.</div>
                    </div>
                    <div class="glossary-entry">
                        <div class="glossary-entry-term">CFU/100mL</div>
                        <div class="glossary-entry-def">Colony Forming Units per 100 milliliters. Bacteria concentration measurement from culture plate counts.</div>
                    </div>
                    <div class="glossary-entry">
                        <div class="glossary-entry-term">mg/L</div>
                        <div class="glossary-entry-def">Milligrams per liter. Equal to parts per million (ppm). Standard unit for dissolved substances.</div>
                    </div>
                    <div class="glossary-entry">
                        <div class="glossary-entry-term">pH units</div>
                        <div class="glossary-entry-def">Logarithmic scale from 0-14. Each unit represents 10x change in hydrogen ion concentration. 7 = neutral.</div>
                    </div>
                    <div class="glossary-entry">
                        <div class="glossary-entry-term">µS/cm</div>
                        <div class="glossary-entry-def">Microsiemens per centimeter. Electrical conductivity unit. Higher values = more dissolved ions.</div>
                    </div>
                    <div class="glossary-entry">
                        <div class="glossary-entry-term">µg/L</div>
                        <div class="glossary-entry-def">Micrograms per liter. Equal to parts per billion (ppb). Used for trace contaminants like selenium.</div>
                    </div>
                </div>
            </div>

            <!-- Index Section -->
            <div class="index-section">
                <h3>Quick Reference Index</h3>
                <div class="index-grid">
                    <div class="index-item">
                        <span class="index-item-term">Acid Mine Drainage</span>
                        <span class="index-item-chapter">Ch. 2, 3</span>
                    </div>
                    <div class="index-item">
                        <span class="index-item-term">Aluminum trends</span>
                        <span class="index-item-chapter">Ch. 4</span>
                    </div>
                    <div class="index-item">
                        <span class="index-item-term">Assessment units (80% impaired)</span>
                        <span class="index-item-chapter">Ch. 2</span>
                    </div>
                    <div class="index-item">
                        <span class="index-item-term">Ballard Fork-Mud River</span>
                        <span class="index-item-chapter">Ch. 6</span>
                    </div>
                    <div class="index-item">
                        <span class="index-item-term">Clean Water Act</span>
                        <span class="index-item-chapter">Ch. 3</span>
                    </div>
                    <div class="index-item">
                        <span class="index-item-term">Conductivity correlation</span>
                        <span class="index-item-chapter">Ch. 5</span>
                    </div>
                    <div class="index-item">
                        <span class="index-item-term">Davis Creek hotspot</span>
                        <span class="index-item-chapter">Ch. 6</span>
                    </div>
                    <div class="index-item">
                        <span class="index-item-term">Exceedance rates</span>
                        <span class="index-item-chapter">Ch. 2</span>
                    </div>
                    <div class="index-item">
                        <span class="index-item-term">Fecal coliform (38.4%)</span>
                        <span class="index-item-chapter">Ch. 2, 4</span>
                    </div>
                    <div class="index-item">
                        <span class="index-item-term">Geometric mean calculation</span>
                        <span class="index-item-chapter">Ch. 8</span>
                    </div>
                    <div class="index-item">
                        <span class="index-item-term">Hot acidity (100%)</span>
                        <span class="index-item-chapter">Ch. 2</span>
                    </div>
                    <div class="index-item">
                        <span class="index-item-term">HUC12 rankings</span>
                        <span class="index-item-chapter">Ch. 6</span>
                    </div>
                    <div class="index-item">
                        <span class="index-item-term">Impairment scoring</span>
                        <span class="index-item-chapter">Ch. 6, 8</span>
                    </div>
                    <div class="index-item">
                        <span class="index-item-term">Iron trends (-25%)</span>
                        <span class="index-item-chapter">Ch. 4</span>
                    </div>
                    <div class="index-item">
                        <span class="index-item-term">Kaplan-Meier method</span>
                        <span class="index-item-chapter">Ch. 8</span>
                    </div>
                    <div class="index-item">
                        <span class="index-item-term">Mann-Kendall test</span>
                        <span class="index-item-chapter">Ch. 8</span>
                    </div>
                    <div class="index-item">
                        <span class="index-item-term">Mining signature</span>
                        <span class="index-item-chapter">Ch. 5</span>
                    </div>
                    <div class="index-item">
                        <span class="index-item-term">NPDES permits</span>
                        <span class="index-item-chapter">Ch. 3</span>
                    </div>
                    <div class="index-item">
                        <span class="index-item-term">Non-detect handling</span>
                        <span class="index-item-chapter">Ch. 8</span>
                    </div>
                    <div class="index-item">
                        <span class="index-item-term">Selenium (+30% trend)</span>
                        <span class="index-item-chapter">Ch. 4</span>
                    </div>
                    <div class="index-item">
                        <span class="index-item-term">Sen's slope estimator</span>
                        <span class="index-item-chapter">Ch. 8</span>
                    </div>
                    <div class="index-item">
                        <span class="index-item-term">SMCRA (1977)</span>
                        <span class="index-item-chapter">Ch. 3</span>
                    </div>
                    <div class="index-item">
                        <span class="index-item-term">Specific conductance (46.0%)</span>
                        <span class="index-item-chapter">Ch. 2</span>
                    </div>
                    <div class="index-item">
                        <span class="index-item-term">Sulfate-conductivity (r=0.88)</span>
                        <span class="index-item-chapter">Ch. 5</span>
                    </div>
                    <div class="index-item">
                        <span class="index-item-term">TMDL comparison</span>
                        <span class="index-item-chapter">Ch. 5</span>
                    </div>
                    <div class="index-item">
                        <span class="index-item-term">Temporal trends</span>
                        <span class="index-item-chapter">Ch. 4</span>
                    </div>
                    <div class="index-item">
                        <span class="index-item-term">WV 47CSR2 standards</span>
                        <span class="index-item-chapter">Ch. 8</span>
                    </div>
                    <div class="index-item">
                        <span class="index-item-term">Watershed overview</span>
                        <span class="index-item-chapter">Ch. 1</span>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- Footer -->
    <footer>
        <p class="footer-logo">Lower Guyandotte Water Quality Analysis</p>
        <p class="footer-text">
            Data source: <a href="https://dep.wv.gov" target="_blank">West Virginia DEP</a> Ambient Water Quality Monitoring Program<br>
            Analysis generated January 2026 using Python with WV 47CSR2 standards<br><br>
            <a href="https://storymaps.arcgis.com/stories/a288c36e4ae74f1f9f907ad6d09215a1" target="_blank">View official WV DEP StoryMap</a> ·
            <a href="dashboard.html">View data dashboard</a>
        </p>
    </footer>

    <!-- Modal Overlay -->
    <div class="modal-overlay" id="plotModal">
        <div class="modal-container">
            <div class="modal-header">
                <h3 class="modal-title" id="modalTitle">Plot Details</h3>
                <button class="modal-close" onclick="closeModal()">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <line x1="18" y1="6" x2="6" y2="18"></line>
                        <line x1="6" y1="6" x2="18" y2="18"></line>
                    </svg>
                </button>
            </div>
            <div class="modal-tabs">
                <button class="modal-tab active" onclick="switchTab('image')">Full Image</button>
                <button class="modal-tab" onclick="switchTab('data')">Data Table</button>
                <button class="modal-tab" onclick="switchTab('code')">Python Code</button>
            </div>
            <div class="modal-content">
                <!-- Image Panel -->
                <div class="modal-panel active" id="panel-image">
                    <div class="modal-image-container">
                        <img id="modalImage" src="" alt="Plot visualization">
                    </div>
                </div>
                <!-- Data Panel -->
                <div class="modal-panel" id="panel-data">
                    <div id="modalDataContent"></div>
                </div>
                <!-- Code Panel -->
                <div class="modal-panel" id="panel-code">
                    <div class="modal-code-block">
                        <div class="modal-code-header">
                            <span class="modal-code-lang">Python</span>
                            <button class="modal-code-copy" onclick="copyCode()">Copy Code</button>
                        </div>
                        <div class="modal-code-content">
                            <pre id="modalCodeContent"></pre>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Export Panel -->
    <div class="export-panel" id="exportPanel">
        <button class="export-btn" onclick="exportCSV()" title="Export data as CSV">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                <polyline points="7 10 12 15 17 10"/>
                <line x1="12" y1="15" x2="12" y2="3"/>
            </svg>
            CSV Data
        </button>
        <button class="export-btn" onclick="exportPDF()" title="Export as PDF report">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
                <polyline points="14 2 14 8 20 8"/>
                <line x1="16" y1="13" x2="8" y2="13"/>
                <line x1="16" y1="17" x2="8" y2="17"/>
                <line x1="10" y1="9" x2="8" y2="9"/>
            </svg>
            PDF Report
        </button>
    </div>

    <!-- Export Toast Notification -->
    <div class="export-toast" id="exportToast">Download complete!</div>

    <script>
        // Navigation scroll effect
        const nav = document.getElementById('nav');
        window.addEventListener('scroll', () => {
            if (window.scrollY > 100) {
                nav.classList.add('scrolled');
            } else {
                nav.classList.remove('scrolled');
            }
        });

        // Reveal on scroll
        const revealElements = document.querySelectorAll('.reveal');
        const revealObserver = new IntersectionObserver((entries) => {
            entries.forEach(entry => {
                if (entry.isIntersecting) {
                    entry.target.classList.add('visible');
                }
            });
        }, { threshold: 0.1, rootMargin: '0px 0px -50px 0px' });

        revealElements.forEach(el => revealObserver.observe(el));

        // Animate pollutant bars on scroll
        const pollutantCards = document.querySelectorAll('.pollutant-card');
        const barObserver = new IntersectionObserver((entries) => {
            entries.forEach(entry => {
                if (entry.isIntersecting) {
                    const fill = entry.target.querySelector('.pollutant-fill');
                    if (fill) {
                        const width = fill.style.width;
                        fill.style.width = '0%';
                        setTimeout(() => {
                            fill.style.width = width;
                        }, 100);
                    }
                }
            });
        }, { threshold: 0.5 });

        pollutantCards.forEach(card => barObserver.observe(card));

        // Plot Category Filters
        const filterBtns = document.querySelectorAll('.plot-filter-btn');
        const plotCards = document.querySelectorAll('.plot-card[data-category]');

        filterBtns.forEach(btn => {
            btn.addEventListener('click', () => {
                // Update active button
                filterBtns.forEach(b => b.classList.remove('active'));
                btn.classList.add('active');

                const filter = btn.dataset.filter;

                // Filter plots
                plotCards.forEach(card => {
                    const categories = card.dataset.category.split(' ');
                    if (filter === 'all' || categories.includes(filter)) {
                        card.classList.remove('hidden');
                    } else {
                        card.classList.add('hidden');
                    }
                });
            });
        });

        // ============================================
        // INTERACTIVE HUC12 MAP
        // ============================================
        const huc12Data = [
            { name: 'Davis Creek-Guyandotte River', huc12: '050701020102', score: 1020, rank: 1, lat: 38.0842, lon: -82.0156, courtOrder: false },
            { name: 'Ballard Fork-Mud River', huc12: '050701020305', score: 1005, rank: 2, lat: 38.0695, lon: -81.9338, courtOrder: true, courtStream: 'Ballard Fork' },
            { name: 'Crawley Creek-Guyandotte River', huc12: '050701020104', score: 759, rank: 3, lat: 37.9121, lon: -82.0520, courtOrder: true, courtStream: 'Crawley Creek' },
            { name: 'Big Harts Creek', huc12: '050701020103', score: 365, rank: 4, lat: 37.9500, lon: -81.9800, courtOrder: false },
            { name: 'Big Creek-Mud River', huc12: '050701020304', score: 346, rank: 5, lat: 38.1200, lon: -82.0100, courtOrder: false },
            { name: 'Merrick Creek-Mud River', huc12: '050701020309', score: 283, rank: 6, lat: 38.3959, lon: -82.0949, courtOrder: true, courtStream: 'Merrick Creek' },
            { name: 'Fourteenmile Creek-Guyandotte River', huc12: '050701020105', score: 260, rank: 7, lat: 38.0200, lon: -82.1000, courtOrder: false },
            { name: 'Big Creek', huc12: '050701020101', score: 240, rank: 8, lat: 37.8800, lon: -82.0600, courtOrder: false },
            { name: 'Smith Creek-Guyandotte River', huc12: '050701020402', score: 213, rank: 9, lat: 38.2500, lon: -82.0800, courtOrder: false },
            { name: 'Middle Fork Mud River', huc12: '050701020303', score: 203, rank: 10, lat: 38.1500, lon: -81.9500, courtOrder: false },
            // Court order streams not in top 10
            { name: 'Upper Mud River', huc12: 'WV-OGL-10', score: null, rank: null, lat: 38.2450, lon: -82.0644, courtOrder: true, courtStream: 'Upper Mud River' },
            { name: 'Sugartree Branch', huc12: 'WV-OGL-10-DW', score: null, rank: null, lat: 38.0917, lon: -81.9513, courtOrder: true, courtStream: 'Sugartree Branch' },
            { name: 'Stanley Fork', huc12: 'WV-OGL-10-DX', score: null, rank: null, lat: 38.0838, lon: -81.9540, courtOrder: true, courtStream: 'Stanley Fork' },
            { name: 'Big Ugly Creek', huc12: 'WV-OGL-89', score: null, rank: null, lat: 38.0630, lon: -82.0379, courtOrder: true, courtStream: 'Big Ugly Creek' },
            { name: 'Limestone Branch', huc12: 'WV-OGL-111', score: null, rank: null, lat: 38.0112, lon: -82.0440, courtOrder: true, courtStream: 'Limestone Branch' },
            { name: 'Ed Stone Branch', huc12: 'WV-OGL-112-D', score: null, rank: null, lat: 38.0105, lon: -82.0123, courtOrder: true, courtStream: 'Ed Stone Branch' },
            { name: 'South Fork Crawley Creek', huc12: 'WV-OGL-117-M', score: null, rank: null, lat: 37.8994, lon: -82.0462, courtOrder: true, courtStream: 'South Fork Crawley Creek' },
            { name: 'Rocky Branch', huc12: 'WV-OGL-130', score: null, rank: null, lat: 37.9314, lon: -82.0138, courtOrder: true, courtStream: 'Rocky Branch' }
        ];

        function getScoreColor(score) {
            if (score === null) return '#64748b';
            if (score > 500) return '#ef4444';
            if (score > 300) return '#f59e0b';
            if (score > 200) return '#eab308';
            return '#4ecdc4';
        }

        function initInteractiveImpairmentMap() {
            const mapContainer = document.getElementById('huc12InteractiveMap');
            if (!mapContainer || mapContainer._leaflet_id) return; // Prevent re-init

            const map = L.map('huc12InteractiveMap', { scrollWheelZoom: false }).setView([38.05, -82.0], 9);

            L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
                attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OSM</a> &copy; <a href="https://carto.com/attributions">CARTO</a>',
                subdomains: 'abcd',
                maxZoom: 19
            }).addTo(map);

            // Add markers
            huc12Data.forEach(item => {
                const color = getScoreColor(item.score);
                const isCourtOrder = item.courtOrder;

                const icon = L.divIcon({
                    html: `<div style="
                        width: ${isCourtOrder ? '18px' : '14px'};
                        height: ${isCourtOrder ? '18px' : '14px'};
                        background: ${isCourtOrder && item.score === null ? 'transparent' : color};
                        border: ${isCourtOrder ? '3px solid #ef4444' : '2px solid rgba(255,255,255,0.5)'};
                        border-radius: 50%;
                        box-shadow: 0 0 ${isCourtOrder ? '12px #ef4444' : '8px ' + color};
                    "></div>`,
                    iconSize: [isCourtOrder ? 18 : 14, isCourtOrder ? 18 : 14],
                    iconAnchor: [isCourtOrder ? 9 : 7, isCourtOrder ? 9 : 7],
                    popupAnchor: [0, -10]
                });

                let popupContent = `<div style="min-width: 200px;">
                    <div class="map-popup-title">${item.name}</div>
                    <div class="map-popup-stats">`;

                if (item.rank) {
                    popupContent += `
                        <span class="map-popup-label">Rank:</span>
                        <span class="map-popup-value">#${item.rank} of 21</span>
                        <span class="map-popup-label">Score:</span>
                        <span class="map-popup-value" style="color: ${color};">${item.score.toLocaleString()}</span>`;
                }

                popupContent += `
                    <span class="map-popup-label">HUC12:</span>
                    <span class="map-popup-value">${item.huc12}</span>
                </div>`;

                if (isCourtOrder) {
                    popupContent += `<div class="map-popup-court">⚖️ Subject to Federal Consent Decree</div>`;
                }

                popupContent += '</div>';

                L.marker([item.lat, item.lon], { icon: icon })
                    .addTo(map)
                    .bindPopup(popupContent);
            });

            // Fit bounds
            const bounds = L.latLngBounds(huc12Data.map(d => [d.lat, d.lon]));
            map.fitBounds(bounds, { padding: [30, 30] });

            // Link hotspot items to map
            document.querySelectorAll('.hotspot-item').forEach(item => {
                item.addEventListener('click', () => {
                    const name = item.querySelector('.hotspot-name').textContent;
                    const huc = huc12Data.find(d => d.name === name);
                    if (huc) {
                        map.setView([huc.lat, huc.lon], 11);
                        // Scroll map into view
                        mapContainer.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    }
                });
            });
        }

        // Initialize interactive impairment map when section is visible
        const impairmentMapObserver = new IntersectionObserver((entries) => {
            entries.forEach(entry => {
                if (entry.isIntersecting) {
                    initInteractiveImpairmentMap();
                    impairmentMapObserver.disconnect();
                }
            });
        }, { threshold: 0.1 });

        const impairmentMapSection = document.getElementById('huc12InteractiveMap');
        if (impairmentMapSection) {
            impairmentMapObserver.observe(impairmentMapSection);
        }

        // ============================================
        // COMPARISON TABLE FILTERS
        // ============================================
        const tableFilterBtns = document.querySelectorAll('.table-filter-btn');
        const comparisonTable = document.getElementById('comparisonTable');

        if (comparisonTable) {
            const tableRows = comparisonTable.querySelectorAll('tbody tr');

            tableFilterBtns.forEach(btn => {
                btn.addEventListener('click', () => {
                    // Update active button
                    tableFilterBtns.forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');

                    const filter = btn.dataset.filter;

                    // Filter rows
                    tableRows.forEach(row => {
                        const categories = row.dataset.category ? row.dataset.category.split(' ') : [];
                        if (filter === 'all' || categories.includes(filter)) {
                            row.classList.remove('hidden');
                        } else {
                            row.classList.add('hidden');
                        }
                    });
                });
            });
        }

        // ============================================
        // MODAL/LIGHTBOX SYSTEM
        // ============================================

        // Plot configuration data
        const plotData = {
            exceedance: {
                title: 'Water Quality Standard % Violations',
                image: 'wq_analysis_output_v2/plots/exceedance_summary.png',
                data: [
                    { parameter: 'Hot Acidity', samples: '2,449', exceedance: '100.0%', standard: '0 mg/L CaCO3', status: 'bad' },
                    { parameter: 'Fecal Coliform (MF)', samples: '4,834', exceedance: '38.4%', standard: '400 CFU/100 mL', status: 'bad' },
                    { parameter: 'Specific Conductance', samples: '7,164', exceedance: '46.0%', standard: '300 µS/cm (EPA)', status: 'bad' },
                    { parameter: 'Sulfate (SO4)', samples: '2,553', exceedance: '18.4%', standard: '250 mg/L', status: 'bad' },
                    { parameter: 'Se, Total', samples: '2,210', exceedance: '15.1%', standard: '0.005 mg/L', status: 'bad' },
                    { parameter: 'Fe, Total', samples: '4,690', exceedance: '8.7%', standard: '1.5 mg/L', status: 'warn' },
                    { parameter: 'DO', samples: '6,160', exceedance: '3.7%', standard: '5.0 mg/L', status: 'good' },
                    { parameter: 'Mn, Total', samples: '1,615', exceedance: '1.3%', standard: '1.0 mg/L', status: 'good' },
                    { parameter: 'pH', samples: '6,391', exceedance: '1.0%', standard: '6.0-9.0 SU', status: 'good' },
                    { parameter: 'Al, Dissolved', samples: '2,070', exceedance: '0.5%', standard: '0.75 mg/L', status: 'good' }
                ],
                code: `def _plot_exceedance_summary(self, violations: dict, output_dir: Path) -> None:
    """Plot WQ standard violation rates."""
    if not violations:
        return

    self.logger.info("  Creating exceedance summary plot...")

    exc_data = []
    for param, data in violations.items():
        exc_data.append({
            'parameter': param,
            'exceedance_pct': data['exceedance_percent'],
            'n_samples': data['n_samples'],
            'standard': f"{data['standard_value']} {data['standard_unit']}"
        })

    exc_df = pd.DataFrame(exc_data).sort_values('exceedance_pct', ascending=True)

    fig, ax = plt.subplots(figsize=(12, 8))
    colors = ['red' if x > 10 else 'orange' if x > 5 else 'green'
              for x in exc_df['exceedance_pct']]

    bars = ax.barh(exc_df['parameter'], exc_df['exceedance_pct'],
                   color=colors, edgecolor='black', alpha=0.8)

    ax.set_xlabel('% Violations (%)', fontsize=12)
    ax.set_ylabel('Parameter', fontsize=12)
    ax.set_title('Water Quality Standard % Violations\\n(WV 47CSR2 Standards)', fontsize=14)
    ax.axvline(10, color='red', linestyle='--', linewidth=2,
               label='10% Impairment Threshold')
    ax.legend()

    for bar, n, std in zip(bars, exc_df['n_samples'], exc_df['standard']):
        ax.text(bar.get_width() + 0.5, bar.get_y() + bar.get_height()/2,
               f'n={n:,} (std: {std})', va='center', fontsize=9)

    plt.tight_layout()
    plt.savefig(output_dir / 'exceedance_summary.png', dpi=150, bbox_inches='tight')
    plt.close()`
            },
            trend: {
                title: 'Long-term Water Quality Trends',
                image: 'wq_analysis_output_v2/plots/trend_summary.png',
                data: [
                    { parameter: 'Al, Total', change: '-89.7%', direction: 'Decreasing', significant: 'Yes', early: '0.94 mg/L', late: '0.11 mg/L', status: 'good' },
                    { parameter: 'Mn, Total', change: '-67.7%', direction: 'Decreasing', significant: 'Yes', early: '0.15 mg/L', late: '0.05 mg/L', status: 'good' },
                    { parameter: 'Fe, Total', change: '-25.0%', direction: 'Decreasing', significant: 'Yes', early: '0.97 mg/L', late: '0.25 mg/L', status: 'good' },
                    { parameter: 'Fecal Coliform', change: '-3.2%', direction: 'Decreasing', significant: 'Yes', early: '1133 CFU', late: '239 CFU', status: 'good' },
                    { parameter: 'pH', change: '+4.6%', direction: 'Increasing', significant: 'Yes', early: '7.1 SU', late: '7.7 SU', status: 'good' },
                    { parameter: 'Se, Total', change: '+30.0%', direction: 'Increasing', significant: 'Yes', early: '0.0013 mg/L', late: '0.001 mg/L', status: 'bad' },
                    { parameter: 'Specific Conductance', change: '+37.9%', direction: 'Increasing', significant: 'No', early: '307 µS/cm', late: '326 µS/cm', status: 'warn' }
                ],
                code: `def _plot_trend_summary(self, trends: dict, output_dir: Path) -> None:
    """Plot trend analysis summary."""
    if not trends:
        return

    self.logger.info("  Creating trend summary plot...")

    trend_data = []
    for param, data in trends.items():
        trend_data.append({
            'parameter': param,
            'total_change_pct': data['total_change_pct'],
            'significant': data['significant'],
            'direction': data['trend_direction']
        })

    trend_df = pd.DataFrame(trend_data).dropna(subset=['total_change_pct'])
    trend_df = trend_df.sort_values('total_change_pct')

    fig, ax = plt.subplots(figsize=(12, 8))

    colors = []
    for _, row in trend_df.iterrows():
        if row['significant']:
            colors.append('darkred' if row['total_change_pct'] > 0 else 'darkgreen')
        else:
            colors.append('lightcoral' if row['total_change_pct'] > 0 else 'lightgreen')

    bars = ax.barh(trend_df['parameter'], trend_df['total_change_pct'],
                   color=colors, edgecolor='black', alpha=0.8)

    ax.axvline(0, color='black', linewidth=1)
    ax.set_xlabel('Total Change (%)', fontsize=12)
    ax.set_ylabel('Parameter', fontsize=12)
    ax.set_title('Long-term Trends in Water Quality\\n(Dark = Statistically Significant)', fontsize=14)

    plt.tight_layout()
    plt.savefig(output_dir / 'trend_summary.png', dpi=150, bbox_inches='tight')
    plt.close()`
            },
            fecal: {
                title: 'Fecal Coliform Analysis',
                image: 'wq_analysis_output_v2/plots/fecal_coliform_detail.png',
                data: [
                    { metric: 'Total Samples', value: '4,834', status: '' },
                    { metric: 'Geometric Mean', value: '232.2 CFU/100mL', status: 'bad' },
                    { metric: 'Geomean Standard', value: '200 CFU/100mL', status: '' },
                    { metric: 'Exceeds Geomean?', value: 'Yes', status: 'bad' },
                    { metric: 'Samples > 400 CFU', value: '1,856 (38.4%)', status: 'bad' },
                    { metric: 'Single Sample Max', value: '400 CFU/100mL', status: '' },
                    { metric: 'Median Value', value: '254 CFU/100mL', status: 'warn' },
                    { metric: 'Maximum Value', value: '710,700 CFU/100mL', status: 'bad' },
                    { metric: 'Non-Detect Rate', value: '3.0%', status: '' },
                    { metric: 'Stations Total', value: '489', status: '' },
                    { metric: 'Stations Impaired', value: '380 (77.7%)', status: 'bad' }
                ],
                code: `def _plot_fecal_coliform_detail(self, output_dir: Path) -> None:
    """Plot fecal coliform analysis with geomean and max standards."""
    self.logger.info("  Creating fecal coliform detail plot...")

    fc_data = self.df[
        (self.df['PARAMETER'] == 'Fecal Coliform (MF)') &
        (self.df['DATA_CATEGORY'] == 'ambient')
    ].copy()

    if len(fc_data) == 0:
        return

    fig, axes = plt.subplots(2, 2, figsize=(14, 10))

    # Annual geometric means
    annual = fc_data.groupby('SAMPLE_YEAR').apply(
        lambda x: pd.Series({
            'geomean': np.exp(np.mean(np.log(x['VALUE'].dropna()[x['VALUE'].dropna() > 0]))),
            'n_samples': len(x),
            'pct_exceed_400': 100 * (x['VALUE'] > 400).sum() / len(x)
        })
    )

    axes[0, 0].bar(annual.index, annual['geomean'], color='steelblue',
                   edgecolor='navy', alpha=0.8)
    axes[0, 0].axhline(200, color='red', linestyle='--', linewidth=2,
                       label='Geomean Standard (200)')
    axes[0, 0].set_xlabel('Year')
    axes[0, 0].set_ylabel('Geometric Mean (CFU/100mL)')
    axes[0, 0].set_title('Annual Geometric Mean - Fecal Coliform')
    axes[0, 0].legend()

    # Exceedance rate over time
    axes[0, 1].plot(annual.index, annual['pct_exceed_400'], 'o-',
                    color='darkred', linewidth=2)
    axes[0, 1].axhline(10, color='orange', linestyle='--', linewidth=2,
                       label='10% Threshold')
    axes[0, 1].set_xlabel('Year')
    axes[0, 1].set_ylabel('% Samples > 400 CFU/100mL')
    axes[0, 1].set_title('Annual % Violations (>400 Standard)')
    axes[0, 1].legend()

    # Distribution
    fc_values = fc_data['VALUE'].dropna()
    axes[1, 0].hist(fc_values[fc_values <= 5000], bins=50,
                    color='steelblue', edgecolor='navy', alpha=0.7)
    axes[1, 0].axvline(400, color='red', linestyle='--', linewidth=2,
                       label='Single Sample Max (400)')
    axes[1, 0].axvline(200, color='orange', linestyle='--', linewidth=2,
                       label='Geomean Standard (200)')
    axes[1, 0].set_xlabel('Fecal Coliform (CFU/100mL)')
    axes[1, 0].set_ylabel('Count')
    axes[1, 0].set_title('Distribution (values ≤5000)')
    axes[1, 0].legend()

    # Seasonal pattern
    season_order = ['Winter', 'Spring', 'Summer', 'Fall']
    season_geomeans = fc_data.groupby('SEASON').apply(
        lambda x: np.exp(np.mean(np.log(x['VALUE'].dropna()[x['VALUE'].dropna() > 0])))
    ).reindex(season_order)

    axes[1, 1].bar(season_geomeans.index, season_geomeans.values,
                   color='forestgreen', edgecolor='darkgreen', alpha=0.8)
    axes[1, 1].axhline(200, color='red', linestyle='--', linewidth=2,
                       label='Geomean Standard (200)')
    axes[1, 1].set_xlabel('Season')
    axes[1, 1].set_ylabel('Geometric Mean (CFU/100mL)')
    axes[1, 1].set_title('Seasonal Geometric Means')
    axes[1, 1].legend()

    plt.tight_layout()
    plt.savefig(output_dir / 'fecal_coliform_detail.png', dpi=150, bbox_inches='tight')
    plt.close()`
            },
            mining: {
                title: 'Mining Impact Signature: SC vs Sulfate',
                image: 'wq_analysis_output_v2/plots/mining_signature.png',
                data: [
                    { metric: 'SC-Sulfate Correlation (Spearman)', value: 'r = 0.883', status: '' },
                    { metric: 'Interpretation', value: 'Strong surface mining signal', status: 'warn' },
                    { metric: 'SC Benchmark', value: '300 µS/cm (EPA)', status: '' },
                    { metric: 'SC % Violations', value: '46.0%', status: 'bad' },
                    { metric: 'SC Median (High Conductivity)', value: '866 µS/cm', status: 'bad' },
                    { metric: 'Sulfate MCL', value: '250 mg/L', status: '' },
                    { metric: 'Sulfate % Violations', value: '18.4%', status: 'bad' },
                    { metric: 'Surface Mining Signature Samples', value: '612 (11.5%)', status: 'warn' },
                    { metric: 'AMD Signature Samples', value: '7 (0.1%)', status: 'good' },
                    { metric: 'High SC Samples (>300 µS/cm (EPA))', value: '1,056 (19.8%)', status: 'bad' }
                ],
                code: `def _plot_mining_signature(self, output_dir: Path) -> None:
    """Plot SC vs Sulfate to show mining signature."""
    self.logger.info("  Creating mining signature plot...")

    df = self.df[self.df['DATA_CATEGORY'] == 'ambient']

    pivot = df.pivot_table(
        index=['STATION_ID', 'SAMPLE_DATE'],
        columns='PARAMETER',
        values='VALUE',
        aggfunc='median'
    )

    if 'Specific Conductance' not in pivot.columns or 'Sulfate (SO4)' not in pivot.columns:
        return

    plot_data = pivot[['Specific Conductance', 'Sulfate (SO4)']].dropna()

    if len(plot_data) < 10:
        return

    fig, ax = plt.subplots(figsize=(10, 8))

    ax.scatter(plot_data['Sulfate (SO4)'], plot_data['Specific Conductance'],
               alpha=0.3, s=20, c='steelblue')

    ax.axhline(500, color='red', linestyle='--', linewidth=2,
               label='SC Benchmark (300 µS/cm (EPA))')
    ax.axvline(250, color='orange', linestyle='--', linewidth=2,
               label='Sulfate MCL (250 mg/L)')

    # Add correlation
    corr = plot_data.corr(method='spearman').loc['Specific Conductance', 'Sulfate (SO4)']
    ax.text(0.05, 0.95, f'Spearman r = {corr:.3f}', transform=ax.transAxes,
            fontsize=12, verticalalignment='top',
            bbox=dict(boxstyle='round', facecolor='white', alpha=0.8))

    ax.set_xlabel('Sulfate (mg/L)', fontsize=12)
    ax.set_ylabel('Specific Conductance (µS/cm)', fontsize=12)
    ax.set_title('Mining Impact Signature: SC vs Sulfate\\n' +
                 '(Strong positive correlation indicates surface mining)', fontsize=14)
    ax.legend(loc='lower right')

    plt.tight_layout()
    plt.savefig(output_dir / 'mining_signature.png', dpi=150, bbox_inches='tight')
    plt.close()`
            },
            hotspots: {
                title: 'HUC12 Subwatershed Impairment Ranking',
                image: 'wq_analysis_output_v2/plots/huc12_hotspots.png',
                data: [
                    { rank: '1', name: 'Davis Creek-Guyandotte River', score: '1,020', samples: '17,338', fc_exceed: '67.8%', status: 'bad' },
                    { rank: '2', name: 'Ballard Fork-Mud River', score: '912', samples: '12,821', fc_exceed: '11.5%', status: 'bad' },
                    { rank: '3', name: 'Crawley Creek-Guyandotte River', score: '759', samples: '15,014', fc_exceed: '47.3%', status: 'bad' },
                    { rank: '4', name: 'Big Harts Creek', score: '365', samples: '4,908', fc_exceed: '54.8%', status: 'warn' },
                    { rank: '5', name: 'Big Creek-Mud River', score: '346', samples: '4,380', fc_exceed: '30.2%', status: 'warn' },
                    { rank: '6', name: 'Merrick Creek-Mud River', score: '283', samples: '4,657', fc_exceed: '60.6%', status: 'warn' },
                    { rank: '7', name: 'Fourteenmile Creek-Guyandotte River', score: '260', samples: '3,683', fc_exceed: '41.0%', status: 'warn' },
                    { rank: '8', name: 'Big Creek', score: '240', samples: '4,060', fc_exceed: '42.2%', status: 'warn' },
                    { rank: '9', name: 'Smith Creek-Guyandotte River', score: '213', samples: '2,750', fc_exceed: '40.6%', status: 'warn' },
                    { rank: '10', name: 'Middle Fork Mud River', score: '203', samples: '2,270', fc_exceed: '40.8%', status: 'warn' }
                ],
                code: `def _plot_huc12_hotspots(self, hotspot_df: pd.DataFrame, output_dir: Path) -> None:
    """Plot HUC12 hotspot map."""
    if len(hotspot_df) == 0:
        return

    self.logger.info("  Creating HUC12 hotspot plot...")

    top_20 = hotspot_df.head(20).sort_values('impairment_score')

    fig, ax = plt.subplots(figsize=(12, 10))

    colors = plt.cm.Reds(np.linspace(0.3, 1, len(top_20)))

    bars = ax.barh(top_20['HUC12NAME'], top_20['impairment_score'],
                   color=colors, edgecolor='black')

    ax.set_xlabel('Impairment Score', fontsize=12)
    ax.set_ylabel('HUC12 Subwatershed', fontsize=12)
    ax.set_title('Top 20 Impaired HUC12 Subwatersheds\\n' +
                 '(Higher score = more impairment)', fontsize=14)

    plt.tight_layout()
    plt.savefig(output_dir / 'huc12_hotspots.png', dpi=150, bbox_inches='tight')
    plt.close()

# Impairment score calculation (from earlier in the code):
def calculate_hotspot_scores(df):
    """Calculate composite impairment score per HUC12."""
    huc12_stats = df.groupby('HUC12NAME').agg({
        'SAMPLEID': 'count',
        'STATION_ID': 'nunique'
    }).rename(columns={'SAMPLEID': 'n_samples', 'STATION_ID': 'n_stations'})

    # Weight violations by parameter severity
    weights = {
        'Fecal Coliform': 2.0,  # Human health risk
        'Fe, Total': 1.5,       # Aquatic life
        'Specific Conductance': 1.5,  # Mining indicator
        'pH': 1.0
    }

    # Sum weighted violations for each HUC12
    # Score = sum(n_violations * weight) for each parameter
    return huc12_stats`
            },
            temporal: {
                title: 'Temporal Sampling Coverage',
                image: 'wq_analysis_output_v2/plots/temporal_coverage.png',
                data: [
                    { decade: '1970s', samples: '6,673', percent: '6.4%', status: '' },
                    { decade: '1980s', samples: '4,268', percent: '4.1%', status: '' },
                    { decade: '1990s', samples: '3,482', percent: '3.4%', status: '' },
                    { decade: '2000s', samples: '8,936', percent: '8.6%', status: '' },
                    { decade: '2010s', samples: '60,599', percent: '58.5%', status: 'good' },
                    { decade: '2020s', samples: '19,576', percent: '18.9%', status: 'good' },
                    { decade: 'Total', samples: '103,534', percent: '100%', status: '' }
                ],
                code: `def _plot_temporal_coverage(self, output_dir: Path) -> None:
    """Plot temporal coverage."""
    self.logger.info("  Creating temporal coverage plot...")

    df = self.df[self.df['DATA_CATEGORY'] == 'ambient']

    fig, axes = plt.subplots(2, 2, figsize=(14, 10))

    # Samples per year
    yearly = df.groupby('SAMPLE_YEAR')['SAMPLEID'].nunique()
    axes[0, 0].bar(yearly.index, yearly.values,
                   color='steelblue', edgecolor='navy', alpha=0.8)
    axes[0, 0].set_xlabel('Year')
    axes[0, 0].set_ylabel('Number of Samples')
    axes[0, 0].set_title('Ambient Samples per Year')
    axes[0, 0].tick_params(axis='x', rotation=45)

    # Data category breakdown
    cat_yearly = self.df.groupby(['SAMPLE_YEAR', 'DATA_CATEGORY'])['SAMPLEID'] \\
        .nunique().unstack(fill_value=0)
    cat_yearly.plot(kind='bar', stacked=True, ax=axes[0, 1], alpha=0.8)
    axes[0, 1].set_xlabel('Year')
    axes[0, 1].set_ylabel('Number of Samples')
    axes[0, 1].set_title('Samples by Data Category')
    axes[0, 1].legend(title='Category')

    # Parameters per year
    params_yearly = df.groupby('SAMPLE_YEAR')['PARAMETER'].nunique()
    axes[1, 0].plot(params_yearly.index, params_yearly.values, 'o-',
                    color='darkorange', linewidth=2)
    axes[1, 0].set_xlabel('Year')
    axes[1, 0].set_ylabel('Number of Parameters')
    axes[1, 0].set_title('Unique Parameters Sampled per Year')

    # Stations per year
    stations_yearly = df.groupby('SAMPLE_YEAR')['STATION_ID'].nunique()
    axes[1, 1].plot(stations_yearly.index, stations_yearly.values, 's-',
                    color='purple', linewidth=2)
    axes[1, 1].set_xlabel('Year')
    axes[1, 1].set_ylabel('Number of Stations')
    axes[1, 1].set_title('Unique Stations Sampled per Year')

    plt.tight_layout()
    plt.savefig(output_dir / 'temporal_coverage.png', dpi=150, bbox_inches='tight')
    plt.close()`
            },
            sc_trend: {
                title: 'Specific Conductance Trend Over Time',
                image: 'wq_analysis_output_v2/plots/sc_trend.png',
                data: [
                    { metric: 'Data Range', value: '1974-2024 (50 years)', status: '' },
                    { metric: 'Linear Slope', value: '+1.63 µS/cm per year', status: 'warn' },
                    { metric: 'Total Change', value: '+37.9%', status: 'warn' },
                    { metric: 'Statistically Significant?', value: 'No (p=0.256)', status: '' },
                    { metric: 'Early Period Median', value: '307 µS/cm', status: '' },
                    { metric: 'Late Period Median', value: '326 µS/cm', status: '' },
                    { metric: 'Benchmark', value: '300 µS/cm (EPA)', status: '' },
                    { metric: '% Violations', value: '46.0%', status: 'bad' },
                    { metric: 'SC-Sulfate Correlation', value: 'r = 0.883', status: 'warn' }
                ],
                code: `def _plot_sc_trend(self, output_dir: Path) -> None:
    """Plot specific conductance trend (key finding)."""
    self.logger.info("  Creating SC trend plot...")

    df = self.df[
        (self.df['PARAMETER'] == 'Specific Conductance') &
        (self.df['DATA_CATEGORY'] == 'ambient')
    ]

    if len(df) < 50:
        return

    annual = df.groupby('SAMPLE_YEAR')['VALUE'].agg(['median', 'mean', 'std', 'count'])
    annual = annual[annual['count'] >= 5]

    fig, ax = plt.subplots(figsize=(12, 6))

    # Plot median with standard deviation band
    ax.fill_between(annual.index,
                    annual['median'] - annual['std'],
                    annual['median'] + annual['std'],
                    alpha=0.3, color='steelblue')
    ax.plot(annual.index, annual['median'], 'o-', color='steelblue',
            linewidth=2, markersize=6, label='Annual Median')

    ax.axhline(500, color='red', linestyle='--', linewidth=2,
               label='Benchmark (300 µS/cm (EPA))')

    # Add trend line using linear regression
    years = annual.index.values.astype(float)
    values = annual['median'].values
    slope, intercept, r_value, p_value, _ = stats.linregress(years, values)

    ax.plot(years, slope * years + intercept, 'g--', linewidth=2,
            label=f'Trend: {slope:.1f} µS/cm/year (p={p_value:.4f})')

    ax.set_xlabel('Year', fontsize=12)
    ax.set_ylabel('Specific Conductance (µS/cm)', fontsize=12)
    ax.set_title('Specific Conductance Trend\\n(Key Mining Impact Indicator)', fontsize=14)
    ax.legend(loc='upper left')

    plt.tight_layout()
    plt.savefig(output_dir / 'sc_trend.png', dpi=150, bbox_inches='tight')
    plt.close()`
            }
        };

        let currentPlot = null;

        function openModal(plotId) {
            const plot = plotData[plotId];
            if (!plot) return;

            currentPlot = plotId;

            // Set title and image
            document.getElementById('modalTitle').textContent = plot.title;
            document.getElementById('modalImage').src = plot.image;

            // Generate data table
            const dataContent = document.getElementById('modalDataContent');
            dataContent.innerHTML = generateDataTable(plot.data, plotId);

            // Set code content
            document.getElementById('modalCodeContent').textContent = plot.code;

            // Reset to image tab
            switchTab('image');

            // Show modal
            const modal = document.getElementById('plotModal');
            modal.classList.add('active');
            document.body.style.overflow = 'hidden';
        }

        function closeModal() {
            const modal = document.getElementById('plotModal');
            modal.classList.remove('active');
            document.body.style.overflow = '';
            currentPlot = null;
        }

        function switchTab(tabName) {
            // Update tab buttons
            document.querySelectorAll('.modal-tab').forEach(tab => {
                tab.classList.remove('active');
                if (tab.textContent.toLowerCase().includes(tabName)) {
                    tab.classList.add('active');
                }
            });

            // Update panels
            document.querySelectorAll('.modal-panel').forEach(panel => {
                panel.classList.remove('active');
            });
            document.getElementById('panel-' + tabName).classList.add('active');
        }

        function generateDataTable(data, plotId) {
            if (!data || data.length === 0) return '<p>No data available</p>';

            const headers = Object.keys(data[0]).filter(k => k !== 'status');

            let html = '<table class="modal-data-table"><thead><tr>';
            headers.forEach(h => {
                html += '<th>' + formatHeader(h) + '</th>';
            });
            html += '</tr></thead><tbody>';

            data.forEach(row => {
                html += '<tr>';
                headers.forEach(h => {
                    const statusClass = row.status ? 'value-' + row.status : '';
                    html += '<td class="' + statusClass + '">' + row[h] + '</td>';
                });
                html += '</tr>';
            });

            html += '</tbody></table>';

            // Add download link
            html += '<div style="margin-top: 1.5rem; padding-top: 1rem; border-top: 1px solid rgba(255,255,255,0.1);">';
            html += '<p style="font-size: 0.85rem; color: var(--text-dim);">';
            html += 'Download full dataset: <a href="wq_analysis_output_v2/' + getCSVFile(plotId) + '" ';
            html += 'style="color: var(--accent);" download>' + getCSVFile(plotId) + '</a>';
            html += '</p></div>';

            return html;
        }

        function getCSVFile(plotId) {
            const csvMap = {
                'exceedance': 'exceedance_analysis.csv',
                'trend': 'trend_analysis.csv',
                'fecal': 'fecal_coliform_analysis.csv',
                'mining': 'mining_signature_analysis.csv',
                'hotspots': 'huc12_hotspots.csv',
                'temporal': 'summary_statistics.csv',
                'sc_trend': 'trend_analysis.csv'
            };
            return csvMap[plotId] || 'summary_statistics.csv';
        }

        function formatHeader(header) {
            return header.replace(/_/g, ' ')
                        .replace(/([A-Z])/g, ' $1')
                        .replace(/^./, str => str.toUpperCase())
                        .trim();
        }

        function copyCode() {
            const code = document.getElementById('modalCodeContent').textContent;
            navigator.clipboard.writeText(code).then(() => {
                const btn = document.querySelector('.modal-code-copy');
                btn.textContent = 'Copied!';
                btn.classList.add('copied');
                setTimeout(() => {
                    btn.textContent = 'Copy Code';
                    btn.classList.remove('copied');
                }, 2000);
            });
        }

        // Close modal on escape key
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                closeModal();
            }
        });

        // Close modal on overlay click
        document.getElementById('plotModal').addEventListener('click', (e) => {
            if (e.target.classList.contains('modal-overlay')) {
                closeModal();
            }
        });

        // ============================================
        // READING PROGRESS BAR
        // ============================================
        const progressBar = document.getElementById('progressBar');

        function updateProgressBar() {
            const scrollTop = window.scrollY;
            const docHeight = document.documentElement.scrollHeight - window.innerHeight;
            const scrollPercent = (scrollTop / docHeight) * 100;
            progressBar.style.width = scrollPercent + '%';
        }

        // ============================================
        // CHAPTER NAVIGATION DOTS
        // ============================================
        const chapterNav = document.getElementById('chapterNav');
        const chapterDots = document.querySelectorAll('.chapter-dot');
        const sections = [];

        // Build sections array from dot targets
        chapterDots.forEach(dot => {
            const targetId = dot.getAttribute('data-target');
            const section = document.getElementById(targetId);
            if (section) {
                sections.push({ id: targetId, element: section, dot: dot });
            }
        });

        // Click handler for dots
        chapterDots.forEach(dot => {
            dot.addEventListener('click', () => {
                const targetId = dot.getAttribute('data-target');
                const target = document.getElementById(targetId);
                if (target) {
                    target.scrollIntoView({ behavior: 'smooth' });
                }
            });
        });

        function updateChapterNav() {
            const scrollTop = window.scrollY;
            const windowHeight = window.innerHeight;

            // Show/hide chapter nav based on scroll position
            if (scrollTop > windowHeight * 0.5) {
                chapterNav.classList.add('visible');
            } else {
                chapterNav.classList.remove('visible');
            }

            // Update active dot
            let currentSection = null;
            for (let i = sections.length - 1; i >= 0; i--) {
                const rect = sections[i].element.getBoundingClientRect();
                if (rect.top <= windowHeight * 0.5) {
                    currentSection = sections[i];
                    break;
                }
            }

            // Update dot states
            chapterDots.forEach(dot => dot.classList.remove('active'));
            if (currentSection) {
                currentSection.dot.classList.add('active');
            }
        }

        // Throttled scroll handler
        let ticking = false;
        window.addEventListener('scroll', () => {
            if (!ticking) {
                window.requestAnimationFrame(() => {
                    updateProgressBar();
                    updateChapterNav();
                    ticking = false;
                });
                ticking = true;
            }
        });

        // Initialize on load
        updateProgressBar();
        updateChapterNav();

        // Glossary Tab Switching
        function switchGlossaryTab(category) {
            // Update tabs
            document.querySelectorAll('.glossary-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            event.target.classList.add('active');

            // Update categories
            document.querySelectorAll('.glossary-category').forEach(cat => {
                cat.classList.remove('active');
            });
            document.getElementById('glossary-' + category).classList.add('active');
        }

        // HUC12 Interactive Map - Full data from huc12_hotspots.csv
        const huc12Scores = {
            '050701020403': { name: 'Davis Creek-Guyandotte River', score: 1020, rank: 1, n_samples: 17338, n_stations: 51, fc_n: 547, fc_exceed_count: 371, fc_exceed: 67.8, fe_exceed: 113, sc_exceed: 154, sc_median: 340.3, ph_exceed: 11 },
            '050701020302': { name: 'Ballard Fork-Mud River', score: 912, rank: 2, n_samples: 12821, n_stations: 101, fc_n: 390, fc_exceed_count: 45, fc_exceed: 11.5, fe_exceed: 15, sc_exceed: 801, sc_median: 1318.0, ph_exceed: 6 },
            '050701020102': { name: 'Crawley Creek-Guyandotte River', score: 759, rank: 3, n_samples: 15014, n_stations: 81, fc_n: 505, fc_exceed_count: 239, fc_exceed: 47.3, fe_exceed: 37, sc_exceed: 237, sc_median: 353.1, ph_exceed: 7 },
            '050701020103': { name: 'Big Harts Creek', score: 365, rank: 4, n_samples: 4908, n_stations: 83, fc_n: 323, fc_exceed_count: 177, fc_exceed: 54.8, fe_exceed: 4, sc_exceed: 6, sc_median: 169.5, ph_exceed: 1 },
            '050701020304': { name: 'Big Creek-Mud River', score: 346, rank: 5, n_samples: 4380, n_stations: 33, fc_n: 265, fc_exceed_count: 80, fc_exceed: 30.2, fe_exceed: 14, sc_exceed: 172, sc_median: 356.0, ph_exceed: 0 },
            '050701020309': { name: 'Merrick Creek-Mud River', score: 283, rank: 6, n_samples: 4657, n_stations: 37, fc_n: 109, fc_exceed_count: 66, fc_exceed: 60.6, fe_exceed: 28, sc_exceed: 121, sc_median: 390.0, ph_exceed: 2 },
            '050701020105': { name: 'Fourteenmile Creek-Guyandotte River', score: 260, rank: 7, n_samples: 3683, n_stations: 56, fc_n: 278, fc_exceed_count: 114, fc_exceed: 41.0, fe_exceed: 9, sc_exceed: 18, sc_median: 130.0, ph_exceed: 5 },
            '050701020101': { name: 'Big Creek', score: 240, rank: 8, n_samples: 4060, n_stations: 51, fc_n: 218, fc_exceed_count: 92, fc_exceed: 42.2, fe_exceed: 13, sc_exceed: 25, sc_median: 271.5, ph_exceed: 18 },
            '050701020402': { name: 'Smith Creek-Guyandotte River', score: 213, rank: 9, n_samples: 2750, n_stations: 32, fc_n: 229, fc_exceed_count: 93, fc_exceed: 40.6, fe_exceed: 18, sc_exceed: 9, sc_median: 269.0, ph_exceed: 0 },
            '050701020303': { name: 'Middle Fork Mud River', score: 203, rank: 10, n_samples: 2270, n_stations: 29, fc_n: 223, fc_exceed_count: 91, fc_exceed: 40.8, fe_exceed: 21, sc_exceed: 0, sc_median: 148.0, ph_exceed: 0 },
            '050701020301': { name: 'Left Fork Mud River', score: 200, rank: 11, n_samples: 2018, n_stations: 28, fc_n: 100, fc_exceed_count: 35, fc_exceed: 35.0, fe_exceed: 3, sc_exceed: 125, sc_median: 610.0, ph_exceed: 2 },
            '050701020401': { name: 'Madison Creek-Guyandotte River', score: 193, rank: 12, n_samples: 4252, n_stations: 17, fc_n: 173, fc_exceed_count: 71, fc_exceed: 41.0, fe_exceed: 41, sc_exceed: 10, sc_median: 257.5, ph_exceed: 0 },
            '050701020201': { name: 'Headwaters Trace Fork', score: 169, rank: 13, n_samples: 2323, n_stations: 29, fc_n: 228, fc_exceed_count: 75, fc_exceed: 32.9, fe_exceed: 19, sc_exceed: 0, sc_median: 168.0, ph_exceed: 0 },
            '050701020307': { name: 'Mill Creek-Mud River', score: 144, rank: 14, n_samples: 3505, n_stations: 33, fc_n: 213, fc_exceed_count: 62, fc_exceed: 29.1, fe_exceed: 10, sc_exceed: 7, sc_median: 170.0, ph_exceed: 3 },
            '050701020308': { name: 'Big Cabell Creek-Mud River', score: 121, rank: 15, n_samples: 1877, n_stations: 27, fc_n: 176, fc_exceed_count: 58, fc_exceed: 33.0, fe_exceed: 5, sc_exceed: 0, sc_median: 242.0, ph_exceed: 0 },
            '050701020107': { name: 'Tenmile Creek-Guyandotte River', score: 109, rank: 16, n_samples: 3453, n_stations: 29, fc_n: 214, fc_exceed_count: 33, fc_exceed: 15.4, fe_exceed: 12, sc_exceed: 25, sc_median: 121.0, ph_exceed: 6 },
            '050701020202': { name: 'Outlet Trace Fork', score: 91, rank: 17, n_samples: 1559, n_stations: 18, fc_n: 136, fc_exceed_count: 36, fc_exceed: 26.5, fe_exceed: 19, sc_exceed: 0, sc_median: 157.5, ph_exceed: 0 },
            '050701020106': { name: 'Fourmile Creek', score: 86, rank: 18, n_samples: 2372, n_stations: 15, fc_n: 112, fc_exceed_count: 38, fc_exceed: 33.9, fe_exceed: 10, sc_exceed: 0, sc_median: 157.0, ph_exceed: 0 },
            '050701020104': { name: 'Big Ugly Creek', score: 86, rank: 19, n_samples: 4970, n_stations: 43, fc_n: 226, fc_exceed_count: 31, fc_exceed: 13.7, fe_exceed: 0, sc_exceed: 20, sc_median: 127.0, ph_exceed: 4 },
            '050701020306': { name: 'Charley Creek-Mud River', score: 84, rank: 20, n_samples: 1597, n_stations: 14, fc_n: 113, fc_exceed_count: 33, fc_exceed: 29.2, fe_exceed: 10, sc_exceed: 8, sc_median: 196.0, ph_exceed: 0 },
            '050701020305': { name: 'Buffalo Creek-Mud River', score: 46, rank: 21, n_samples: 723, n_stations: 10, fc_n: 56, fc_exceed_count: 16, fc_exceed: 28.6, fe_exceed: 5, sc_exceed: 9, sc_median: 229.0, ph_exceed: 0 }
        };

        // Generate parameter detail panel HTML
        function generateDetailPanel(huc12) {
            const data = huc12Scores[huc12];
            if (!data) return '';

            const getParamClass = (value, thresholds) => {
                if (value >= thresholds[0]) return 'critical';
                if (value >= thresholds[1]) return 'warning';
                if (value >= thresholds[2]) return 'elevated';
                return 'good';
            };

            const fcClass = getParamClass(data.fc_exceed, [50, 30, 15]);
            const feClass = getParamClass(data.fe_exceed, [50, 20, 5]);
            const scClass = getParamClass(data.sc_exceed, [100, 50, 10]);
            const phClass = getParamClass(data.ph_exceed, [10, 5, 1]);

            return `
                <div class="hotspot-details">
                    <div class="hotspot-meta">
                        <div class="hotspot-meta-item">
                            <span>Total Samples:</span>
                            <span class="hotspot-meta-value">${data.n_samples.toLocaleString()}</span>
                        </div>
                        <div class="hotspot-meta-item">
                            <span>Stations:</span>
                            <span class="hotspot-meta-value">${data.n_stations}</span>
                        </div>
                        <div class="hotspot-meta-item">
                            <span>Median SC:</span>
                            <span class="hotspot-meta-value">${data.sc_median} µS/cm</span>
                        </div>
                    </div>
                    <div class="param-grid">
                        <div class="param-card ${fcClass}">
                            <div class="param-header">
                                <span class="param-name">Fecal Coliform</span>
                                <span class="param-value">${data.fc_exceed.toFixed(1)}%</span>
                            </div>
                            <div class="param-bar">
                                <div class="param-bar-fill ${fcClass}" style="width: ${Math.min(data.fc_exceed, 100)}%"></div>
                            </div>
                            <div style="font-size: 0.7rem; color: var(--slate); margin-top: 0.3rem;">
                                ${data.fc_exceed_count} of ${data.fc_n} samples exceed
                            </div>
                        </div>
                        <div class="param-card ${feClass}">
                            <div class="param-header">
                                <span class="param-name">Iron (Fe)</span>
                                <span class="param-value">${data.fe_exceed} exceed</span>
                            </div>
                            <div class="param-bar">
                                <div class="param-bar-fill ${feClass}" style="width: ${Math.min(data.fe_exceed / 1.5, 100)}%"></div>
                            </div>
                            <div style="font-size: 0.7rem; color: var(--slate); margin-top: 0.3rem;">
                                Standard: 1.5 mg/L
                            </div>
                        </div>
                        <div class="param-card ${scClass}">
                            <div class="param-header">
                                <span class="param-name">Sp. Conductance</span>
                                <span class="param-value">${data.sc_exceed} exceed</span>
                            </div>
                            <div class="param-bar">
                                <div class="param-bar-fill ${scClass}" style="width: ${Math.min(data.sc_exceed / 10, 100)}%"></div>
                            </div>
                            <div style="font-size: 0.7rem; color: var(--slate); margin-top: 0.3rem;">
                                Benchmark: 300 µS/cm (EPA)
                            </div>
                        </div>
                        <div class="param-card ${phClass}">
                            <div class="param-header">
                                <span class="param-name">pH Violations</span>
                                <span class="param-value">${data.ph_exceed} exceed</span>
                            </div>
                            <div class="param-bar">
                                <div class="param-bar-fill ${phClass}" style="width: ${Math.min(data.ph_exceed * 5, 100)}%"></div>
                            </div>
                            <div style="font-size: 0.7rem; color: var(--slate); margin-top: 0.3rem;">
                                Standard: 6.0–9.0
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        // Toggle hotspot detail panel
        function toggleHotspotDetails(item) {
            const huc12 = item.dataset.huc12;
            const isExpanded = item.classList.contains('expanded');

            // Close all other expanded items
            document.querySelectorAll('.hotspot-item.expanded').forEach(el => {
                if (el !== item) {
                    el.classList.remove('expanded');
                    const details = el.querySelector('.hotspot-details');
                    if (details) details.remove();
                }
            });

            if (isExpanded) {
                item.classList.remove('expanded');
                const details = item.querySelector('.hotspot-details');
                if (details) details.remove();
            } else {
                item.classList.add('expanded');
                // Add detail panel if not exists
                if (!item.querySelector('.hotspot-details')) {
                    item.insertAdjacentHTML('beforeend', generateDetailPanel(huc12));
                }
            }
        }

        function getScoreColor(score) {
            if (score >= 800) return '#e76f51';  // Critical - coral
            if (score >= 400) return '#f4a261';  // High - amber
            if (score >= 200) return '#ffe66d';  // Elevated - gold
            return '#4ecdc4';  // Moderate - accent
        }

        function getRankClass(rank) {
            if (rank <= 3) return 'critical';
            if (rank <= 6) return 'high';
            if (rank <= 10) return 'elevated';
            return '';
        }

        // Store layer references for bidirectional highlighting
        let huc12Layers = {};
        let huc12GeoJsonLayer = null;

        function highlightLayer(huc12) {
            if (huc12Layers[huc12]) {
                huc12Layers[huc12].setStyle({ weight: 4, color: '#4ecdc4', fillOpacity: 0.9 });
                huc12Layers[huc12].bringToFront();
            }
        }

        function resetLayerStyle(huc12) {
            if (huc12Layers[huc12] && huc12GeoJsonLayer) {
                huc12GeoJsonLayer.resetStyle(huc12Layers[huc12]);
            }
        }

        function highlightListItem(huc12) {
            const listItem = document.querySelector(`.hotspot-item[data-huc12="${huc12}"]`);
            if (listItem) {
                listItem.classList.add('highlighted');
                // Scroll into view if needed
                listItem.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
            }
        }

        function resetListItem(huc12) {
            const listItem = document.querySelector(`.hotspot-item[data-huc12="${huc12}"]`);
            if (listItem) {
                listItem.classList.remove('highlighted');
            }
        }

        function initHUC12Map() {
            const mapContainer = document.getElementById('huc12Map');
            if (!mapContainer) return;

            // Initialize map centered on Lower Guyandotte
            const map = L.map('huc12Map', {
                scrollWheelZoom: false,
                attributionControl: true
            }).setView([38.05, -82.1], 10);

            // Dark basemap tiles
            L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
                attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OSM</a> &copy; <a href="https://carto.com/attributions">CARTO</a>',
                subdomains: 'abcd',
                maxZoom: 19
            }).addTo(map);

            // Load GeoJSON
            fetch('huc12_boundaries.geojson')
                .then(response => response.json())
                .then(data => {
                    huc12GeoJsonLayer = L.geoJSON(data, {
                        style: function(feature) {
                            const huc12 = feature.properties.huc12;
                            const info = huc12Scores[huc12] || { score: 0 };
                            return {
                                fillColor: getScoreColor(info.score),
                                weight: 2,
                                opacity: 1,
                                color: '#1b2838',
                                fillOpacity: 0.7
                            };
                        },
                        onEachFeature: function(feature, layer) {
                            const huc12 = feature.properties.huc12;
                            const info = huc12Scores[huc12];

                            // Store layer reference
                            huc12Layers[huc12] = layer;

                            if (info) {
                                const rankClass = getRankClass(info.rank);
                                layer.bindPopup(`
                                    <div class="popup-title">${info.name}</div>
                                    <div class="popup-stats">
                                        <span class="popup-label">Rank:</span>
                                        <span class="popup-value"><span class="popup-rank ${rankClass}">#${info.rank}</span></span>
                                        <span class="popup-label">Score:</span>
                                        <span class="popup-value">${info.score.toLocaleString()}</span>
                                        <span class="popup-label">FC Exceed:</span>
                                        <span class="popup-value">${info.fc_exceed.toFixed(1)}%</span>
                                        <span class="popup-label">SC Exceed:</span>
                                        <span class="popup-value">${info.sc_exceed} samples</span>
                                        <span class="popup-label">HUC12:</span>
                                        <span class="popup-value">${huc12}</span>
                                    </div>
                                `, { maxWidth: 280 });

                                // Map hover -> highlight list item
                                layer.on('mouseover', function() {
                                    highlightLayer(huc12);
                                    highlightListItem(huc12);
                                });
                                layer.on('mouseout', function() {
                                    resetLayerStyle(huc12);
                                    resetListItem(huc12);
                                });
                                layer.on('click', function() {
                                    // Open popup and keep highlighted
                                    highlightListItem(huc12);
                                });
                            }
                        }
                    }).addTo(map);

                    // Fit map to bounds
                    map.fitBounds(huc12GeoJsonLayer.getBounds(), { padding: [20, 20] });

                    // Add layer controls with stream flowlines
                    addWatershedBoundaryControls(map, huc12GeoJsonLayer);

                    // Setup list item hover handlers
                    document.querySelectorAll('.hotspot-item[data-huc12]').forEach(item => {
                        const huc12 = item.dataset.huc12;

                        item.addEventListener('mouseenter', () => {
                            highlightLayer(huc12);
                            item.classList.add('highlighted');
                        });

                        item.addEventListener('mouseleave', () => {
                            resetLayerStyle(huc12);
                            item.classList.remove('highlighted');
                        });

                        item.addEventListener('click', (e) => {
                            // Toggle detail panel
                            toggleHotspotDetails(item);
                            // Pan to and open popup on map
                            if (huc12Layers[huc12]) {
                                map.fitBounds(huc12Layers[huc12].getBounds(), { padding: [50, 50], maxZoom: 12 });
                                huc12Layers[huc12].openPopup();
                            }
                        });
                    });
                })
                .catch(error => {
                    console.error('Error loading HUC12 boundaries:', error);
                    mapContainer.innerHTML = '<p style="padding: 2rem; text-align: center; color: #a3b8c7;">Map data unavailable. <a href="huc12_boundaries.geojson" style="color: #4ecdc4;">Download GeoJSON</a></p>';
                });
        }

        // Initialize map when DOM is ready
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initHUC12Map);
        } else {
            initHUC12Map();
        }

        // ============================================
        // DISTRIBUTION HISTOGRAMS (Chart.js) with Date Range Filtering
        // ============================================

        // Histogram config with styling
        const histogramConfig = {
            histFecal: {
                jsonKey: 'fecal_coliform',
                threshold: 3,
                thresholdLabel: '200 CFU/100mL',
                color: 'rgba(255, 193, 7, 0.7)',
                borderColor: 'rgba(255, 193, 7, 1)'
            },
            histSC: {
                jsonKey: 'specific_conductance',
                threshold: 2,
                thresholdLabel: '300 µS/cm (EPA)',
                color: 'rgba(78, 205, 196, 0.7)',
                borderColor: 'rgba(78, 205, 196, 1)'
            },
            histFe: {
                jsonKey: 'iron',
                threshold: 4,
                thresholdLabel: '1.5 mg/L',
                color: 'rgba(255, 107, 107, 0.7)',
                borderColor: 'rgba(255, 107, 107, 1)'
            },
            histPH: {
                jsonKey: 'ph',
                threshold: null,
                thresholdLabel: '6.0-9.0 SU',
                color: 'rgba(156, 136, 255, 0.7)',
                borderColor: 'rgba(156, 136, 255, 1)'
            },
            histSO4: {
                jsonKey: 'sulfate',
                threshold: 4,
                thresholdLabel: '250 mg/L',
                color: 'rgba(78, 205, 196, 0.7)',
                borderColor: 'rgba(78, 205, 196, 1)'
            },
            histSe: {
                jsonKey: 'selenium',
                threshold: 2,
                thresholdLabel: '0.005 mg/L',
                color: 'rgba(244, 162, 97, 0.7)',
                borderColor: 'rgba(244, 162, 97, 1)'
            }
        };

        let yearlyHistogramData = null;
        let currentDateRange = { min: 1970, max: 2025 };
        const histogramCharts = {};

        // Load year-by-year histogram data
        async function loadHistogramData() {
            try {
                const response = await fetch('histogram_data_by_year.json');
                yearlyHistogramData = await response.json();
                initializeDateRangeSlider();
                initializeHistograms();
            } catch (error) {
                console.error('Error loading histogram data:', error);
                // Fallback to static data if JSON fails
                initializeHistogramsStatic();
            }
        }

        function getFilteredHistogramData(paramKey, minYear, maxYear) {
            if (!yearlyHistogramData || !yearlyHistogramData.parameters[paramKey]) {
                return null;
            }

            const param = yearlyHistogramData.parameters[paramKey];
            const byYear = param.by_year;
            const binCount = param.labels.length;
            const aggregated = new Array(binCount).fill(0);

            for (let year = minYear; year <= maxYear; year++) {
                const yearData = byYear[year.toString()];
                if (yearData) {
                    for (let i = 0; i < binCount; i++) {
                        aggregated[i] += yearData[i] || 0;
                    }
                }
            }

            return {
                labels: param.labels,
                data: aggregated,
                total: aggregated.reduce((a, b) => a + b, 0)
            };
        }

        function createHistogram(canvasId) {
            const ctx = document.getElementById(canvasId);
            const config = histogramConfig[canvasId];
            if (!ctx || !config) return;

            const paramData = getFilteredHistogramData(config.jsonKey, currentDateRange.min, currentDateRange.max);
            if (!paramData) return;

            histogramCharts[canvasId] = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: paramData.labels,
                    datasets: [{
                        label: 'Frequency',
                        data: paramData.data,
                        backgroundColor: config.color,
                        borderColor: config.borderColor,
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            backgroundColor: 'rgba(12, 24, 33, 0.95)',
                            titleColor: '#4ecdc4',
                            bodyColor: '#e8f1f5',
                            callbacks: {
                                title: (items) => `Range: ${items[0].label}`,
                                label: (item) => `Count: ${item.raw.toLocaleString()} samples`
                            }
                        },
                        annotation: config.threshold !== null ? {
                            annotations: {
                                threshold: {
                                    type: 'line',
                                    xMin: config.threshold + 0.5,
                                    xMax: config.threshold + 0.5,
                                    borderColor: '#e76f51',
                                    borderWidth: 2,
                                    borderDash: [5, 5],
                                    label: {
                                        display: true,
                                        content: config.thresholdLabel,
                                        position: 'start',
                                        backgroundColor: 'rgba(231, 111, 81, 0.8)',
                                        color: '#fff',
                                        font: { size: 10 }
                                    }
                                }
                            }
                        } : {}
                    },
                    scales: {
                        x: {
                            grid: { color: 'rgba(255,255,255,0.05)' },
                            ticks: { color: '#a3b8c7', font: { size: 10 } }
                        },
                        y: {
                            grid: { color: 'rgba(255,255,255,0.05)' },
                            ticks: { color: '#a3b8c7' },
                            beginAtZero: true
                        }
                    }
                }
            });

            // Update sample count display
            updateHistogramStats(canvasId, paramData.total);
        }

        function updateHistogramStats(canvasId, total) {
            const container = document.getElementById(canvasId)?.closest('.histogram-card');
            if (!container) return;
            const statsEl = container.querySelector('.param-stats span:first-child');
            if (statsEl) {
                statsEl.textContent = `n = ${total.toLocaleString()}`;
            }
        }

        function updateHistogramData() {
            Object.keys(histogramCharts).forEach(canvasId => {
                const chart = histogramCharts[canvasId];
                const config = histogramConfig[canvasId];
                if (!chart || !config) return;

                const paramData = getFilteredHistogramData(config.jsonKey, currentDateRange.min, currentDateRange.max);
                if (!paramData) return;

                chart.data.datasets[0].data = paramData.data;
                chart.update('active');
                updateHistogramStats(canvasId, paramData.total);
            });
        }

        function updateHistogram(canvasId, scale) {
            const chart = histogramCharts[canvasId];
            if (!chart) return;

            // Update button states
            const container = document.getElementById(canvasId).closest('.histogram-card');
            container.querySelectorAll('.histogram-btn').forEach(btn => {
                btn.classList.remove('active');
                if (btn.textContent.toLowerCase().includes(scale)) {
                    btn.classList.add('active');
                }
            });

            // Update scale
            chart.options.scales.y.type = scale === 'log' ? 'logarithmic' : 'linear';
            chart.options.scales.y.min = scale === 'log' ? 1 : 0;
            chart.update();
        }

        // Date Range Slider
        function initializeDateRangeSlider() {
            const minSlider = document.getElementById('dateRangeMin');
            const maxSlider = document.getElementById('dateRangeMax');
            const rangeDisplay = document.getElementById('dateRangeValue');
            const sliderRange = document.getElementById('sliderRange');
            const presetBtns = document.querySelectorAll('.preset-btn');

            if (!minSlider || !maxSlider) return;

            function updateSliderRange() {
                const min = parseInt(minSlider.value);
                const max = parseInt(maxSlider.value);
                const minPercent = ((min - 1970) / (2025 - 1970)) * 100;
                const maxPercent = ((max - 1970) / (2025 - 1970)) * 100;
                sliderRange.style.left = minPercent + '%';
                sliderRange.style.width = (maxPercent - minPercent) + '%';
                rangeDisplay.textContent = `${min} – ${max}`;
            }

            function handleSliderChange() {
                let min = parseInt(minSlider.value);
                let max = parseInt(maxSlider.value);

                // Ensure min doesn't exceed max
                if (min > max) {
                    if (this === minSlider) {
                        minSlider.value = max;
                        min = max;
                    } else {
                        maxSlider.value = min;
                        max = min;
                    }
                }

                currentDateRange.min = min;
                currentDateRange.max = max;
                updateSliderRange();
                updateHistogramData();

                // Update preset button states
                presetBtns.forEach(btn => {
                    const start = parseInt(btn.dataset.start);
                    const end = parseInt(btn.dataset.end);
                    btn.classList.toggle('active', start === min && end === max);
                });
            }

            minSlider.addEventListener('input', handleSliderChange);
            maxSlider.addEventListener('input', handleSliderChange);

            // Preset buttons
            presetBtns.forEach(btn => {
                btn.addEventListener('click', () => {
                    const start = parseInt(btn.dataset.start);
                    const end = parseInt(btn.dataset.end);
                    minSlider.value = start;
                    maxSlider.value = end;
                    currentDateRange.min = start;
                    currentDateRange.max = end;
                    updateSliderRange();
                    updateHistogramData();

                    presetBtns.forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                });
            });

            // Initialize
            updateSliderRange();
            presetBtns[0]?.classList.add('active');
        }

        function initializeHistograms() {
            Object.keys(histogramConfig).forEach(id => {
                if (!histogramCharts[id]) {
                    createHistogram(id);
                }
            });
        }

        // Fallback static data if JSON loading fails
        function initializeHistogramsStatic() {
            const staticData = {
                histFecal: { labels: ['0-50', '50-100', '100-200', '200-400', '400-800', '800-1600', '1600-3200', '>3200'], data: [892, 645, 812, 629, 587, 412, 298, 559] },
                histSC: { labels: ['0-100', '100-200', '200-300', '300-400', '400-600', '600-800', '800-1200', '>1200'], data: [423, 1089, 2058, 1456, 987, 512, 387, 252] },
                histFe: { labels: ['0-0.1', '0.1-0.3', '0.3-0.5', '0.5-1.0', '1.0-1.5', '1.5-2.5', '2.5-5', '>5'], data: [1245, 1567, 892, 534, 245, 112, 67, 28] },
                histPH: { labels: ['<5.5', '5.5-6.0', '6.0-6.5', '6.5-7.0', '7.0-7.5', '7.5-8.0', '8.0-8.5', '>8.5'], data: [23, 42, 287, 1245, 2134, 1876, 687, 97] },
                histSO4: { labels: ['0-50', '50-100', '100-150', '150-200', '200-250', '250-400', '400-600', '>600'], data: [723, 567, 412, 334, 234, 156, 87, 40] },
                histSe: { labels: ['ND', '0-0.002', '0.002-0.005', '0.005-0.01', '0.01-0.02', '0.02-0.05', '0.05-0.1', '>0.1'], data: [845, 534, 387, 198, 134, 78, 23, 11] }
            };
            // Create charts with static data (original implementation)
            Object.keys(staticData).forEach(id => {
                const ctx = document.getElementById(id);
                const config = histogramConfig[id];
                if (!ctx || !config) return;
                const sd = staticData[id];
                histogramCharts[id] = new Chart(ctx, {
                    type: 'bar',
                    data: { labels: sd.labels, datasets: [{ label: 'Frequency', data: sd.data, backgroundColor: config.color, borderColor: config.borderColor, borderWidth: 1 }] },
                    options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { x: { grid: { color: 'rgba(255,255,255,0.05)' }, ticks: { color: '#a3b8c7' } }, y: { grid: { color: 'rgba(255,255,255,0.05)' }, ticks: { color: '#a3b8c7' }, beginAtZero: true } } }
                });
            });
        }

        // Initialize histograms when section becomes visible
        const histogramObserver = new IntersectionObserver((entries) => {
            entries.forEach(entry => {
                if (entry.isIntersecting) {
                    loadHistogramData();
                    histogramObserver.disconnect();
                }
            });
        }, { threshold: 0.1 });

        const histogramSection = document.getElementById('histograms');
        if (histogramSection) {
            histogramObserver.observe(histogramSection);
        }

        // ============================================
        // CROSSTAB ANALYSIS
        // ============================================
        let crosstabData = null;
        let crosstabChart = null;

        const crosstabInterpretations = {
            'sc_vs_sulfate': {
                title: 'Mining Signature',
                text: 'Strong positive correlation between conductivity and sulfate is a classic indicator of acid mine drainage. Sulfate dissolves from exposed coal seams and enters waterways, raising both ionic content and conductivity.'
            },
            'sc_vs_iron': {
                title: 'AMD Indicator',
                text: 'When iron concentrations rise alongside conductivity, it typically indicates oxidation of pyrite (iron sulfide) in coal seams—a hallmark of acid mine drainage that impairs aquatic life.'
            },
            'ph_vs_iron': {
                title: 'Acidity-Metal Relationship',
                text: 'Lower pH values correlate with higher iron concentrations because acidic conditions increase iron solubility. This AMD-driven pattern damages aquatic ecosystems.'
            },
            'ph_vs_aluminum': {
                title: 'Acidity-Aluminum Link',
                text: 'Aluminum becomes highly soluble below pH 5.5, making this relationship critical for understanding aluminum toxicity to fish and invertebrates in AMD-impacted streams.'
            },
            'sulfate_vs_selenium': {
                title: 'Mining Impact Signature',
                text: 'Selenium, released from coal mining operations, often correlates with sulfate levels. Both pollutants originate from disturbed geological formations.'
            },
            'fecal_vs_do': {
                title: 'Organic Pollution Pattern',
                text: 'High fecal coliform often correlates with low dissolved oxygen as bacterial decomposition consumes O₂. This pattern indicates sewage or agricultural runoff impacts.'
            }
        };

        async function loadCrosstabData() {
            try {
                const response = await fetch('crosstab_data.json');
                crosstabData = await response.json();
                initializeCrosstab();
            } catch (error) {
                console.error('Failed to load crosstab data:', error);
                document.getElementById('crosstabStats').innerHTML = '<p style="color: var(--warning);">Data loading failed</p>';
            }
        }

        function initializeCrosstab() {
            const select = document.getElementById('crosstabPair');
            if (!select || !crosstabData) return;

            // Initial render
            updateCrosstabChart(select.value);

            // Listen for changes
            select.addEventListener('change', (e) => {
                updateCrosstabChart(e.target.value);
            });
        }

        function updateCrosstabChart(pairKey) {
            if (!crosstabData || !crosstabData.pairs[pairKey]) return;

            const pair = crosstabData.pairs[pairKey];

            // Update stats
            document.getElementById('crosstabCorr').textContent =
                pair.correlation !== null ? pair.correlation.toFixed(3) : 'N/A';
            document.getElementById('crosstabN').textContent =
                pair.n.toLocaleString();

            // Update interpretation
            const interp = crosstabInterpretations[pairKey];
            if (interp) {
                document.getElementById('crosstabInterpretation').innerHTML = `
                    <h4>${interp.title}</h4>
                    <p>${interp.text}</p>
                `;
            }

            // Prepare scatter data with HUC12 coloring
            const huc12Colors = {};
            const colorPalette = [
                'rgba(78, 205, 196, 0.6)',   // cyan
                'rgba(255, 107, 107, 0.6)',  // red
                'rgba(255, 230, 109, 0.6)',  // yellow
                'rgba(136, 176, 75, 0.6)',   // green
                'rgba(178, 102, 255, 0.6)',  // purple
                'rgba(255, 159, 64, 0.6)',   // orange
                'rgba(75, 192, 192, 0.6)',   // teal
                'rgba(255, 99, 132, 0.6)'    // pink
            ];

            // Assign colors to HUC12s
            const uniqueHuc12s = [...new Set(pair.huc12)];
            uniqueHuc12s.forEach((huc, i) => {
                huc12Colors[huc] = colorPalette[i % colorPalette.length];
            });

            const scatterData = pair.x.map((x, i) => ({
                x: x,
                y: pair.y[i],
                huc12: pair.huc12[i]
            })).filter(d => d.x !== null && d.y !== null);

            const pointColors = scatterData.map(d => huc12Colors[d.huc12]);

            // Destroy existing chart
            if (crosstabChart) {
                crosstabChart.destroy();
            }

            // Create scatter plot
            const ctx = document.getElementById('crosstabChart');
            crosstabChart = new Chart(ctx, {
                type: 'scatter',
                data: {
                    datasets: [{
                        label: `${pair.x_param} vs ${pair.y_param}`,
                        data: scatterData,
                        backgroundColor: pointColors,
                        borderColor: pointColors.map(c => c.replace('0.6', '1')),
                        borderWidth: 1,
                        pointRadius: 4,
                        pointHoverRadius: 6
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const point = context.raw;
                                    return [
                                        `${pair.x_param}: ${point.x}`,
                                        `${pair.y_param}: ${point.y}`,
                                        `Watershed: ${point.huc12}`
                                    ];
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            title: {
                                display: true,
                                text: pair.x_param,
                                color: '#4ecdc4',
                                font: { size: 12 }
                            },
                            grid: {
                                color: 'rgba(255,255,255,0.05)'
                            },
                            ticks: {
                                color: '#a3b8c7'
                            }
                        },
                        y: {
                            title: {
                                display: true,
                                text: pair.y_param,
                                color: '#4ecdc4',
                                font: { size: 12 }
                            },
                            grid: {
                                color: 'rgba(255,255,255,0.05)'
                            },
                            ticks: {
                                color: '#a3b8c7'
                            }
                        }
                    }
                }
            });
        }

        // Initialize crosstab when section becomes visible
        const crosstabObserver = new IntersectionObserver((entries) => {
            entries.forEach(entry => {
                if (entry.isIntersecting) {
                    loadCrosstabData();
                    crosstabObserver.disconnect();
                }
            });
        }, { threshold: 0.1 });

        const crosstabSection = document.getElementById('crosstab');
        if (crosstabSection) {
            crosstabObserver.observe(crosstabSection);
        }

        // ============================================
        // PARAMETER MAP
        // ============================================
        let paramMapData = null;
        let paramMap = null;
        let paramMapMarkers = [];

        async function loadParamMapData() {
            try {
                const response = await fetch('station_map_data.json');
                paramMapData = await response.json();
                initializeParamMap();
            } catch (error) {
                console.error('Failed to load parameter map data:', error);
            }
        }

        function initializeParamMap() {
            const container = document.getElementById('paramMapContainer');
            if (!container || !paramMapData) return;

            // Create map div if not exists
            let mapDiv = document.getElementById('paramMapLeaflet');
            if (!mapDiv) {
                mapDiv = document.createElement('div');
                mapDiv.id = 'paramMapLeaflet';
                container.insertBefore(mapDiv, container.firstChild);
            }

            // Initialize Leaflet map
            paramMap = L.map('paramMapLeaflet', {
                zoomControl: true
            }).setView([38.15, -82.0], 10);

            // Add dark basemap
            L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
                attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OSM</a> &copy; <a href="https://carto.com/attributions">CARTO</a>',
                maxZoom: 19
            }).addTo(paramMap);

            // Setup select listener
            const select = document.getElementById('paramMapSelect');
            if (select) {
                select.addEventListener('change', (e) => {
                    updateParamMap(e.target.value);
                });

                // Initial render
                updateParamMap(select.value);
            }
        }

        function getViolationColor(rate) {
            if (rate > 50) return '#ff4444';      // Critical - red
            if (rate > 25) return '#ff8c00';      // High - orange
            if (rate > 10) return '#ffd700';      // Moderate - yellow
            if (rate > 0) return '#90ee90';       // Low - light green
            return '#4ecdc4';                      // Clean - cyan
        }

        function updateParamMap(paramKey) {
            if (!paramMap || !paramMapData || !paramMapData.parameters[paramKey]) return;

            const paramInfo = paramMapData.parameters[paramKey];

            // Update stats
            document.getElementById('paramMapStations').textContent = paramInfo.total_stations.toLocaleString();
            document.getElementById('paramMapViolating').textContent = paramInfo.violating_stations.toLocaleString();

            // Clear existing markers
            paramMapMarkers.forEach(marker => marker.remove());
            paramMapMarkers = [];

            // Add new markers
            paramInfo.stations.forEach(station => {
                const color = getViolationColor(station.rate);

                const marker = L.circleMarker([station.lat, station.lon], {
                    radius: 6,
                    fillColor: color,
                    color: color,
                    weight: 1,
                    opacity: 0.9,
                    fillOpacity: 0.7
                });

                // Popup content
                const popupContent = `
                    <div style="font-family: system-ui; font-size: 13px;">
                        <strong style="color: #4ecdc4;">${station.name}</strong><br>
                        <span style="color: #888;">Station #${station.id}</span><br>
                        <hr style="border: none; border-top: 1px solid #444; margin: 6px 0;">
                        <strong>${paramInfo.name}</strong><br>
                        Mean: ${station.mean} ${paramInfo.unit}<br>
                        Max: ${station.max} ${paramInfo.unit}<br>
                        Samples: ${station.n}<br>
                        <span style="color: ${color}; font-weight: bold;">
                            Violations: ${station.violations} (${station.rate}%)
                        </span><br>
                        <span style="color: #666; font-size: 11px;">${station.huc12}</span>
                    </div>
                `;

                marker.bindPopup(popupContent);
                marker.addTo(paramMap);
                paramMapMarkers.push(marker);
            });
        }

        // Initialize parameter map when section becomes visible
        const paramMapObserver = new IntersectionObserver((entries) => {
            entries.forEach(entry => {
                if (entry.isIntersecting) {
                    loadParamMapData();
                    paramMapObserver.disconnect();
                }
            });
        }, { threshold: 0.1 });

        const paramMapSection = document.getElementById('parameterMap');
        if (paramMapSection) {
            paramMapObserver.observe(paramMapSection);
        }

        // ============================================
        // EXPORT FUNCTIONALITY
        // ============================================

        // Show export panel after scrolling past hero
        const exportPanel = document.getElementById('exportPanel');
        const exportObserver = new IntersectionObserver((entries) => {
            entries.forEach(entry => {
                if (!entry.isIntersecting) {
                    exportPanel.classList.add('visible');
                } else {
                    exportPanel.classList.remove('visible');
                }
            });
        }, { threshold: 0.5 });

        const heroSection = document.getElementById('hero');
        if (heroSection && exportPanel) {
            exportObserver.observe(heroSection);
        }

        function showExportToast(message) {
            const toast = document.getElementById('exportToast');
            toast.textContent = message;
            toast.classList.add('show');
            setTimeout(() => toast.classList.remove('show'), 3000);
        }

        function exportCSV() {
            // Generate CSV from the water quality data
            const csvData = [
                ['Parameter', 'Total Samples', 'Violation Rate', 'Standard', 'Status'],
                ['Hot Acidity', '2449', '100.0%', '0 mg/L CaCO3', 'Critical'],
                ['Specific Conductance', '7164', '46.0%', '300 µS/cm (EPA)', 'Impaired'],
                ['Fecal Coliform (MF)', '4834', '38.4%', '400 CFU/100 mL', 'Impaired'],
                ['Sulfate (SO4)', '2553', '18.4%', '250 mg/L', 'Impaired'],
                ['Se Total', '2210', '15.1%', '0.005 mg/L', 'Impaired'],
                ['Fe Total', '4690', '8.7%', '1.5 mg/L', 'Watch'],
                ['DO', '6160', '3.7%', '5.0 mg/L', 'Meeting'],
                ['Mn Total', '1615', '1.3%', '1.0 mg/L', 'Meeting'],
                ['pH', '6391', '1.0%', '6.0-9.0 SU', 'Meeting'],
                ['Al Dissolved', '2070', '0.5%', '0.75 mg/L', 'Meeting'],
                [''],
                ['HUC12 Hotspot Rankings'],
                ['Rank', 'Name', 'Impairment Score', 'Total Samples', 'FC Exceed %'],
                ['1', 'Davis Creek-Guyandotte River', '1020', '17338', '67.8%'],
                ['2', 'Ballard Fork-Mud River', '912', '12821', '11.5%'],
                ['3', 'Crawley Creek-Guyandotte River', '759', '15014', '47.3%'],
                ['4', 'Big Harts Creek', '365', '4908', '54.8%'],
                ['5', 'Big Creek-Mud River', '346', '4380', '30.2%'],
                ['6', 'Merrick Creek-Mud River', '283', '4657', '60.6%'],
                ['7', 'Fourteenmile Creek-Guyandotte River', '260', '3683', '41.0%'],
                ['8', 'Big Creek', '240', '4060', '42.2%'],
                ['9', 'Smith Creek-Guyandotte River', '213', '2750', '40.6%'],
                ['10', 'Middle Fork Mud River', '203', '2270', '40.8%'],
                [''],
                ['Trend Analysis'],
                ['Parameter', 'Total Change', 'Direction', 'Significant', 'Early Period', 'Late Period'],
                ['Al Total', '-89.7%', 'Decreasing', 'Yes', '0.94 mg/L', '0.11 mg/L'],
                ['Mn Total', '-67.7%', 'Decreasing', 'Yes', '0.15 mg/L', '0.05 mg/L'],
                ['Fe Total', '-25.0%', 'Decreasing', 'Yes', '0.97 mg/L', '0.25 mg/L'],
                ['Fecal Coliform', '-3.2%', 'Decreasing', 'Yes', '1133 CFU', '239 CFU'],
                ['pH', '+4.6%', 'Increasing', 'Yes', '7.1 SU', '7.7 SU'],
                ['Se Total', '+30.0%', 'Increasing', 'Yes', '0.0013 mg/L', '0.001 mg/L'],
                ['Specific Conductance', '+37.9%', 'Increasing', 'No', '307 µS/cm', '326 µS/cm']
            ];

            const csvContent = csvData.map(row => row.join(',')).join('\n');
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = 'lower_guyandotte_wq_summary.csv';
            link.click();
            URL.revokeObjectURL(link.href);

            showExportToast('CSV downloaded successfully!');
        }

        async function exportPDF() {
            showExportToast('Generating PDF report...');

            try {
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF('p', 'mm', 'a4');

                // Title
                doc.setFontSize(20);
                doc.setTextColor(78, 205, 196);
                doc.text('Lower Guyandotte Watershed', 20, 25);
                doc.setFontSize(14);
                doc.setTextColor(100);
                doc.text('Water Quality Analysis Summary', 20, 33);

                // Date
                doc.setFontSize(10);
                doc.setTextColor(150);
                doc.text(`Generated: ${new Date().toLocaleDateString()}`, 20, 40);

                // Key Statistics
                doc.setFontSize(12);
                doc.setTextColor(78, 205, 196);
                doc.text('Key Findings', 20, 55);

                doc.setFontSize(10);
                doc.setTextColor(60);
                const stats = [
                    '• 59,384 water quality samples analyzed (1970-2024)',
                    '• 489 monitoring stations across 21 HUC12 subwatersheds',
                    '• 80% of assessment units currently impaired',
                    '• Top pollutants: Hot Acidity (100%), SC (46%), Fecal Coliform (38.4%)',
                    '• Significant metals improvement: Aluminum down 89.7%, Iron down 25%',
                    '• Emerging concern: Selenium violations at 15.1%'
                ];

                let y = 63;
                stats.forEach(stat => {
                    doc.text(stat, 25, y);
                    y += 7;
                });

                // Top Hotspots
                doc.setFontSize(12);
                doc.setTextColor(78, 205, 196);
                doc.text('Priority Subwatersheds (Top 5)', 20, y + 10);

                doc.setFontSize(9);
                doc.setTextColor(60);
                y += 18;
                const hotspots = [
                    ['1. Davis Creek-Guyandotte River', 'Score: 1,020', 'FC: 67.8%'],
                    ['2. Ballard Fork-Mud River', 'Score: 912', 'FC: 11.5%'],
                    ['3. Crawley Creek-Guyandotte River', 'Score: 759', 'FC: 47.3%'],
                    ['4. Big Harts Creek', 'Score: 365', 'FC: 54.8%'],
                    ['5. Big Creek-Mud River', 'Score: 346', 'FC: 30.2%']
                ];

                hotspots.forEach(row => {
                    doc.text(row[0], 25, y);
                    doc.text(row[1], 100, y);
                    doc.text(row[2], 140, y);
                    y += 6;
                });

                // Court Order Streams
                doc.setFontSize(12);
                doc.setTextColor(78, 205, 196);
                doc.text('Court Order Streams (11 Total)', 20, y + 10);

                doc.setFontSize(9);
                doc.setTextColor(60);
                y += 18;
                const courtStreams = [
                    'Spruce Fork, Mud River, Trace Fork, Big Ugly Creek, Laurel Fork,',
                    'Ben Creek, Harts Creek, Buffalo Creek, Guyandotte River (main)',
                ];

                courtStreams.forEach(line => {
                    doc.text(line, 25, y);
                    y += 5;
                });

                // Footer
                doc.setFontSize(8);
                doc.setTextColor(150);
                doc.text('Data source: WV DEP Water Quality Assessment Database', 20, 280);
                doc.text('Analysis: Lower Guyandotte WQ Analysis Platform | wvrivers.org', 20, 285);

                doc.save('lower_guyandotte_wq_report.pdf');
                showExportToast('PDF report downloaded!');
            } catch (error) {
                console.error('PDF generation error:', error);
                showExportToast('PDF generation failed. Try CSV instead.');
            }
        }

        // ============================================
        // MOBILE TOUCH INTERACTIONS
        // ============================================

        // Touch feedback for interactive elements
        const touchTargets = document.querySelectorAll('.plot-card, .stat-card, .hotspot-item, .court-stream-item, .param-guide-card');
        touchTargets.forEach(el => {
            el.addEventListener('touchstart', () => el.classList.add('touch-active'), { passive: true });
            el.addEventListener('touchend', () => el.classList.remove('touch-active'), { passive: true });
            el.addEventListener('touchcancel', () => el.classList.remove('touch-active'), { passive: true });
        });

        // Swipe detection for plot gallery (mobile only)
        if ('ontouchstart' in window) {
            const plotGrid = document.querySelector('.plot-grid');
            if (plotGrid) {
                let startX, startY, distX, distY;

                plotGrid.addEventListener('touchstart', (e) => {
                    startX = e.touches[0].pageX;
                    startY = e.touches[0].pageY;
                }, { passive: true });

                plotGrid.addEventListener('touchmove', (e) => {
                    if (!startX || !startY) return;
                    distX = e.touches[0].pageX - startX;
                    distY = e.touches[0].pageY - startY;
                }, { passive: true });

                plotGrid.addEventListener('touchend', () => {
                    startX = startY = distX = distY = null;
                }, { passive: true });
            }
        }

        // ============================================
        // WATERSHED BOUNDARY OVERLAY ENHANCEMENT
        // ============================================

        // This adds layer controls to the existing HUC12 map
        function addWatershedBoundaryControls(map, geoJsonLayer) {
            let flowlinesLayer = null;
            let flowlinesLoaded = false;

            // Create custom control
            const LayerControl = L.Control.extend({
                options: { position: 'topright' },
                onAdd: function() {
                    const container = L.DomUtil.create('div', 'map-layer-toggle');
                    container.innerHTML = `
                        <label class="layer-toggle-btn">
                            <input type="checkbox" id="toggleBoundaries" checked>
                            HUC12 Boundaries
                        </label>
                        <label class="layer-toggle-btn">
                            <input type="checkbox" id="toggleFlowlines">
                            Stream Flowlines
                        </label>
                        <label class="layer-toggle-btn">
                            <input type="checkbox" id="toggleSatellite">
                            Satellite Base
                        </label>
                    `;

                    // Prevent map interactions when clicking control
                    L.DomEvent.disableClickPropagation(container);

                    return container;
                }
            });

            map.addControl(new LayerControl());

            // Layer toggles
            const baseLayers = {
                dark: L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
                    attribution: '&copy; OSM &copy; CARTO',
                    subdomains: 'abcd',
                    maxZoom: 19
                }),
                satellite: L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
                    attribution: '&copy; Esri',
                    maxZoom: 19
                })
            };

            // Handle boundary toggle
            document.getElementById('toggleBoundaries')?.addEventListener('change', (e) => {
                if (e.target.checked) {
                    geoJsonLayer.addTo(map);
                } else {
                    map.removeLayer(geoJsonLayer);
                }
            });

            // Handle flowlines toggle - lazy load
            document.getElementById('toggleFlowlines')?.addEventListener('change', (e) => {
                if (e.target.checked) {
                    if (!flowlinesLoaded) {
                        // Show loading state
                        e.target.parentElement.classList.add('loading');

                        fetch('nhd_flowlines_simplified.geojson')
                            .then(response => response.json())
                            .then(data => {
                                flowlinesLayer = L.geoJSON(data, {
                                    style: function(feature) {
                                        const name = feature.properties.gnis_name;
                                        const fcode = feature.properties.fcode;
                                        // Style based on stream type
                                        let weight = 1;
                                        let color = '#4ecdc4';
                                        let opacity = 0.6;

                                        // Perennial streams (46006) - more prominent
                                        if (fcode === 46006) {
                                            weight = 2;
                                            color = '#00bcd4';
                                            opacity = 0.8;
                                        }
                                        // Named streams - highlight
                                        if (name && name.length > 0) {
                                            weight = Math.min(weight + 1, 3);
                                            color = '#4ecdc4';
                                            opacity = 0.9;
                                        }

                                        return {
                                            color: color,
                                            weight: weight,
                                            opacity: opacity
                                        };
                                    },
                                    onEachFeature: function(feature, layer) {
                                        const name = feature.properties.gnis_name;
                                        if (name && name.length > 0) {
                                            layer.bindPopup(`<div class="popup-title">${name}</div>`);
                                        }
                                    }
                                }).addTo(map);

                                // Bring boundaries to front so they're clickable
                                if (geoJsonLayer) {
                                    geoJsonLayer.bringToFront();
                                }

                                flowlinesLoaded = true;
                                e.target.parentElement.classList.remove('loading');
                            })
                            .catch(error => {
                                console.error('Error loading flowlines:', error);
                                e.target.checked = false;
                                e.target.parentElement.classList.remove('loading');
                            });
                    } else if (flowlinesLayer) {
                        flowlinesLayer.addTo(map);
                        if (geoJsonLayer) geoJsonLayer.bringToFront();
                    }
                } else if (flowlinesLayer) {
                    map.removeLayer(flowlinesLayer);
                }
            });

            // Handle satellite toggle
            let currentBase = 'dark';
            document.getElementById('toggleSatellite')?.addEventListener('change', (e) => {
                if (e.target.checked) {
                    map.removeLayer(baseLayers.dark);
                    baseLayers.satellite.addTo(map);
                    currentBase = 'satellite';
                } else {
                    map.removeLayer(baseLayers.satellite);
                    baseLayers.dark.addTo(map);
                    currentBase = 'dark';
                }
            });
        }

        // ============================================
        // SELENIUM TREND CHART
        // ============================================
        function initSeleniumTrendChart() {
            const ctx = document.getElementById('seleniumTrendChart');
            if (!ctx) return;

            // Actual annual selenium data from analysis (1977-2025)
            // Note: 100% of samples are non-detects; values shown are DL/2 substitutions
            const seleniumData = {
                years: [1977, 1981, 1983, 2002, 2004, 2005, 2006, 2007, 2008, 2009, 2010, 2011, 2012, 2013, 2014, 2015, 2016, 2017, 2018, 2019, 2020, 2021, 2022, 2023, 2024, 2025],
                medians: [0.0005, 0.0005, 0.0005, 0.0025, 0.0005, 0.0005, 0.0005, 0.0005, 0.0005, 0.0005, 0.0005, 0.0005, 0.0005, 0.0005, 0.0005, 0.0005, 0.0005, 0.0005, 0.0005, 0.0005, 0.000255, 0.00042, 0.00042, 0.00042, 0.00045, 0.00065],
                counts: [3, 4, 4, 7, 12, 21, 64, 26, 37, 22, 18, 20, 17, 144, 19, 18, 30, 597, 701, 97, 207, 45, 36, 23, 19, 22]
            };

            new Chart(ctx, {
                type: 'line',
                data: {
                    labels: seleniumData.years,
                    datasets: [
                        {
                            label: 'Annual Median (DL/2)',
                            data: seleniumData.medians,
                            borderColor: '#e76f51',
                            backgroundColor: 'rgba(231, 111, 81, 0.15)',
                            borderWidth: 2,
                            fill: true,
                            tension: 0.1,
                            pointBackgroundColor: seleniumData.counts.map(c => c > 50 ? '#e76f51' : 'rgba(231, 111, 81, 0.5)'),
                            pointBorderColor: '#fff',
                            pointRadius: seleniumData.counts.map(c => c > 50 ? 4 : 2),
                            pointHoverRadius: 6
                        },
                        {
                            label: 'WV Standard (0.005 mg/L)',
                            data: seleniumData.years.map(() => 0.005),
                            borderColor: '#4ecdc4',
                            borderWidth: 2,
                            borderDash: [5, 5],
                            fill: false,
                            pointRadius: 0
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: true,
                            position: 'bottom',
                            labels: {
                                color: '#a3b8c7',
                                font: { size: 9 },
                                boxWidth: 10
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    if (context.datasetIndex === 0) {
                                        const idx = context.dataIndex;
                                        const count = seleniumData.counts[idx];
                                        return [
                                            'Median: ' + context.parsed.y.toFixed(5) + ' mg/L',
                                            'Samples: ' + count,
                                            '100% non-detect'
                                        ];
                                    }
                                    return context.dataset.label;
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            grid: { color: 'rgba(255,255,255,0.05)' },
                            ticks: {
                                color: '#a3b8c7',
                                font: { size: 9 },
                                maxTicksLimit: 10
                            },
                            title: {
                                display: true,
                                text: 'Year',
                                color: '#a3b8c7',
                                font: { size: 9 }
                            }
                        },
                        y: {
                            grid: { color: 'rgba(255,255,255,0.1)' },
                            ticks: {
                                color: '#a3b8c7',
                                font: { size: 9 },
                                callback: function(value) {
                                    return value.toFixed(4);
                                }
                            },
                            min: 0,
                            max: 0.006,
                            title: {
                                display: true,
                                text: 'mg/L',
                                color: '#a3b8c7',
                                font: { size: 9 }
                            }
                        }
                    }
                }
            });
        }

        // Initialize selenium chart when section is visible
        const seleniumChartObserver = new IntersectionObserver((entries) => {
            entries.forEach(entry => {
                if (entry.isIntersecting) {
                    initSeleniumTrendChart();
                    seleniumChartObserver.disconnect();
                }
            });
        }, { threshold: 0.1 });

        const seleniumSection = document.querySelector('.selenium-trend-container');
        if (seleniumSection) {
            seleniumChartObserver.observe(seleniumSection);
        }
    </script>
</body>
</html>
